# Story 1.9: Warehouse & Inventory Management

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** logistics operator,
**I want** to manage warehouses and inventory records per product and warehouse,
**so that** the planning engine has accurate stock data for MRP calculations.

## Acceptance Criteria

1. `POST /api/v1/depositos` creates a warehouse with code, name, type, capacities
2. `GET /api/v1/depositos` lists warehouses with filters (tipo, ativo) and pagination
3. `GET /api/v1/depositos/:id` returns a single warehouse with inventory summary
4. `PATCH /api/v1/depositos/:id` updates warehouse fields
5. `DELETE /api/v1/depositos/:id` soft-deletes a warehouse (sets ativo=false)
6. `POST /api/v1/inventario` creates an inventory record linked to product + warehouse
7. `GET /api/v1/inventario` lists inventory with filters (produtoId, depositoId, fonteAtualizacao) and pagination
8. `GET /api/v1/inventario/:id` returns a single inventory record with product and warehouse
9. `PATCH /api/v1/inventario/:id` updates inventory quantities, cost, and tracks fonteAtualizacao
10. Inventory response includes computed quantidadeTotal and valorTotalEstoque
11. Module requires operator role for write, viewer for read
12. All services covered by unit tests >= 80%

## Tasks / Subtasks

- [x] **Task 1: Create Deposito DTOs, Repository, Service, Controller**
- [x] **Task 2: Create InventarioAtual DTOs, Repository, Service, Controller**
- [x] **Task 3: Register InventarioModule in AppModule**
- [x] **Task 4: Write Unit Tests**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- No errors encountered — clean implementation (import path fix: `generated/prisma` → `generated/prisma/client`)

### Completion Notes List
- 26 new tests (8 deposito service, 6 deposito controller, 7 inventario service, 5 inventario controller)
- 253/253 total tests passing across 38 suites
- Build clean, no TypeScript errors
- Deposito: Full CRUD with soft delete, search by codigo/nome, filter by tipo/ativo
- InventarioAtual: CRUD with computed fields (quantidadeTotal, valorTotalEstoque)
- ConflictException for unique constraint (produtoId + depositoId + lote)
- Inventory responses enriched with quantidadeTotal = disponivel + reservada + quarentena
- valorTotalEstoque = quantidadeTotal * custoMedioUnitario (null if no cost)

### File List

**Created:**
- `apps/api/src/modules/inventario/depositos/dto/create-deposito.dto.ts`
- `apps/api/src/modules/inventario/depositos/dto/update-deposito.dto.ts`
- `apps/api/src/modules/inventario/depositos/dto/filter-deposito.dto.ts`
- `apps/api/src/modules/inventario/depositos/depositos.repository.ts`
- `apps/api/src/modules/inventario/depositos/depositos.service.ts`
- `apps/api/src/modules/inventario/depositos/depositos.service.spec.ts`
- `apps/api/src/modules/inventario/depositos/depositos.controller.ts`
- `apps/api/src/modules/inventario/depositos/depositos.controller.spec.ts`
- `apps/api/src/modules/inventario/inventario-atual/dto/create-inventario-atual.dto.ts`
- `apps/api/src/modules/inventario/inventario-atual/dto/update-inventario-atual.dto.ts`
- `apps/api/src/modules/inventario/inventario-atual/dto/filter-inventario-atual.dto.ts`
- `apps/api/src/modules/inventario/inventario-atual/inventario-atual.repository.ts`
- `apps/api/src/modules/inventario/inventario-atual/inventario-atual.service.ts`
- `apps/api/src/modules/inventario/inventario-atual/inventario-atual.service.spec.ts`
- `apps/api/src/modules/inventario/inventario-atual/inventario-atual.controller.ts`
- `apps/api/src/modules/inventario/inventario-atual/inventario-atual.controller.spec.ts`
- `apps/api/src/modules/inventario/inventario.module.ts`

**Modified:**
- `apps/api/src/app.module.ts` (added InventarioModule import)
