# Story 5.1: Wagner-Whitin Optimal Lot Sizing

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** the MRP engine to support the Wagner-Whitin dynamic programming algorithm for lot sizing,
**so that** I can achieve mathematically optimal order quantities that minimize total ordering + holding costs over the planning horizon.

## References

- FR-064: Wagner-Whitin Lot Sizing
- [Source: PRD §4.6 — Epic 5 Refinement & Production]
- [Story 3.5: Lot Sizing Engine — existing L4L/EOQ/Silver-Meal infrastructure]

## Acceptance Criteria

### Wagner-Whitin Algorithm (FR-064)
- [x] AC-1: Implement Wagner-Whitin dynamic programming algorithm in LotSizingService
- [x] AC-2: Algorithm minimizes total cost (ordering K + holding h) over the planning horizon
- [x] AC-3: DP recurrence: dp[j] = min over i<=j of { dp[i-1] + K + Σ h·demand[k]·(k-i) for k=i..j }
- [x] AC-4: Optimal property: orders only placed in periods where beginning inventory = 0
- [x] AC-5: Apply same constraint pipeline (loteMinimo → multiploCompra → MOQ) after DP solution
- [x] AC-6: Lead time offsetting works identically to other methods (receipts → releases → past-due)

### Integration with Existing Engine
- [x] AC-7: Add 'WAGNER_WHITIN' to LotSizingInput.method type union
- [x] AC-8: Route WAGNER_WHITIN in calculateReceipts switch — remove BadRequestException for this method
- [x] AC-9: Update error message in default case to list WAGNER_WHITIN as supported
- [x] AC-10: MRP Orchestrator (mrp.service.ts) correctly passes WAGNER_WHITIN method from product config

### Cost Comparison Endpoint
- [x] AC-11: `GET /mrp/lot-sizing/compare?produtoId=X` — returns cost comparison for all 4 methods
- [x] AC-12: Response includes: method, totalCost (ordering + holding), numberOfOrders, avgOrderQty for each
- [x] AC-13: Endpoint returns recommendation (lowest total cost method)

### Frontend
- [x] AC-14: Wagner-Whitin option available in lot sizing method selector (via Prisma enum WAGNER_WHITIN)
- [x] AC-15: Cost comparison card on MRP detail page showing all 4 methods side-by-side

### Testing
- [x] AC-16: Unit tests for Wagner-Whitin algorithm: basic, multi-period, zero-demand gaps, single-period
- [x] AC-17: Unit tests for constraint application on W-W results
- [x] AC-18: Unit tests for cost optimality guarantee (W-W cost ≤ Silver-Meal cost)
- [x] AC-19: Frontend render tests for cost comparison card

## Dev Notes

### Wagner-Whitin Algorithm (Dynamic Programming)

```typescript
// dp[j] = minimum total cost to satisfy demands in periods 0..j
// For each j, try all possible "last order" placements at period i:
//   dp[j] = min { dp[i-1] + K + Σ_{k=i}^{j} h * demand[k] * (k - i) }
// where dp[-1] = 0 (base case)

// Incremental holding cost update (O(m²) instead of O(m³)):
// When order point moves from i+1 to i, all demands in [i+1..j]
// are held for additional (originalIndex[i+1] - originalIndex[i]) periods.

// Backtrace: walk backtrack array from j=m-1 to reconstruct orders.
```

### Key Property
Wagner-Whitin produces the **globally optimal** solution, unlike Silver-Meal which is a heuristic.
The DP table size is O(m²) where m = number of periods with positive demand.

### Cost Parameters (same as Silver-Meal)
- `orderingCost` (K): Fixed cost per order placement
- `holdingCostPerUnit` (h): Per-unit per-period carrying cost = custoUnitario * custoManutencaoPctAno / 100 / 52

### Cost Comparison Endpoint
Uses ForecastResultado (p50 as gross demand) and InventarioAtual (on-hand inventory)
to reconstruct net requirements, then runs all 4 methods and compares costs.

---

## Tasks / Subtasks

- [x] **Task 1: Add WAGNER_WHITIN to interface and routing** (AC: 7, 8, 9)
- [x] **Task 2: Implement Wagner-Whitin DP algorithm** (AC: 1, 2, 3, 4, 5, 6)
- [x] **Task 3: Create cost comparison endpoint** (AC: 10, 11, 12, 13)
- [x] **Task 4: Create frontend cost comparison card** (AC: 14, 15)
- [x] **Task 5: Write backend unit tests** (AC: 16, 17, 18)
- [x] **Task 6: Write frontend render tests** (AC: 19)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/lot-sizing.interface.ts` | Modified | Add WAGNER_WHITIN to method union |
| `apps/api/src/modules/mrp/engine/lot-sizing.service.ts` | Modified | Add calculateWagnerWhitin DP + routing |
| `apps/api/src/modules/mrp/engine/lot-sizing.service.spec.ts` | Modified | 9 new Wagner-Whitin tests + updated unsupported method test |
| `apps/api/src/modules/mrp/mrp.service.ts` | Modified | Add compareLotSizing + calculateHoldingCost + update method cast |
| `apps/api/src/modules/mrp/mrp.controller.ts` | Modified | Add GET /mrp/lot-sizing/compare endpoint |
| `apps/api/src/modules/mrp/dto/lot-sizing-compare.dto.ts` | Created | LotSizingCompareDto with @IsUUID |
| `apps/web/src/hooks/use-lot-sizing-compare.ts` | Created | useLotSizingCompare React Query hook |
| `apps/web/src/components/mrp/lot-sizing-comparison.tsx` | Created | LotSizingComparison card component |
| `apps/web/src/components/mrp/__tests__/lot-sizing-comparison.test.tsx` | Created | 6 frontend render tests |
| `apps/web/src/app/mrp/detail/page.tsx` | Modified | Added LotSizingComparison to detail page |

---

## Dependencies

- Story 3.5: Lot Sizing Engine (existing infrastructure)
- Story 3.10: MRP Orchestrator (method routing from product config)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — Wagner-Whitin lot sizing | River (SM) |
| 2026-02-28 | 0.2 | Full implementation: Wagner-Whitin DP algorithm with O(m²) incremental holding cost, cost comparison endpoint (ForecastResultado + InventarioAtual), LotSizingComparison frontend card, 9 backend + 6 frontend tests (19/19 ACs) | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: fixed Prisma model names (execucaoPlanejamento, forecastResultado), status enum CONCLUIDO, orderBy completedAt, net requirement reconstruction from forecast+inventory, tightened textbook test assertions | Quinn (QA) |
