# Story 4.8: Executive BI Dashboard

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As an** executive / operations director,
**I want** an executive BI dashboard with KPIs, revenue trends, Pareto analysis, and active alerts,
**so that** I can monitor overall business health and supply chain performance at a glance.

## References

- FR-054: Executive Dashboard
- [Source: architecture/3-frontend-architecture.md#3.1 — dashboard/page.tsx]

## Acceptance Criteria

### KPI Cards (FR-054)
- [x] AC-1: Monthly Revenue KPI card with absolute value and % MoM (month-over-month) variation
- [x] AC-2: Forecast Accuracy KPI card with weighted MAPE and variation indicator
- [x] AC-3: Inventory Turnover KPI card with ratio value and variation
- [x] AC-4: Fill Rate / OTIF KPI card with percentage and variation

### Revenue Chart
- [x] AC-5: Main chart: Real Revenue vs Forecast (12 months past + 3 months projection)
- [x] AC-6: P10-P90 confidence bands on forecast projection
- [x] AC-7: Toggle between Indirect Forecast (Volume x Price) and Direct TFT Forecast lines
- [x] AC-8: When Indirect and Direct diverge significantly (>15%), show attention flag with tooltip explaining possible mix/price change

### Pareto / ABC Analysis
- [x] AC-9: Pareto chart showing revenue contribution by ABC class (A, B, C)
- [x] AC-10: Clickable bars that filter the dashboard to show only selected class

### Stock Coverage Heatmap
- [x] AC-11: Heatmap: rows = SKUs (top 50 by revenue), columns = coverage days
- [x] AC-12: Color coding: red < 7 days, orange 7-14 days, yellow 14-30 days, green > 30 days
- [x] AC-13: Clicking a cell navigates to the stock projection page for that SKU

### Active Alerts Section
- [x] AC-14: Summary panel showing: SKUs in stockout, SKUs near ROP, overloaded work centers, full warehouses
- [x] AC-15: Each alert category clickable — navigates to relevant detail page

### API Endpoints
- [x] AC-16: `GET /dashboard/kpis` — aggregated KPI data
- [x] AC-17: `GET /dashboard/revenue-chart` — 12mo actual + 3mo forecast with confidence bands
- [x] AC-18: `GET /dashboard/pareto` — ABC revenue distribution
- [x] AC-19: `GET /dashboard/stock-coverage` — coverage days per SKU

### General
- [x] AC-20: Dashboard at route `/dashboard` (main landing page after login)
- [x] AC-21: All charts use Apache ECharts (via ChartBase wrapper)
- [x] AC-22: Auto-refresh every 5 minutes (configurable)

### Testing
- [x] AC-23: Backend unit tests for KPI aggregation service (80%+ coverage)
- [x] AC-24: Frontend render tests for all dashboard components

## Dev Notes

### KPI Calculation

```typescript
// Monthly Revenue
monthlyRevenue = SUM(venda_real.valor WHERE month = current)
momVariation = (current - previous) / previous * 100

// Forecast Accuracy
weightedMAPE = SUM(mape_sku * revenue_weight_sku) / SUM(revenue_weight_sku)

// Inventory Turnover
turnover = COGS_annual / avg_inventory_value

// Fill Rate (OTIF)
otif = orders_delivered_complete_on_time / total_orders * 100
```

### File Locations

**Backend:**
- `apps/api/src/modules/dashboard/` — module, controller, service
- `apps/api/src/modules/dashboard/dashboard.service.ts` — KPI aggregation

**Frontend:**
- `apps/web/src/app/dashboard/page.tsx`
- `apps/web/src/app/dashboard/components/kpi-cards.tsx`
- `apps/web/src/app/dashboard/components/revenue-chart.tsx`
- `apps/web/src/app/dashboard/components/pareto-chart.tsx`
- `apps/web/src/app/dashboard/components/stock-coverage-heatmap.tsx`
- `apps/web/src/app/dashboard/components/active-alerts-panel.tsx`
- `apps/web/src/hooks/use-dashboard.ts` — React Query hooks

---

## Tasks / Subtasks

- [x] **Task 1: Create Dashboard backend module with KPI aggregation** (AC: 1-4, 16)
- [x] **Task 2: Implement revenue chart API endpoint** (AC: 5-8, 17)
- [x] **Task 3: Implement Pareto and stock coverage endpoints** (AC: 9-13, 18, 19)
- [x] **Task 4: Create KPI cards component** (AC: 1-4)
- [x] **Task 5: Create revenue chart with ECharts** (AC: 5-8, 21)
- [x] **Task 6: Create Pareto chart and stock coverage heatmap** (AC: 9-13)
- [x] **Task 7: Create active alerts panel** (AC: 14, 15)
- [x] **Task 8: Assemble dashboard page with auto-refresh** (AC: 20, 22)
- [x] **Task 9: Write backend unit tests** (AC: 23)
- [x] **Task 10: Write frontend render tests** (AC: 24)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/dashboard/dashboard.types.ts` | Created | TypeScript interfaces for KPIs, charts, heatmap, alerts |
| `apps/api/src/modules/dashboard/dashboard.service.ts` | Created | KPI aggregation, revenue chart, Pareto, stock coverage, alerts |
| `apps/api/src/modules/dashboard/dashboard.controller.ts` | Created | 4 GET endpoints: kpis, revenue-chart, pareto, stock-coverage |
| `apps/api/src/modules/dashboard/dashboard.module.ts` | Created | NestJS module registration |
| `apps/api/src/modules/dashboard/__tests__/dashboard.service.spec.ts` | Created | 13 tests: KPIs, revenue chart, Pareto, stock coverage, alerts |
| `apps/api/src/modules/dashboard/__tests__/dashboard.controller.spec.ts` | Created | 4 tests: controller endpoint delegation |
| `apps/api/src/app.module.ts` | Modified | Registered DashboardModule |
| `apps/web/src/types/dashboard.ts` | Created | Frontend types, color maps, variation icons |
| `apps/web/src/hooks/use-dashboard.ts` | Created | 5 React Query hooks with 5min auto-refresh |
| `apps/web/src/app/dashboard/page.tsx` | Created | Dashboard page with all sections + ABC class filter |
| `apps/web/src/app/dashboard/components/kpi-cards.tsx` | Created | 4 KPI cards with MoM variation |
| `apps/web/src/app/dashboard/components/revenue-chart.tsx` | Created | Revenue vs Forecast with P10-P90 bands + toggle |
| `apps/web/src/app/dashboard/components/pareto-chart.tsx` | Created | Pareto ABC bar + cumulative line chart |
| `apps/web/src/app/dashboard/components/stock-coverage-heatmap.tsx` | Created | Top 50 SKUs with color-coded coverage days |
| `apps/web/src/app/dashboard/components/active-alerts-panel.tsx` | Created | Alert categories with counts + navigation |
| `apps/web/src/app/dashboard/__tests__/dashboard-page.test.tsx` | Created | 7 tests: render all components, data display |

---

## Dependencies

- Story 4.4: Alert System (active alerts panel uses notification data)
- Story 4.6: Daily Pipeline (KPIs computed from pipeline data)
- Story 2.7: Backtesting (MAPE metrics for accuracy KPI)
- Story 3.12: MRP Dashboards (ChartBase wrapper pattern)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Full implementation: types, service (KPI/chart/Pareto/coverage/alerts), controller, module, 5 frontend components, hooks, page, 17 backend + 7 frontend tests (24/24 ACs) | Dex (Dev) |
| 2026-02-27 | 0.3 | Code review fixes: FINALIZADA→LIBERADA enum, query take limits (skuClassification, serieTemporal.groupBy, notificacao.groupBy), HTML escaping in tooltip, encodeURIComponent, error state in page | Dex (Dev) |
