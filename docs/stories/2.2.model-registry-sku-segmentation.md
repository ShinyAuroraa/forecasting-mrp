# Story 2.2: Model Registry & SKU Segmentation

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["pytest", "ruff", "mypy"]

## Story

**As a** demand planner,
**I want** the system to automatically select the optimal forecast model for each SKU based on its ABC/XYZ classification and demand pattern,
**so that** each product gets the most accurate forecasting approach without manual configuration.

## Acceptance Criteria

1. [x] Model registry maps (ClasseABC, PadraoDemanda) → (primary model, fallback model)
2. [x] SMOOTH (REGULAR) + A/B → TFT primary, LightGBM fallback
3. [x] SMOOTH (REGULAR) + C → ETS primary, Naive fallback
4. [x] ERRATIC + A/B → TFT primary, ETS fallback
5. [x] ERRATIC + C → ETS primary, Naive fallback
6. [x] INTERMITTENT + any → Croston primary, SBA fallback
7. [x] LUMPY + any → TSB primary, Bootstrap fallback
8. [x] Insufficient data (<40 weeks) → Simple ETS primary, Naive fallback
9. [x] Class A SKUs additionally get Ensemble (TFT 0.6 + LGBM 0.4)
10. [x] Abstract base model interface defines train/predict/backtest contract
11. [x] SKU segmentation service groups products by assigned model reading from sku_classification
12. [x] User override via modelo_forecast_sugerido field is respected (overrides matrix)
13. [x] Unit tests >= 80% coverage

## Tasks / Subtasks

- [x] **Task 1: Create abstract base model interface**
  - [x] `models/base.py` — AbstractForecastModel with train, predict, backtest signatures
- [x] **Task 2: Create model registry**
  - [x] `models/registry.py` — ModelRegistry mapping classification → model selection
  - [x] Include primary + fallback + ensemble logic
- [x] **Task 3: Create SKU segmentation service**
  - [x] `pipeline/segmentation.py` — SkuSegmenter groups products by model
  - [x] Reads from ClassificationRepository
  - [x] Respects user overrides from modelo_forecast_sugerido
  - [x] Handles insufficient data (<40 weeks) fallback
- [x] **Task 4: Write unit tests**
  - [x] Test registry returns correct model for each classification
  - [x] Test segmentation groups products correctly
  - [x] Test user override logic
  - [x] Test insufficient data fallback

## File List

| File | Action |
|------|--------|
| `apps/forecast-engine/src/models/__init__.py` | Created |
| `apps/forecast-engine/src/models/base.py` | Created |
| `apps/forecast-engine/src/models/registry.py` | Created |
| `apps/forecast-engine/src/pipeline/__init__.py` | Created |
| `apps/forecast-engine/src/pipeline/segmentation.py` | Created |
| `apps/forecast-engine/tests/test_model_registry.py` | Created |
| `apps/forecast-engine/tests/test_segmentation.py` | Created |

## Quality Gate Results

| Gate | Result |
|------|--------|
| ruff check | PASS — 0 errors |
| mypy --strict | PASS — 0 issues (5 files) |
| pytest | PASS — 23/23 tests |
| Coverage (registry.py) | 100% |
| Coverage (segmentation.py) | 100% |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |
| 2026-02-26 | 1.0 | Implementation complete, all quality gates pass | Dex (Dev) |
