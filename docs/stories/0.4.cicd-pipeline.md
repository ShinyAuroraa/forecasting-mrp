# Story 0.4: CI/CD Pipeline

## Status

Done

## Executor Assignment

executor: "@devops"
quality_gate: "@architect"
quality_gate_tools: ["yaml-lint", "gh actions validate", "dry-run"]

## Story

**As a** developer,
**I want** GitHub Actions CI/CD pipelines that automatically run lint, typecheck, test, and build on every pull request and push to main,
**so that** code quality is enforced automatically and broken code cannot be merged into the main branch.

## Acceptance Criteria

1. `.github/workflows/ci.yml` exists and triggers on pull requests to `main` branch
2. `.github/workflows/deploy.yml` exists and triggers on push to `main` branch
3. `.github/workflows/forecast-engine.yml` exists and runs Python-specific CI (pytest, mypy, ruff) on changes to `apps/forecast-engine/`
4. The CI pipeline has three jobs: `lint-typecheck` (pnpm turbo lint + typecheck), `test` (pnpm turbo test with PostgreSQL and Redis service containers), and `build` (pnpm turbo build, depends on lint-typecheck and test passing)
5. The Python CI pipeline has a single job with steps: ruff check, mypy check, pytest with coverage
6. Pipeline failure blocks PR merge (branch protection rule documented, not enforced by this story)
7. All workflows use `pnpm/action-setup@v4` for pnpm caching and `actions/setup-node@v4` with Node 18
8. The test job uses `timescale/timescaledb:latest-pg16` and `redis:7-alpine` as service containers
9. All workflows use `--frozen-lockfile` for reproducible installs
10. The deploy pipeline builds all packages successfully (no actual deployment -- placeholder for Phase 5)

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Create CI Workflow for Pull Requests** (AC: 1, 4, 7, 8, 9)
  - [x]Create `.github/workflows/ci.yml`:
    ```yaml
    name: CI
    on:
      pull_request:
        branches: [main]

    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true

    jobs:
      lint-typecheck:
        name: Lint & Typecheck
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: pnpm/action-setup@v4
          - uses: actions/setup-node@v4
            with:
              node-version: 18
              cache: 'pnpm'
          - run: pnpm install --frozen-lockfile
          - run: pnpm turbo lint
          - run: pnpm turbo typecheck

      test:
        name: Test
        runs-on: ubuntu-latest
        services:
          postgres:
            image: timescale/timescaledb:latest-pg16
            env:
              POSTGRES_DB: test_db
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: test
            ports:
              - 5432:5432
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
          redis:
            image: redis:7-alpine
            ports:
              - 6379:6379
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        steps:
          - uses: actions/checkout@v4
          - uses: pnpm/action-setup@v4
          - uses: actions/setup-node@v4
            with:
              node-version: 18
              cache: 'pnpm'
          - run: pnpm install --frozen-lockfile
          - run: pnpm turbo test

      build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint-typecheck, test]
        steps:
          - uses: actions/checkout@v4
          - uses: pnpm/action-setup@v4
          - uses: actions/setup-node@v4
            with:
              node-version: 18
              cache: 'pnpm'
          - run: pnpm install --frozen-lockfile
          - run: pnpm turbo build
    ```
  - [x]Verify YAML is valid (no syntax errors)

- [x] **Task 2: Create Deploy Workflow for Main Branch** (AC: 2, 7, 9, 10)
  - [x]Create `.github/workflows/deploy.yml`:
    ```yaml
    name: Deploy
    on:
      push:
        branches: [main]

    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: false

    jobs:
      build:
        name: Build All Packages
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: pnpm/action-setup@v4
          - uses: actions/setup-node@v4
            with:
              node-version: 18
              cache: 'pnpm'
          - run: pnpm install --frozen-lockfile
          - run: pnpm turbo build

      # Placeholder for future deployment steps (Phase 5)
      # deploy-api:
      #   needs: build
      #   ...
      # deploy-web:
      #   needs: build
      #   ...
    ```
  - [x]Verify YAML is valid

- [x] **Task 3: Create Python CI Workflow for Forecast Engine** (AC: 3, 5)
  - [x]Create `.github/workflows/forecast-engine.yml`:
    ```yaml
    name: Forecast Engine CI
    on:
      pull_request:
        branches: [main]
        paths:
          - 'apps/forecast-engine/**'
      push:
        branches: [main]
        paths:
          - 'apps/forecast-engine/**'

    concurrency:
      group: python-ci-${{ github.ref }}
      cancel-in-progress: true

    jobs:
      python-ci:
        name: Python Lint, Type Check & Test
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: apps/forecast-engine
        services:
          postgres:
            image: timescale/timescaledb:latest-pg16
            env:
              POSTGRES_DB: test_db
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: test
            ports:
              - 5432:5432
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
          redis:
            image: redis:7-alpine
            ports:
              - 6379:6379
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v5
            with:
              python-version: '3.11'
              cache: 'pip'
          - name: Install dependencies
            run: |
              pip install --upgrade pip
              pip install -r requirements.txt
              pip install ruff mypy pytest pytest-cov pytest-asyncio
          - name: Lint with ruff
            run: ruff check src/
          - name: Type check with mypy
            run: mypy src/ --ignore-missing-imports
          - name: Test with pytest
            run: pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
    ```
  - [x]Verify YAML is valid

- [x] **Task 4: Create .github Directory Structure** (AC: 1, 2, 3)
  - [x]Create `.github/workflows/` directory if it does not exist
  - [x]Verify all three workflow files are in place:
    ```
    .github/
    |-- workflows/
    |   |-- ci.yml
    |   |-- deploy.yml
    |   |-- forecast-engine.yml
    ```

- [x] **Task 5: Document Branch Protection Rules** (AC: 6)
  - [x]Add a comment at the top of `ci.yml` documenting the recommended branch protection settings:
    ```yaml
    # Branch Protection (to be configured manually in GitHub repo settings):
    # - Require status checks to pass before merging: lint-typecheck, test, build
    # - Require branches to be up to date before merging
    # - Require pull request reviews before merging (1 reviewer minimum)
    # - Do not allow bypassing the above settings
    ```
  - [x]This story does NOT configure branch protection rules (requires repo admin access)

- [x] **Task 6: Validate All Workflows** (AC: 1, 2, 3)
  - [x]Install `actionlint` or use online YAML validator to check all three workflow files
  - [x]Verify no duplicate job names, correct indentation, valid action references
  - [x]Verify `pnpm/action-setup@v4` is used in all Node.js workflows
  - [x]Verify `actions/setup-python@v5` is used in Python workflow
  - [x]Verify all checkout steps use `actions/checkout@v4`

## Dev Notes

### Architecture Reference
[Source: docs/architecture/7-infrastructure-devops.md, Section 7.2]

The CI/CD pipeline follows the architecture defined in Section 7.2. This story implements the PR pipeline (`ci.yml`), the main branch pipeline (`deploy.yml`), and the Python-specific pipeline (`forecast-engine.yml`).

### Pipeline Architecture

```
Pull Request to main:
  ci.yml:
    lint-typecheck ──┐
                     ├──> build (only if both pass)
    test ────────────┘

  forecast-engine.yml (only if apps/forecast-engine/ changed):
    python-ci (ruff + mypy + pytest)

Push to main:
  deploy.yml:
    build (placeholder for Phase 5 deployment)
```

### Key Design Decisions

1. **Concurrency groups**: Cancel in-progress CI runs when new commits are pushed to the same PR. Do NOT cancel deploy runs.
2. **Service containers**: Use GitHub Actions service containers for PostgreSQL and Redis during tests, matching production versions (TimescaleDB PG16, Redis 7).
3. **pnpm caching**: `pnpm/action-setup@v4` with `actions/setup-node@v4` cache provides automatic dependency caching.
4. **Path filtering**: Python CI only triggers when `apps/forecast-engine/` files change, saving CI minutes.
5. **No deployment**: Phase 0 focuses on quality gates only. Actual deployment to AWS EKS is Phase 5.
6. **Frozen lockfile**: `--frozen-lockfile` ensures CI uses exact versions from lockfile, preventing "works on my machine" issues.

### Node.js Version

Use Node 18 (LTS) across all CI jobs. This matches the Dockerfile base images (`node:18-alpine`).

### Python Version

Use Python 3.11 for the forecast engine. This matches the Dockerfile base image (`python:3.11-slim`).

### Test Environment Variables

The test jobs need `DATABASE_URL` and `REDIS_URL` pointing to the service containers:
- `DATABASE_URL`: `postgresql://postgres:test@localhost:5432/test_db`
- `REDIS_URL`: `redis://localhost:6379`

### Source Tree Reference
[Source: docs/architecture/source-tree.md]

```
.github/
|-- workflows/
|   |-- ci.yml                      # PR pipeline: lint + typecheck + test + build
|   |-- deploy.yml                  # Main: build + deploy
|   |-- forecast-engine.yml         # Python-specific CI (pytest, mypy, ruff)
```

### Future Enhancements (NOT in this story)

- Docker image build and push to GHCR (Phase 5)
- AWS EKS deployment (Phase 5)
- E2E tests with Playwright (Phase 5)
- Code coverage thresholds and reporting
- Dependency vulnerability scanning (Dependabot/Snyk)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story created during greenfield-fullstack workflow engine | River (SM) |
| 2026-02-25 | 0.2 | Implementation complete: all 6 tasks done, 3 workflow files created | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (@dev / Dex)

### Debug Log References
- `js-yaml` validation: all 3 YAML files valid
- `pnpm turbo build`: 3/3 tasks successful (shared, api, web)
- Branch protection rules documented as comments in ci.yml

### Completion Notes List
- Used Python 3.13 in forecast-engine.yml (matches Dockerfile `python:3.13-slim`) instead of 3.11 from story spec
- All workflows use `pnpm/action-setup@v4` and `actions/checkout@v4` as specified
- Python workflow uses `actions/setup-python@v5` as specified
- Concurrency groups: cancel-in-progress for CI/Python, no-cancel for Deploy
- Path filtering on forecast-engine.yml only triggers on `apps/forecast-engine/**` changes
- Branch protection rules documented but NOT enforced (requires GitHub repo admin access)

### File List

**Created:**
- `.github/workflows/ci.yml` — PR pipeline: lint-typecheck + test + build jobs
- `.github/workflows/deploy.yml` — Main branch pipeline: build (placeholder for Phase 5 deployment)
- `.github/workflows/forecast-engine.yml` — Python CI: ruff + mypy + pytest with coverage

## QA Results
(To be populated by QA agent)
