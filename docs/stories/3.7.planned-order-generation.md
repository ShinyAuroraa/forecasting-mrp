# Story 3.7: Planned Order Generation

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** the MRP engine to generate planned purchase and production orders from the lot-sized net requirements,
**so that** I have actionable orders with supplier assignments, work center assignments, cost estimates, and timing for the entire planning horizon.

## References

- FR-038: Planned Order Generation
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/order-generation.service.ts]

## Acceptance Criteria

- [x] AC-1: OrderGenerationService creates planned orders from lot-sized net requirements
- [x] AC-2: PURCHASED items (tipoProduto = MATERIA_PRIMA, INSUMO, EMBALAGEM, REVENDA) generate COMPRA orders with supplier, lead time, and cost
- [x] AC-3: PRODUCED items (tipoProduto = ACABADO, SEMI_ACABADO) generate PRODUCAO orders with work center, lead time, and hours needed
- [x] AC-4: For COMPRA orders: supplier is selected from ProdutoFornecedor (isPrincipal = true, or lowest precoUnitario)
- [x] AC-5: For COMPRA orders: custoEstimado = quantidade * fornecedor.precoUnitario
- [x] AC-6: For PRODUCAO orders: centroTrabalhoId is the primary work center from RoteiroProducao (first sequence step)
- [x] AC-7: For PRODUCAO orders: custoEstimado = (tempoSetupMinutos + quantidade * tempoUnitarioMinutos) / 60 * centroTrabalho.custoHora
- [x] AC-8: dataLiberacao = dataNecessidade - leadTimeDias (release date offset by lead time)
- [x] AC-9: Priority assignment: CRITICA if dataLiberacao < today, ALTA if dataLiberacao < today + 7 days, MEDIA otherwise
- [x] AC-10: All generated orders are linked to the current execucaoId
- [x] AC-11: Orders are persisted to the ordem_planejada table with status = PLANEJADA
- [x] AC-12: Unit tests >= 80% coverage with test cases for both COMPRA and PRODUCAO orders, supplier selection, cost estimation, and priority

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/order-generation.service.ts]
- [Source: architecture/6-data-architecture.md — ordem_planejada table]

### Data Model

**OrdemPlanejada (Prisma — already exists):**
```prisma
model OrdemPlanejada {
  id                      String         @id @default(uuid())
  execucaoId              String         @map("execucao_id")
  produtoId               String         @map("produto_id")
  tipo                    TipoOrdem      // COMPRA | PRODUCAO
  quantidade              Decimal        @db.Decimal(12, 4)
  dataNecessidade         DateTime       @map("data_necessidade") @db.Date
  dataLiberacao           DateTime       @map("data_liberacao") @db.Date
  dataRecebimentoEsperado DateTime?      @map("data_recebimento_esperado") @db.Date
  fornecedorId            String?        @map("fornecedor_id")
  centroTrabalhoId        String?        @map("centro_trabalho_id")
  custoEstimado           Decimal?       @map("custo_estimado") @db.Decimal(14, 4)
  lotificacaoUsada        Lotificacao?   @map("lotificacao_usada")
  prioridade              PrioridadeOrdem
  status                  StatusOrdem    @default(PLANEJADA)
  mensagemAcao            String?        @map("mensagem_acao") @db.VarChar(100)
  motivo                  String?        @db.VarChar(100)
  observacao              String?        @db.Text
}
```

### Supplier Selection Logic

```
For a COMPRA order:
  1. Find ProdutoFornecedor WHERE isPrincipal = true
  2. If none found: select fornecedor with lowest precoUnitario
  3. If still none found: log warning, leave fornecedorId = null
  4. Lead time: use ProdutoFornecedor.leadTimeDias (or Fornecedor.leadTimePadraoDias)
```

### Production Cost Estimation

```
For a PRODUCAO order:
  routing = RoteiroProducao for product (all steps)
  totalHours = sum over steps: (tempoSetupMinutos + quantidade * tempoUnitarioMinutos) / 60
  custoEstimado = totalHours * primaryWorkCenter.custoHora

  centroTrabalhoId = routing[0].centroTrabalhoId (primary/first step)
  leadTime = Produto.leadTimeProducaoDias
```

### Priority Assignment Rules

```
today = current date
CRITICA:  dataLiberacao < today (past due)
ALTA:     dataLiberacao < today + 7 days
MEDIA:    dataLiberacao >= today + 7 days AND < today + 14 days
BAIXA:    dataLiberacao >= today + 14 days
```

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/engine/order-generation.service.ts`
- `apps/api/src/modules/mrp/engine/order-generation.service.spec.ts`
- `apps/api/src/modules/mrp/engine/interfaces/order-generation.interface.ts`

**Modified:**
- `apps/api/src/modules/mrp/mrp.module.ts` (register OrderGenerationService)

### Testing Requirements

Test cases:
1. COMPRA order: purchased item generates order with supplier, lead time, cost
2. PRODUCAO order: produced item generates order with work center, hours, cost
3. Supplier selection: isPrincipal preferred; fallback to lowest price
4. No supplier found: order created with warning, fornecedorId = null
5. Cost estimation COMPRA: qty * precoUnitario
6. Cost estimation PRODUCAO: (setup + qty * unitTime) / 60 * custoHora
7. Release date offset: dataLiberacao = dataNecessidade - leadTimeDias
8. Priority CRITICA: release date in the past
9. Priority ALTA: release date within 7 days
10. Priority MEDIA/BAIXA: release date beyond 7/14 days
11. Multiple periods: orders generated for each period with net requirement > 0

### Technical Constraints
- PURCHASED items -> COMPRA orders (supplier, lead time, unit cost)
- PRODUCED items -> PRODUCAO orders (work center, lead time, hours needed)
- dataRecebimentoEsperado = dataNecessidade (the date the material is needed)
- All orders created with status = PLANEJADA
- lotificacaoUsada records which lot sizing method was applied

---

## Tasks / Subtasks

- [x] **Task 1: Define order generation interfaces** (AC: 1)
  - [x] Create `order-generation.interface.ts` with PlannedOrderInput, OrderGenerationInput, GeneratedOrder, OrderGenerationOutput

- [x] **Task 2: Implement supplier selection logic** (AC: 4)
  - [x] isPrincipal first, then lowest precoUnitario
  - [x] Handle no supplier found scenario (warning, fornecedorId = null)

- [x] **Task 3: Implement COMPRA order generation** (AC: 2, 5, 8)
  - [x] Create order with supplier, cost = qty * precoUnitario
  - [x] Release date = need date - supplier lead time

- [x] **Task 4: Implement PRODUCAO order generation** (AC: 3, 6, 7, 8)
  - [x] Load routing steps for product, ordered by sequencia
  - [x] Calculate total hours and cost per step (per-step custoHora)
  - [x] Assign primary work center from first routing step
  - [x] Release date = need date - production lead time

- [x] **Task 5: Implement priority assignment** (AC: 9)
  - [x] CRITICA/ALTA/MEDIA/BAIXA based on dataLiberacao vs referenceDate

- [x] **Task 6: Implement main generateOrders method** (AC: 1, 10, 11)
  - [x] Process all lot-sized net requirements
  - [x] Determine COMPRA vs PRODUCAO based on tipoProduto
  - [x] Persist to ordem_planejada with createMany, execucaoId linkage

- [x] **Task 7: Write comprehensive unit tests** (AC: 12)
  - [x] 39 test cases across 17 describe blocks (99%+ coverage)
  - [x] Mock ProdutoFornecedor, RoteiroProducao, CentroTrabalho, OrdemPlanejada data

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/order-generation.interface.ts` | Created | Order generation interfaces (PlannedOrderInput, OrderGenerationInput, GeneratedOrder, OrderGenerationOutput) |
| `apps/api/src/modules/mrp/engine/order-generation.service.ts` | Created | Order generation engine — supplier selection, COMPRA/PRODUCAO routing, cost estimation, priority, persistence (539 lines) |
| `apps/api/src/modules/mrp/engine/order-generation.service.spec.ts` | Created | 39 unit tests across 17 describe blocks (99%+ coverage) |
| `apps/api/src/modules/mrp/mrp.module.ts` | Modified | Added OrderGenerationService provider/export |

---

## Dependencies

- Story 3.5: Lot Sizing Engine (provides lot-sized net requirements)
- Story 3.1: Production Routing CRUD (RoteiroProducao data for PRODUCAO orders)
- Story 1.5: Supplier CRUD (ProdutoFornecedor for COMPRA orders)
- Story 1.7: Work Center Management (CentroTrabalho.custoHora for cost calculation)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-27 | 0.2 | Implementation complete — 3 files created, 1 modified, 39 tests (99% coverage) | Dex (Dev) |
| 2026-02-27 | 0.3 | QA Review PASS WITH CONCERNS — 12/12 AC, 1 MEDIUM (per-step custoHora vs single-rate), 0 CRITICAL | Quinn (QA) |
