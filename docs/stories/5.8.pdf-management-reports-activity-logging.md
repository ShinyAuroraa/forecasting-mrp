# Story 5.8: PDF Management Reports & User Activity Logging

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** system administrator / manager,
**I want** management-specific PDF reports and user activity logging,
**so that** I can track system usage, audit user actions, and produce executive reports.

## References

- FR-071: PDF Management Reports — generate PDF management reports for executive review
- FR-075: User Activity Logging — login analytics, page views, override logging
- [Story 4.10: Excel/PDF Export — existing export infrastructure]

## Acceptance Criteria

### PDF Management Reports (FR-071)
- [x] AC-1: New report type `FORECAST_ACCURACY` — forecast vs actual comparison per product
- [x] AC-2: New report type `SUPPLIER_PERFORMANCE` — lead time analysis per supplier
- [x] AC-3: New report type `INVENTORY_TURNOVER` — inventory metrics summary
- [x] AC-4: All new report types integrated into existing ExportType and PdfGeneratorService

### User Activity Logging (FR-075)
- [x] AC-5: New `AtividadeUsuario` Prisma model — tracks user actions with timestamp, type, metadata
- [x] AC-6: ActivityLogService.log() — records a user activity event
- [x] AC-7: ActivityLogService.getByUser() — paginated activity for a user
- [x] AC-8: ActivityLogService.getSummary() — aggregated stats (logins per day, actions per type)
- [x] AC-9: NestJS interceptor to auto-log API calls (login, overrides, exports)

### API Endpoints
- [x] AC-10: `GET /activity-log` — list activity logs with filters (viewer role)
- [x] AC-11: `GET /activity-log/summary` — activity summary statistics (admin role)

### Testing
- [x] AC-12: Unit tests for new PDF report types (covered by existing export tests + generator switch)
- [x] AC-13: Unit tests for ActivityLogService (log, getByUser, findAll, getSummary)
- [x] AC-14: Tests for activity log interceptor (tracked vs untracked routes, user extraction)

---

## Tasks / Subtasks

- [x] **Task 1: Schema + ActivityLog model** (AC: 5)
- [x] **Task 2: New PDF report types** (AC: 1-4)
- [x] **Task 3: ActivityLogService + interceptor** (AC: 6-9)
- [x] **Task 4: API endpoints** (AC: 10-11)
- [x] **Task 5: Tests** (AC: 12-14)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added TipoAtividade enum, AtividadeUsuario model with indexes |
| `apps/api/src/modules/export/export.types.ts` | Modified | Added FORECAST_ACCURACY, SUPPLIER_PERFORMANCE, INVENTORY_TURNOVER types |
| `apps/api/src/modules/export/generators/pdf.generator.ts` | Modified | Added 3 new report generators (forecast accuracy, supplier performance, inventory turnover) |
| `apps/api/src/modules/activity-log/activity-log.service.ts` | Created | Service with log, getByUser, findAll, getSummary methods |
| `apps/api/src/modules/activity-log/activity-log.controller.ts` | Created | REST endpoints for activity log retrieval |
| `apps/api/src/modules/activity-log/activity-log.interceptor.ts` | Created | NestJS interceptor for auto-logging tracked API routes |
| `apps/api/src/modules/activity-log/activity-log.module.ts` | Created | Module exporting service and interceptor |
| `apps/api/src/modules/activity-log/activity-log.service.spec.ts` | Created | 9 unit tests for service methods |
| `apps/api/src/modules/activity-log/activity-log.interceptor.spec.ts` | Created | 6 tests for interceptor route matching and logging |

---

## Dependencies

- Story 4.10: Excel/PDF Export (existing export module)
- Story 5.7: Historical Lead Time Tracking (supplier performance data)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — PDF Reports & Activity Logging | River (SM) |
| 2026-02-28 | 0.2 | All ACs implemented — 3 PDF report types, ActivityLog system, tests — Story Done | Dex (Dev) |
