# Story 1.3: Product CRUD & Search

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** production planner or inventory analyst,
**I want** full CRUD operations on products with paginated listing, search by code/description, and filters by type/category/status,
**so that** I can manage the product master data that feeds forecasting, MRP, and inventory modules.

## Acceptance Criteria

1. `ProdutosModule` exists with controller, service, and repository following the standard NestJS module pattern
2. `POST /api/v1/produtos` creates a product with validation on required fields (`codigo`, `descricao`, `tipoProduto`) and returns the created entity
3. `GET /api/v1/produtos` returns a paginated list with `PaginatedResponseDto<Produto>` format
4. `GET /api/v1/produtos/:id` returns a single product with its relations (categoria, unidadeMedida) or 404 if not found
5. `PATCH /api/v1/produtos/:id` updates a product with partial fields and returns the updated entity
6. `DELETE /api/v1/produtos/:id` soft-deletes a product (sets `ativo: false`) and returns 204
7. Search by `search` query param filters products where `codigo` OR `descricao` contain the search term (case-insensitive)
8. Filter by `tipoProduto` enum, `categoriaId` UUID, and `ativo` boolean query params
9. Sorting is supported via `sortBy` and `sortOrder` params with defaults `createdAt` / `desc`
10. Unique constraint on `codigo` returns 409 Conflict with field details (handled by PrismaExceptionFilter)
11. UUID params are validated with `UuidValidationPipe`
12. All endpoints are protected by `JwtAuthGuard`; create/update/delete require `operator` role, read requires `viewer`
13. All product infrastructure is covered by unit tests with >= 80% coverage

## Tasks / Subtasks

- [x] **Task 1: Create Product DTOs** (AC: 2, 5, 7, 8, 9)
  - [x] Create `apps/api/src/modules/produtos/dto/create-produto.dto.ts` with validation decorators
  - [x] Create `apps/api/src/modules/produtos/dto/update-produto.dto.ts` using `PartialType(CreateProdutoDto)`
  - [x] Create `apps/api/src/modules/produtos/dto/filter-produto.dto.ts` extending `PaginationDto` with search, tipoProduto, categoriaId, ativo

- [x] **Task 2: Create ProdutosRepository** (AC: 2, 3, 4, 5, 6, 7, 8, 9)
  - [x] Create `apps/api/src/modules/produtos/produtos.repository.ts`
  - [x] Implement `create(data)`, `findAll(filters)`, `findById(id)`, `update(id, data)`, `softDelete(id)`
  - [x] Build dynamic `where` clause from filter params (search, tipoProduto, categoriaId, ativo)
  - [x] Include `categoria` and `unidadeMedida` relations in findById
  - [x] Use `buildPaginatedResponse` helper for list endpoint

- [x] **Task 3: Create ProdutosService** (AC: 2, 3, 4, 5, 6, 10)
  - [x] Create `apps/api/src/modules/produtos/produtos.service.ts`
  - [x] Delegate to repository, handle business logic
  - [x] Throw `NotFoundException` for missing product on get/update/delete

- [x] **Task 4: Create ProdutosController** (AC: 2, 3, 4, 5, 6, 7, 8, 11, 12)
  - [x] Create `apps/api/src/modules/produtos/produtos.controller.ts`
  - [x] `POST /produtos` — `@Roles('operator')`, accepts `CreateProdutoDto`
  - [x] `GET /produtos` — `@Roles('viewer')`, accepts `FilterProdutoDto` as query
  - [x] `GET /produtos/:id` — `@Roles('viewer')`, validates UUID param
  - [x] `PATCH /produtos/:id` — `@Roles('operator')`, accepts `UpdateProdutoDto`
  - [x] `DELETE /produtos/:id` — `@Roles('admin')`, validates UUID, returns 204

- [x] **Task 5: Create ProdutosModule & Register** (AC: 1)
  - [x] Create `apps/api/src/modules/produtos/produtos.module.ts`
  - [x] Register in `AppModule`

- [x] **Task 6: Write Unit Tests** (AC: 13)
  - [x] `produtos.service.spec.ts` — Test CRUD operations with mocked repository
  - [x] `produtos.controller.spec.ts` — Test all endpoints with mocked service
  - [x] `produtos.repository.spec.ts` — Test query building with mocked PrismaService
  - [x] Verify coverage >= 80%

## Dev Notes

### Architecture Reference
[Source: docs/architecture/4-backend-architecture-appsapi.md, docs/architecture/coding-standards.md]

### Prisma Model

The `Produto` model has 20+ fields grouped as:
- **Dados Basicos:** codigo, descricao, tipoProduto, categoriaId, unidadeMedidaId, ativo
- **Dimensoes:** pesoLiquidoKg, volumeM3
- **Custos:** custoUnitario, custoPedido, custoManutencaoPctAno, precoVenda
- **Ressuprimento:** politicaRessuprimento, intervaloRevisaoDias, loteMinimo, multiploCompra, estoqueSegurancaManual, leadTimeProducaoDias

### Dependencies

This story depends on:
- **Story 1.1** (PrismaService, PaginationDto, UuidValidationPipe, ExceptionFilters)
- **Story 1.2** (JwtAuthGuard, RolesGuard, @Roles decorator)

### NPM Dependencies
No new dependencies needed — all infrastructure from Stories 1.1 and 1.2.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story created during greenfield-fullstack workflow engine (Epic 1) | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- FilterProdutoDto inherits PaginationDto with default values — tests need `as FilterProdutoDto` cast due to strict TypeScript
- No new dependencies needed — all infrastructure from Stories 1.1 and 1.2

### Completion Notes List
- All 6 tasks completed, 13/13 AC met
- 87/87 unit tests passing (14 test suites across all stories)
- Repository pattern: controller → service → repository → PrismaService
- Dynamic where clause construction for search/filter params
- Soft-delete via `ativo: false` (not hard delete)
- Relations included: categoria, unidadeMedida on findById and update
- Build: clean, no errors

### File List
**Created:**
- `apps/api/src/modules/produtos/produtos.module.ts`
- `apps/api/src/modules/produtos/produtos.controller.ts`
- `apps/api/src/modules/produtos/produtos.controller.spec.ts`
- `apps/api/src/modules/produtos/produtos.service.ts`
- `apps/api/src/modules/produtos/produtos.service.spec.ts`
- `apps/api/src/modules/produtos/produtos.repository.ts`
- `apps/api/src/modules/produtos/produtos.repository.spec.ts`
- `apps/api/src/modules/produtos/dto/create-produto.dto.ts`
- `apps/api/src/modules/produtos/dto/update-produto.dto.ts`
- `apps/api/src/modules/produtos/dto/filter-produto.dto.ts`

**Modified:**
- `apps/api/src/app.module.ts` — Added ProdutosModule

## QA Results
(To be populated by QA agent)
