# Story 5.4: Drift Detection & Auto-Retraining

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc", "pytest"]

## Story

**As a** data scientist / operations manager,
**I want** automatic detection of forecast model drift with triggered retraining,
**so that** forecasts remain accurate as demand patterns evolve, without requiring manual monitoring of model performance.

## References

- FR-067: Drift Detection and Auto-Retraining
- [Source: PRD §7.4 — Ciclos de Re-treino]
- [Risk: Model drift over time — Weekly MAPE monitoring; automatic drift detection]
- [Story 5.3: Champion-Challenger — promotion logic for retrained models]
- [ForecastMetrica — stores MAPE per product per model per execution]

## Acceptance Criteria

### Drift Detection Service (NestJS)
- [x] AC-1: DriftDetectionService computes rolling MAPE (last 4 weekly executions) per model type
- [x] AC-2: Drift threshold configurable (default: 15% MAPE increase over 4-week rolling average)
- [x] AC-3: Drift status per model: STABLE, WARNING (10-15% increase), DRIFTING (>15% increase)
- [x] AC-4: Drift check runs automatically after each pipeline execution (PIPELINE_DIARIO)
- [x] AC-5: When drift detected, triggers retraining job via existing forecast execution pipeline

### Drift Monitoring Data
- [x] AC-6: Stores drift check results in ForecastModelo.metricasTreino JSON (drift_log key)
- [x] AC-7: Maintains rolling window of last 8 MAPE values per model type for trend analysis

### API Endpoints (NestJS)
- [x] AC-8: `GET /forecast/drift-status` — returns drift status for all model types
- [x] AC-9: `GET /forecast/drift-status/:tipoModelo` — returns detailed drift history for a model type
- [x] AC-10: `POST /forecast/drift-check` — manually trigger drift detection check

### Frontend
- [x] AC-11: Drift status badge on model list (STABLE=green, WARNING=yellow, DRIFTING=red)
- [x] AC-12: MAPE trend sparkline showing last 8 weeks per model type

### Testing
- [x] AC-13: Unit tests for drift detection calculation (rolling MAPE, threshold comparison)
- [x] AC-14: Unit tests for drift status transitions (STABLE → WARNING → DRIFTING)
- [x] AC-15: NestJS endpoint tests for drift-status and drift-check
- [x] AC-16: Frontend render tests for drift badge and sparkline

---

## Tasks / Subtasks

- [x] **Task 1: Implement DriftDetectionService** (AC: 1-5)
- [x] **Task 2: Drift monitoring data storage** (AC: 6, 7)
- [x] **Task 3: Create API endpoints** (AC: 8, 9, 10)
- [x] **Task 4: Create frontend components** (AC: 11, 12)
- [x] **Task 5: Write backend tests** (AC: 13, 14, 15)
- [x] **Task 6: Write frontend tests** (AC: 16)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/forecast/drift-detection.interfaces.ts` | Created | DriftStatus enum, DriftCheckResult, DriftLog interfaces, threshold constants |
| `apps/api/src/modules/forecast/drift-detection.service.ts` | Created | DriftDetectionService: rolling MAPE, drift status, auto-retraining trigger |
| `apps/api/src/modules/forecast/dto/drift-check.dto.ts` | Created | DriftCheckQueryDto with optional tipoModelo |
| `apps/api/src/modules/forecast/forecast.controller.ts` | Modified | Added drift-status (GET), drift-status/:tipoModelo (GET), drift-check (POST) endpoints |
| `apps/api/src/modules/forecast/forecast.module.ts` | Modified | Added DriftDetectionService to providers and exports |
| `apps/api/src/modules/forecast/drift-detection.service.spec.ts` | Created | 14 unit tests: drift calculation, status transitions, endpoint integration |
| `apps/web/src/hooks/use-drift.ts` | Created | useDriftStatus, useDriftStatusByModel, useTriggerDriftCheck hooks |
| `apps/web/src/components/forecast/drift-monitor.tsx` | Created | DriftMonitor with DriftCard, MapeSparkline SVG, status badges |
| `apps/web/src/app/forecast/page.tsx` | Modified | Added DriftMonitor component |
| `apps/web/src/components/forecast/__tests__/drift-monitor.test.tsx` | Created | 17 frontend tests: badge variants, sparkline SVG, manual check button |

---

## Dependencies

- Story 2.5: Forecast Pipeline (existing execution infrastructure)
- Story 5.3: Champion-Challenger (promotion after retraining)
- ForecastMetrica table (stores per-execution MAPE values)
- ExecucaoPlanejamento with PIPELINE_DIARIO type

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — Drift Detection & Auto-Retraining | River (SM) |
| 2026-02-28 | 0.2 | Implemented DriftDetectionService, API endpoints, frontend DriftMonitor | Dex (Dev) |
| 2026-02-28 | 0.3 | Backend tests (14) + frontend tests (17) — All ACs complete, Story Done | Dex (Dev) |
