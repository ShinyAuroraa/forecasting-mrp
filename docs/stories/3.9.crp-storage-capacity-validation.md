# Story 3.9: CRP & Storage Capacity Validation

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** the MRP engine to validate planned production orders against work center capacity (CRP) and validate projected inventory against warehouse storage capacity,
**so that** I can identify capacity bottlenecks and storage constraints before committing to the plan.

## References

- FR-040: Capacity Requirements Planning (CRP)
- FR-041: Storage Capacity Validation
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/crp.service.ts, storage-validation.service.ts]

## Acceptance Criteria

### CRP (FR-040)
- [x] AC-1: CrpService calculates planned load per work center per week from PRODUCAO orders
- [x] AC-2: For each work center and week: planned load = sum of (tempoSetupMinutos + quantidade * tempoUnitarioMinutos) / 60 for all production orders
- [x] AC-3: Available capacity per work center per week = working days * sum of shift hours * (eficienciaPercentual / 100), minus scheduled stops
- [x] AC-4: Utilization = (planned load / available capacity) * 100
- [x] AC-5: RULE — Overload thresholds: <=110% = HORA_EXTRA, 110-130% = ANTECIPAR, >130% = SUBCONTRATAR
- [x] AC-6: CRP results are persisted to carga_capacidade table with execucaoId, centroTrabalhoId, period, available hours, planned hours, utilization %, overload flag, suggestion
- [x] AC-7: Working days per week are determined from CalendarioFabrica (tipo = UTIL count per week)

### Storage Capacity Validation (FR-041)
- [x] AC-8: StorageValidationService projects inventory volume per warehouse per week
- [x] AC-9: Projected volume = current stock + incoming orders (planned receipts) - outgoing consumption (gross requirements)
- [x] AC-10: RULE — >90% capacity utilization = ALERT; >95% = CRITICAL ALERT
- [x] AC-11: Storage alerts include: depositoId, week, projected utilization %, alert severity

### General
- [x] AC-12: Both services receive planned orders and return validation results without modifying the orders
- [x] AC-13: Unit tests >= 80% coverage with test cases for overload scenarios, shift calculations, and storage thresholds

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/crp.service.ts, storage-validation.service.ts]
- [Source: architecture/6-data-architecture.md — carga_capacidade table]

### Data Models

**CargaCapacidade (Prisma — already exists):**
```prisma
model CargaCapacidade {
  id                        String              @id @default(uuid())
  execucaoId                String              @map("execucao_id")
  centroTrabalhoId          String              @map("centro_trabalho_id")
  periodo                   DateTime            @db.Date
  capacidadeDisponivelHoras Decimal             @map("capacidade_disponivel_horas") @db.Decimal(8, 2)
  cargaPlanejadaHoras       Decimal             @map("carga_planejada_horas") @db.Decimal(8, 2)
  utilizacaoPercentual      Decimal             @map("utilizacao_percentual") @db.Decimal(5, 2)
  sobrecarga                Boolean             @default(false)
  horasExcedentes           Decimal             @default(0) @map("horas_excedentes") @db.Decimal(8, 2)
  sugestao                  SugestaoCapacidade?
}
```

### CRP Calculation

```
For each work center:
  For each week in planning horizon:
    // Available capacity
    workingDays = count CalendarioFabrica WHERE tipo = UTIL AND data in week
    shiftHoursPerDay = sum of (horaFim - horaInicio) for active Turnos on those weekdays
    scheduledStopHours = sum of ParadaProgramada hours in this week for this work center
    availableCapacity = workingDays * shiftHoursPerDay * (eficienciaPercentual / 100) - scheduledStopHours

    // Planned load
    productionOrders = OrdemPlanejada WHERE centroTrabalhoId = X AND tipo = PRODUCAO AND dataNecessidade in week
    For each order:
      routing = RoteiroProducao WHERE produtoId = order.produtoId AND centroTrabalhoId = X
      hoursNeeded = (routing.tempoSetupMinutos + order.quantidade * routing.tempoUnitarioMinutos) / 60
    plannedLoad = sum(hoursNeeded)

    // Utilization and suggestion
    utilization = (plannedLoad / availableCapacity) * 100
    overload = utilization > 100
    horasExcedentes = MAX(0, plannedLoad - availableCapacity)
    sugestao =
      utilization <= 110 ? HORA_EXTRA :
      utilization <= 130 ? ANTECIPAR :
      SUBCONTRATAR
```

### Storage Capacity Calculation

```
For each deposito:
  For each week in planning horizon:
    currentVolumeM3 = sum of (InventarioAtual.quantidadeDisponivel * Produto.volumeM3) for this deposito
    incomingVolume = sum of planned receipt volumes for this week
    outgoingVolume = sum of gross requirement volumes for this week
    projectedVolume = currentVolumeM3 + incomingVolume - outgoingVolume

    utilizationPct = (projectedVolume / deposito.capacidadeM3) * 100

    if utilizationPct > 95: severity = CRITICAL
    else if utilizationPct > 90: severity = ALERT
    else: severity = OK
```

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/engine/crp.service.ts`
- `apps/api/src/modules/mrp/engine/crp.service.spec.ts`
- `apps/api/src/modules/mrp/engine/storage-validation.service.ts`
- `apps/api/src/modules/mrp/engine/storage-validation.service.spec.ts`
- `apps/api/src/modules/mrp/engine/interfaces/crp.interface.ts`
- `apps/api/src/modules/mrp/engine/interfaces/storage-validation.interface.ts`

**Modified:**
- `apps/api/src/modules/mrp/mrp.module.ts` (register CrpService and StorageValidationService)

### Testing Requirements

**CRP test cases:**
1. Normal load (< 100%): no overload, sugestao = OK (null)
2. Overload 100-110%: sugestao = HORA_EXTRA
3. Overload 110-130%: sugestao = ANTECIPAR
4. Overload > 130%: sugestao = SUBCONTRATAR
5. Scheduled stop reduces available capacity
6. Multiple shifts per work center increase available capacity
7. No production orders for a work center: load = 0
8. Working days from CalendarioFabrica (holiday reduces capacity)

**Storage test cases:**
1. Utilization < 90%: OK (no alert)
2. Utilization 90-95%: ALERT
3. Utilization > 95%: CRITICAL ALERT
4. Incoming receipts increase projected volume
5. Outgoing consumption decreases projected volume

### Technical Constraints
- RULE: Overload thresholds: <=110% = HORA_EXTRA, 110-130% = ANTECIPAR, >130% = SUBCONTRATAR
- RULE: Storage: >90% ALERT, >95% CRITICAL ALERT
- SugestaoCapacidade enum values: OK, HORA_EXTRA, ANTECIPAR, SUBCONTRATAR
- CRP must account for CalendarioFabrica (factory calendar) working days
- Shift hours calculated considering overnight shifts (e.g., 22:00-06:00 = 8 hours)
- Storage validation uses Deposito.capacidadeM3 and Produto.volumeM3

---

## Tasks / Subtasks

- [x] **Task 1: Define CRP interfaces** (AC: 1, 6)
  - [x] Create `crp.interface.ts` with WeeklyBucket, CrpInput, CrpWeekResult, CrpWorkCenterResult, CrpOutput

- [x] **Task 2: Implement available capacity calculator** (AC: 3, 7)
  - [x] Working days from CalendarioFabrica, shift hours with overnight handling
  - [x] Efficiency factor applied, scheduled stop hours subtracted

- [x] **Task 3: Implement planned load calculator** (AC: 2)
  - [x] Sum (setup + qty * unitTime) / 60 per order per WC per week

- [x] **Task 4: Implement CRP utilization and suggestions** (AC: 4-6)
  - [x] Utilization with zero-division guard, 4-level suggestion thresholds
  - [x] Persist to carga_capacidade via createMany

- [x] **Task 5: Define storage validation interfaces** (AC: 8, 11)
  - [x] Create `storage-validation.interface.ts` with StorageAlertSeverity, PlannedMovement, StorageValidationInput/Output

- [x] **Task 6: Implement storage projection calculator** (AC: 8-10)
  - [x] Cumulative weekly volume projection, 90%/95% thresholds, volume floor at 0

- [x] **Task 7: Write CRP unit tests** (AC: 13)
  - [x] 19 test cases covering all CRP ACs + boundary tests

- [x] **Task 8: Write storage validation unit tests** (AC: 13)
  - [x] 14 test cases covering all Storage ACs + boundary tests

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/crp.interface.ts` | Created | CRP interfaces (CrpInput, CrpWeekResult, CrpWorkCenterResult, CrpOutput) |
| `apps/api/src/modules/mrp/engine/crp.service.ts` | Created | CRP engine — capacity calc, load calc, suggestions, persistence (~430 lines) |
| `apps/api/src/modules/mrp/engine/crp.service.spec.ts` | Created | 19 CRP tests with boundary coverage (~580 lines) |
| `apps/api/src/modules/mrp/engine/interfaces/storage-validation.interface.ts` | Created | Storage interfaces (StorageAlertSeverity, StorageValidationInput/Output) |
| `apps/api/src/modules/mrp/engine/storage-validation.service.ts` | Created | Storage projection engine — cumulative volume, 90%/95% thresholds (~310 lines) |
| `apps/api/src/modules/mrp/engine/storage-validation.service.spec.ts` | Created | 14 Storage tests with boundary coverage (~430 lines) |
| `apps/api/src/modules/mrp/mrp.module.ts` | Modified | Added CrpService + StorageValidationService (11 providers/exports) |

---

## Dependencies

- Story 3.7: Planned Order Generation (production orders to load against capacity)
- Story 3.1: Production Routing & Factory Calendar CRUD (routing times, calendar data)
- Story 1.7: Work Center & Shift Management (shifts, efficiency, scheduled stops)
- Story 1.9: Warehouse & Inventory Management (deposito capacity, inventario_atual)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-27 | 0.2 | Implementation complete — 6 files created, 1 modified, 33 tests (90%+ coverage) | Dex (Dev) |
| 2026-02-27 | 0.3 | QA Review PASS WITH CONCERNS — 13/13 AC, 0 CRITICAL, 0 HIGH, 2 MEDIUM (informational), 3 LOW (DRY refactor) | Quinn (QA) |
