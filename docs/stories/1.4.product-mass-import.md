# Story 1.4: Product Mass Import (CSV/XLSX)

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** production planner,
**I want** to upload a CSV or XLSX file to import products in bulk,
**so that** I can quickly populate the product master data without manual entry for each product.

## Acceptance Criteria

1. `POST /api/v1/produtos/import` accepts a multipart file upload (CSV or XLSX) and processes it
2. `GET /api/v1/produtos/import/template` returns a downloadable XLSX template with column headers and sample data
3. CSV and XLSX file formats are both supported for upload
4. Each row is validated against the same rules as `CreateProdutoDto` (required fields, enum values, numeric constraints)
5. Duplicate `codigo` values (within the file or against existing DB records) are reported as errors
6. Successful rows are imported even when some rows fail (partial success)
7. The response includes a summary: `{ imported, rejected, errors: [{ row, field, value, message }] }`
8. Invalid file types are rejected with 400 Bad Request
9. The import endpoint requires `operator` role
10. Import service is covered by unit tests with >= 80% coverage

## Tasks / Subtasks

- [x] **Task 1: Install exceljs dependency** (AC: 2, 3)
  - [x] `pnpm add --filter @forecasting-mrp/api exceljs`
  - [x] `pnpm add --filter @forecasting-mrp/api -D @types/multer`

- [x] **Task 2: Create ImportProdutosService** (AC: 1, 3, 4, 5, 6, 7, 8)
  - [x] Create `apps/api/src/modules/produtos/import/import-produtos.service.ts`
  - [x] Parse CSV: detect comma/semicolon delimiter, parse headers, map to DTO fields
  - [x] Parse XLSX: use exceljs to read workbook, extract rows from first sheet
  - [x] Validate each row against CreateProdutoDto rules
  - [x] Check `codigo` uniqueness within file and against DB
  - [x] Insert valid rows via ProdutosRepository, collect errors for invalid rows
  - [x] Return `{ imported, rejected, errors }`

- [x] **Task 3: Create Template Service** (AC: 2)
  - [x] Create `apps/api/src/modules/produtos/import/import-template.service.ts`
  - [x] Build XLSX template with exceljs: headers + 2 sample rows
  - [x] Return Buffer for streaming download

- [x] **Task 4: Add Import Endpoints to Controller** (AC: 1, 2, 8, 9)
  - [x] Add `POST /produtos/import` with `FileInterceptor`, `@Roles('operator')`
  - [x] Add `GET /produtos/import/template` with `@Roles('viewer')`, return XLSX file
  - [x] Validate file mimetype (CSV, XLSX only)

- [x] **Task 5: Write Unit Tests** (AC: 10)
  - [x] `import-produtos.service.spec.ts` — Test CSV parsing, XLSX parsing, validation, partial success
  - [x] `import-template.service.spec.ts` — Test template generation
  - [x] Verify coverage >= 80%

## Dev Notes

### Dependencies
- `exceljs` — XLSX read/write (prescribed by architecture)
- `@nestjs/platform-express` — already installed (includes multer)

### Response Format
```json
{
  "imported": 145,
  "rejected": 5,
  "errors": [
    { "row": 3, "field": "tipo_produto", "value": "INVALIDO", "message": "Invalid enum value" },
    { "row": 7, "field": "codigo", "value": "SKU-001", "message": "Duplicate codigo already exists in database" }
  ]
}
```

### Dependencies
This story depends on:
- **Story 1.3** (ProdutosRepository, CreateProdutoDto)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story created during greenfield-fullstack workflow engine | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- exceljs Buffer type incompatibility: `Buffer<ArrayBufferLike>` not assignable → used `as unknown as ExcelJS.Buffer` cast
- ImportResult interface not exported → added `export` keyword
- Controller constructor changed from 1 to 3 args → updated spec with import service mocks

### Completion Notes List
- 12/12 import tests passing (10 import-produtos + 2 import-template)
- 99/99 total tests passing across 16 suites
- Build clean, no TypeScript errors
- CSV parsing supports comma and semicolon delimiters
- XLSX parsing via exceljs with row-level validation
- Partial success: valid rows imported even when some fail
- Template generates XLSX with 18 column headers + 2 sample rows

### File List

**Created:**
- `apps/api/src/modules/produtos/import/import-produtos.service.ts`
- `apps/api/src/modules/produtos/import/import-produtos.service.spec.ts`
- `apps/api/src/modules/produtos/import/import-template.service.ts`
- `apps/api/src/modules/produtos/import/import-template.service.spec.ts`

**Modified:**
- `apps/api/src/modules/produtos/produtos.controller.ts` (added import endpoints)
- `apps/api/src/modules/produtos/produtos.controller.spec.ts` (updated constructor mocks)
- `apps/api/src/modules/produtos/produtos.module.ts` (registered import services)
- `apps/api/package.json` (added exceljs, @types/multer)

## QA Results
(To be populated by QA agent)
