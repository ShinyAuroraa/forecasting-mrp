# Story 3.8: Action Messages

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** the MRP engine to generate action messages by comparing the new plan against existing orders,
**so that** I receive specific recommendations (cancel, increase, reduce, expedite, or create new) to align current orders with the new MRP plan.

## References

- FR-039: Action Messages
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/action-messages.service.ts]

## Acceptance Criteria

- [x] AC-1: ActionMessagesService compares newly planned orders against existing FIRME/LIBERADA orders for the same product and period
- [x] AC-2: Message type CANCEL: existing order has no corresponding planned requirement (demand dropped to 0)
- [x] AC-3: Message type INCREASE: existing order quantity < planned requirement (demand increased)
- [x] AC-4: Message type REDUCE: existing order quantity > planned requirement (demand decreased, but not to 0)
- [x] AC-5: Message type EXPEDITE: existing order has a later delivery date than the planned need date (need date moved earlier)
- [x] AC-6: Message type NEW: planned requirement with no corresponding existing order (new demand)
- [x] AC-7: Each action message is stored in the mensagemAcao field of the corresponding OrdemPlanejada record
- [x] AC-8: Action messages include the delta quantity (for INCREASE/REDUCE) and the date change (for EXPEDITE)
- [x] AC-9: Only active orders (status = FIRME or LIBERADA) are compared; PLANEJADA and CANCELADA orders are ignored
- [x] AC-10: Unit tests >= 80% coverage with test cases for each message type

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/action-messages.service.ts]

### Action Message Logic

```
For each product in the planning horizon:
  existingOrders = OrdemPlanejada WHERE produtoId = X AND status IN (FIRME, LIBERADA)
  plannedOrders = newly generated planned orders for product X

  Match existing orders to planned orders by produtoId + nearest period:

  Case 1 - CANCEL:
    Existing order exists BUT no planned order for that period/product
    -> mensagemAcao = "CANCEL: No requirement for period YYYY-MM-DD"

  Case 2 - INCREASE:
    Existing order.quantidade < planned.quantidade for same product/period
    delta = planned.quantidade - existing.quantidade
    -> mensagemAcao = "INCREASE: +{delta} units needed"

  Case 3 - REDUCE:
    Existing order.quantidade > planned.quantidade AND planned.quantidade > 0
    delta = existing.quantidade - planned.quantidade
    -> mensagemAcao = "REDUCE: -{delta} units excess"

  Case 4 - EXPEDITE:
    Existing order.dataRecebimentoEsperado > planned.dataNecessidade
    daysDelta = existing.dataRecebimentoEsperado - planned.dataNecessidade
    -> mensagemAcao = "EXPEDITE: Move forward {daysDelta} days"

  Case 5 - NEW:
    Planned order exists BUT no matching existing order
    -> mensagemAcao = "NEW: {quantidade} units needed by YYYY-MM-DD"
```

### Matching Strategy

```
Matching is done by:
  1. Same produtoId
  2. Same tipo (COMPRA/PRODUCAO)
  3. Period overlap: existing.dataNecessidade falls within planned period bucket

If multiple existing orders match a single planned period:
  - Sum existing quantities and compare against planned quantity
  - Generate one action message for the aggregate difference
```

### Data Structures

```typescript
enum ActionMessageType {
  CANCEL = 'CANCEL',
  INCREASE = 'INCREASE',
  REDUCE = 'REDUCE',
  EXPEDITE = 'EXPEDITE',
  NEW = 'NEW',
}

interface ActionMessage {
  type: ActionMessageType;
  produtoId: string;
  existingOrderId?: string;  // null for NEW
  plannedOrderId?: string;   // null for CANCEL
  message: string;
  deltaQuantity?: number;    // for INCREASE/REDUCE
  deltaDays?: number;        // for EXPEDITE
  currentDate?: Date;        // existing delivery date
  requiredDate?: Date;       // planned need date
}
```

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/engine/action-messages.service.ts`
- `apps/api/src/modules/mrp/engine/action-messages.service.spec.ts`
- `apps/api/src/modules/mrp/engine/interfaces/action-messages.interface.ts`

**Modified:**
- `apps/api/src/modules/mrp/mrp.module.ts` (register ActionMessagesService)

### Testing Requirements

Test cases:
1. CANCEL: existing order, no planned requirement -> CANCEL message
2. INCREASE: existing qty < planned qty -> INCREASE message with delta
3. REDUCE: existing qty > planned qty (> 0) -> REDUCE message with delta
4. EXPEDITE: existing delivery date > planned need date -> EXPEDITE with days delta
5. NEW: planned order, no existing match -> NEW message
6. No changes needed: existing matches planned exactly -> no action message
7. Multiple existing orders for same product/period: aggregated comparison
8. Mixed messages: same product gets INCREASE in one period, REDUCE in another
9. FIRME orders compared, PLANEJADA orders ignored

### Technical Constraints
- Action message types: CANCEL, INCREASE, REDUCE, EXPEDITE, NEW
- Only compare against FIRME or LIBERADA orders (not PLANEJADA or CANCELADA)
- mensagemAcao field on OrdemPlanejada is VarChar(100) — keep messages concise
- An order can have both quantity and date changes; in that case, generate the most impactful message (EXPEDITE takes priority if both apply)

---

## Tasks / Subtasks

- [x] **Task 1: Define action messages interfaces** (AC: 8)
  - [x] Create `action-messages.interface.ts` with ActionMessageType enum, ActionMessage, PlannedOrderRef, ActionMessagesInput/Output

- [x] **Task 2: Implement order matching logic** (AC: 1, 9)
  - [x] Load existing FIRME/LIBERADA orders via Prisma
  - [x] Match by produtoId + tipo + period overlap (±3 days tolerance)

- [x] **Task 3: Implement CANCEL detection** (AC: 2)
  - [x] Existing order with no planned match → CANCEL message

- [x] **Task 4: Implement INCREASE/REDUCE detection** (AC: 3, 4)
  - [x] Compare quantities, calculate delta, aggregate multiple existing orders

- [x] **Task 5: Implement EXPEDITE detection** (AC: 5)
  - [x] Compare delivery dates, calculate days delta, EXPEDITE takes priority over qty changes

- [x] **Task 6: Implement NEW detection** (AC: 6)
  - [x] Planned order with no existing match → NEW message

- [x] **Task 7: Implement main generateActionMessages method** (AC: 1, 7)
  - [x] Process all products, persist mensagemAcao on OrdemPlanejada records

- [x] **Task 8: Write comprehensive unit tests** (AC: 10)
  - [x] 24 test cases across 14 groups (97%+ coverage)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/action-messages.interface.ts` | Created | ActionMessageType enum + interfaces (ActionMessage, PlannedOrderRef, ActionMessagesInput/Output) |
| `apps/api/src/modules/mrp/engine/action-messages.service.ts` | Created | Action message engine — load/group/compare/persist, 5 message types, period tolerance ±3d (610 lines) |
| `apps/api/src/modules/mrp/engine/action-messages.service.spec.ts` | Created | 24 unit tests across 14 groups (97%+ coverage) |
| `apps/api/src/modules/mrp/mrp.module.ts` | Modified | Added ActionMessagesService provider/export |

---

## Dependencies

- Story 3.7: Planned Order Generation (newly generated planned orders to compare against existing)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-27 | 0.2 | Implementation complete — 3 files created, 1 modified, 24 tests (97% coverage) | Dex (Dev) |
| 2026-02-27 | 0.3 | QA Review PASS — 10/10 AC, 0 CRITICAL, 0 HIGH, 1 MEDIUM (EXPEDITE suppresses qty change), 3 LOW | Quinn (QA) |
