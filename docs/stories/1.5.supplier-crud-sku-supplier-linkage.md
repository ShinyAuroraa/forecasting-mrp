# Story 1.5: Supplier CRUD & SKU-Supplier Linkage

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** procurement manager,
**I want** to manage suppliers and link them to products with pricing, MOQ, and lead time data,
**so that** the MRP engine can select optimal suppliers when generating purchase orders.

## Acceptance Criteria

1. `POST /api/v1/fornecedores` creates a new supplier with all fields from the schema
2. `GET /api/v1/fornecedores` returns paginated suppliers with search (codigo, razaoSocial, nomeFantasia) and filter (ativo, estado)
3. `GET /api/v1/fornecedores/:id` returns a supplier with linked products (produtoFornecedor relations)
4. `PATCH /api/v1/fornecedores/:id` updates supplier fields
5. `DELETE /api/v1/fornecedores/:id` soft-deletes the supplier (ativo: false)
6. CNPJ field is validated with check digit algorithm (NFR-019)
7. `POST /api/v1/produto-fornecedor` creates a product-supplier linkage with leadTimeDias, precoUnitario, moq, multiploCompra, isPrincipal
8. `PATCH /api/v1/produto-fornecedor/:id` updates linkage fields
9. `DELETE /api/v1/produto-fornecedor/:id` removes a linkage (hard delete)
10. `GET /api/v1/produto-fornecedor?produtoId=X` lists all suppliers for a given product
11. `GET /api/v1/produto-fornecedor?fornecedorId=X` lists all products for a given supplier
12. Only one linkage can have isPrincipal=true per product (enforce uniqueness)
13. Supplier module requires operator role for write, viewer for read, admin for delete
14. All services are covered by unit tests with >= 80% coverage

## Tasks / Subtasks

- [x] **Task 1: Create Fornecedor DTOs** (AC: 1, 2, 6)
  - [x] `create-fornecedor.dto.ts` with CNPJ validation
  - [x] `update-fornecedor.dto.ts` (PartialType)
  - [x] `filter-fornecedor.dto.ts` (extends PaginationDto)

- [x] **Task 2: Create CNPJ Validator** (AC: 6)
  - [x] Custom class-validator decorator `@IsCnpj()`
  - [x] Implement check digit algorithm

- [x] **Task 3: Create Fornecedor Repository, Service, Controller** (AC: 1-5, 13)
  - [x] Repository with dynamic where, pagination, soft delete, include produtoFornecedor
  - [x] Service with NotFoundException checks
  - [x] Controller with @Roles decorators and UuidValidationPipe

- [x] **Task 4: Create ProdutoFornecedor DTOs** (AC: 7, 8, 10, 11)
  - [x] `create-produto-fornecedor.dto.ts`
  - [x] `update-produto-fornecedor.dto.ts`
  - [x] `filter-produto-fornecedor.dto.ts`

- [x] **Task 5: Create ProdutoFornecedor Repository, Service, Controller** (AC: 7-12)
  - [x] Repository with linkage CRUD and isPrincipal enforcement
  - [x] Service with unique constraint validation
  - [x] Controller with @Roles decorators

- [x] **Task 6: Create FornecedoresModule and register in AppModule** (AC: all)
  - [x] Module with all providers and exports
  - [x] Register in AppModule

- [x] **Task 7: Write Unit Tests** (AC: 14)
  - [x] CNPJ validator tests
  - [x] Fornecedor repository, service, controller tests
  - [x] ProdutoFornecedor repository, service, controller tests

## Dev Notes

### Dependencies
This story depends on:
- **Story 1.1** (PrismaService, common infrastructure)
- **Story 1.2** (Auth guards, @Roles decorator)
- **Story 1.3** (Produto model exists in DB)

### CNPJ Validation Algorithm
- 14-digit format: XX.XXX.XXX/XXXX-XX
- Two check digits computed with modular arithmetic
- Accept with or without formatting (strip non-digits)

### isPrincipal Constraint
- When setting isPrincipal=true, unset any existing isPrincipal=true for the same produtoId
- Use a transaction to ensure atomicity

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created during greenfield-fullstack workflow engine | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- No errors encountered — clean implementation following established patterns

### Completion Notes List
- 55 new tests passing (7 CNPJ, 11 fornecedor repo, 7 fornecedor service, 6 fornecedor controller, 12 produto-fornecedor repo, 7 produto-fornecedor service, 5 produto-fornecedor controller)
- 154/154 total tests passing across 23 suites
- Build clean, no TypeScript errors
- CNPJ validation with full check digit algorithm (weights-based modular arithmetic)
- isPrincipal uniqueness enforced via $transaction (unset existing before setting new)
- ProdutoFornecedor unique constraint (produtoId + fornecedorId) handled with ConflictException

### File List

**Created:**
- `apps/api/src/common/validators/cnpj.validator.ts`
- `apps/api/src/common/validators/cnpj.validator.spec.ts`
- `apps/api/src/modules/fornecedores/dto/create-fornecedor.dto.ts`
- `apps/api/src/modules/fornecedores/dto/update-fornecedor.dto.ts`
- `apps/api/src/modules/fornecedores/dto/filter-fornecedor.dto.ts`
- `apps/api/src/modules/fornecedores/fornecedores.repository.ts`
- `apps/api/src/modules/fornecedores/fornecedores.repository.spec.ts`
- `apps/api/src/modules/fornecedores/fornecedores.service.ts`
- `apps/api/src/modules/fornecedores/fornecedores.service.spec.ts`
- `apps/api/src/modules/fornecedores/fornecedores.controller.ts`
- `apps/api/src/modules/fornecedores/fornecedores.controller.spec.ts`
- `apps/api/src/modules/fornecedores/fornecedores.module.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/dto/create-produto-fornecedor.dto.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/dto/update-produto-fornecedor.dto.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/dto/filter-produto-fornecedor.dto.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/produto-fornecedor.repository.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/produto-fornecedor.repository.spec.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/produto-fornecedor.service.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/produto-fornecedor.service.spec.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/produto-fornecedor.controller.ts`
- `apps/api/src/modules/fornecedores/produto-fornecedor/produto-fornecedor.controller.spec.ts`

**Modified:**
- `apps/api/src/app.module.ts` (added FornecedoresModule)

## QA Results
(To be populated by QA agent)
