# Story 4.3: Email Listener & PDF Processing

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** system administrator,
**I want** the system to automatically monitor an email inbox for daily closing data and process PDF attachments via OCR,
**so that** daily data ingestion happens without manual file uploads.

## References

- FR-050: Email Listener
- FR-060: OCR for PDF Attachments
- [Source: architecture/9-integration-patterns.md#9.1 — Email Integration]

## Acceptance Criteria

### Email Listener (FR-050)
- [x] AC-1: System supports three email adapters: Gmail API (OAuth2), IMAP (any provider), Shared folder/SFTP
- [x] AC-2: All adapters implement a common `EmailAdapter` interface: `fetchEmails(filters)`, `downloadAttachment(emailId)`
- [x] AC-3: Email filters configurable: sender, subject pattern ("Fechamento" OR "Relatorio diario"), has attachment, date range
- [x] AC-4: Listener runs as BullMQ repeatable job at 06:00 daily (configurable via cron expression)
- [x] AC-5: Retry strategy: 06:00, 06:30, 07:00, 07:30 — after 4 failures, dead letter queue + admin alert email

### Attachment Processing
- [x] AC-6: Supports CSV, XLSX, and PDF attachments
- [x] AC-7: CSV/XLSX processed directly via existing ETL pipeline
- [x] AC-8: Attachment is validated (file size limit, correct extension) before processing

### OCR for PDF (FR-060)
- [x] AC-9: PDF attachments are processed via OCR (Tesseract.js or pdf-parse) to extract tabular data
- [x] AC-10: Extracted data converted to CSV format for ETL pipeline consumption
- [x] AC-11: OCR confidence score reported; low-confidence rows flagged for manual review

### Configuration
- [x] AC-12: Email listener configuration page at `/automacao` with adapter selection, credentials, and filter rules
- [x] AC-13: Cron schedule configurable (default: `0 6 * * *`)

### Monitoring
- [x] AC-14: Execution log showing: timestamp, emails found, attachments processed, rows ingested, errors
- [x] AC-15: `/automacao/log` page displaying recent execution history

### Testing
- [x] AC-16: Backend unit tests for email adapters and attachment processing (80%+ coverage)
- [x] AC-17: Frontend render tests for configuration and log pages

## Dev Notes

### Adapter Pattern

```typescript
interface EmailAdapter {
  fetchEmails(filters: EmailFilters): Promise<EmailMessage[]>;
  downloadAttachment(messageId: string, attachmentId: string): Promise<Buffer>;
  testConnection(): Promise<boolean>;
}

class GmailAdapter implements EmailAdapter { ... }  // Google OAuth2
class ImapAdapter implements EmailAdapter { ... }    // imapflow
class SftpAdapter implements EmailAdapter { ... }    // Folder monitoring
```

### BullMQ Job Configuration

```typescript
// Repeatable job at 06:00 daily
await emailQueue.add('daily-email-check', {}, {
  repeat: { pattern: '0 6 * * *' },
  attempts: 4,
  backoff: { type: 'fixed', delay: 30 * 60 * 1000 }, // 30 min
});
```

### File Locations

**Backend:**
- `apps/api/src/modules/automation/email/` — EmailAdapter interface + 3 implementations
- `apps/api/src/modules/automation/email/email-listener.processor.ts` — BullMQ processor
- `apps/api/src/modules/automation/ocr/` — PDF OCR service

**Frontend:**
- `apps/web/src/app/automacao/components/email-config.tsx`
- `apps/web/src/app/automacao/log/page.tsx`

---

## Tasks / Subtasks

- [x] **Task 1: Create EmailAdapter interface and Gmail adapter** (AC: 1, 2, 3)
- [x] **Task 2: Implement IMAP and SFTP adapters** (AC: 1, 2)
- [x] **Task 3: Create BullMQ email listener job with retry** (AC: 4, 5)
- [x] **Task 4: Implement attachment processing pipeline** (AC: 6, 7, 8)
- [x] **Task 5: Implement PDF OCR service** (AC: 9, 10, 11)
- [x] **Task 6: Create email configuration UI** (AC: 12, 13)
- [x] **Task 7: Create execution log page** (AC: 14, 15)
- [x] **Task 8: Write backend unit tests** (AC: 16)
- [x] **Task 9: Write frontend render tests** (AC: 17)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/automation/email/email-adapter.interface.ts` | Created | EmailAdapter interface, types, configs |
| `apps/api/src/modules/automation/email/gmail.adapter.ts` | Created | Gmail OAuth2 adapter |
| `apps/api/src/modules/automation/email/imap.adapter.ts` | Created | IMAP adapter (imapflow) |
| `apps/api/src/modules/automation/email/sftp-email.adapter.ts` | Created | SFTP folder adapter |
| `apps/api/src/modules/automation/email/email-adapter.factory.ts` | Created | Factory for email adapters |
| `apps/api/src/modules/automation/email/email-listener.service.ts` | Created | Orchestration service |
| `apps/api/src/modules/automation/email/email-listener.processor.ts` | Created | BullMQ job processor |
| `apps/api/src/modules/automation/email/email-listener.controller.ts` | Created | REST controller |
| `apps/api/src/modules/automation/ocr/pdf-ocr.service.ts` | Created | PDF OCR via pdf-parse |
| `apps/api/src/modules/automation/dto/email-config.dto.ts` | Created | DTOs with class-validator |
| `apps/api/src/modules/automation/automation.module.ts` | Modified | Registered BullMQ queue + email components |
| `apps/api/package.json` | Modified | Added @nestjs/bullmq dependency |
| `apps/web/src/types/automation.ts` | Modified | Added email listener types |
| `apps/web/src/hooks/use-email-listener.ts` | Created | React Query hooks for email API |
| `apps/web/src/app/automacao/components/email-config.tsx` | Created | Email config UI component |
| `apps/web/src/app/automacao/log/page.tsx` | Created | Execution log page |
| `apps/web/src/app/automacao/page.tsx` | Modified | Added tabbed layout with email section |
| `apps/api/src/modules/automation/email/email-listener.service.spec.ts` | Created | Service unit tests (8 cases) |
| `apps/api/src/modules/automation/email/email-listener.controller.spec.ts` | Created | Controller unit tests (6 cases) |
| `apps/api/src/modules/automation/ocr/pdf-ocr.service.spec.ts` | Created | OCR service unit tests (8 cases) |
| `apps/api/src/modules/automation/email/gmail.adapter.spec.ts` | Created | Gmail adapter unit tests (4 cases) |
| `apps/api/src/modules/automation/email/imap.adapter.spec.ts` | Created | IMAP adapter unit tests (4 cases) |
| `apps/api/src/modules/automation/email/sftp-email.adapter.spec.ts` | Created | SFTP adapter unit tests (5 cases) |
| `apps/web/src/app/automacao/__tests__/email-config.test.tsx` | Created | Email config render tests (9 cases) |
| `apps/web/src/app/automacao/__tests__/email-log-page.test.tsx` | Created | Log page render tests (7 cases) |

---

## Dependencies

- Story 4.1: Ingestion Mapping Templates (applies templates to attachments)
- Story 4.2: ERP Connector (shared automation module infrastructure)
- Story 2.8: BullMQ Integration (job queue infrastructure)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Full implementation: adapters, OCR, BullMQ, frontend, tests | Dex (Dev) |
| 2026-02-27 | 0.3 | QA fixes: credential masking, path traversal, ReDoS, token expiry, immutability | Dex (Dev) |
| 2026-02-27 | 0.4 | QA Gate fixes: Gmail tests (axios mock), IMAP testConnection, processEmails happy-path test, BullMQ failed event handler | Dex (Dev) |
