# Story 4.6: Daily Automated Pipeline

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** a fully automated daily pipeline that runs ingestion, forecast inference, MRP recalculation, and alert generation every morning,
**so that** I start each workday with fresh data and actionable insights.

## References

- FR-052: Daily Automated Pipeline
- [Source: architecture/9-integration-patterns.md]

## Acceptance Criteria

### Pipeline Steps (FR-052)
- [x] AC-1: 06:00 — Email listener checks inbox (or ERP connector fetches data)
- [x] AC-2: 06:02 — Download and process attachment (CSV/XLSX/PDF)
- [x] AC-3: 06:05 — Apply saved mapping template and execute incremental ETL
- [x] AC-4: 06:10 — Update inventory (if stock position data available)
- [x] AC-5: 06:11 — Run incremental forecast inference (no training, inference only)
- [x] AC-6: 06:15 — Run incremental MRP recalculation
- [x] AC-7: 06:16 — Check alerts (stockout, urgent purchases, overload, forecast deviation)
- [x] AC-8: 06:17 — Send daily summary email

### Orchestration
- [x] AC-9: Pipeline orchestrator manages step dependencies and sequential execution
- [x] AC-10: Each step reports progress via EventEmitter2 + SSE (adapted from ProgressReporter pattern)
- [x] AC-11: If a step fails, pipeline continues with remaining steps that don't depend on the failed step
- [x] AC-12: Pipeline execution logged with per-step timing, status, and error details

### Graceful Degradation
- [x] AC-13: If email/ERP fetch fails: skip ingestion, run forecast + MRP with existing data, include failure in alerts
- [x] AC-14: If forecast inference fails: skip forecast, run MRP with last known forecast, include failure in alerts
- [x] AC-15: If MRP fails: still generate alerts from last known MRP results

### Configuration
- [x] AC-16: Pipeline schedule configurable via cron expression (default: `0 6 * * 1-5` weekdays)
- [x] AC-17: Each step can be individually enabled/disabled in `config_sistema`

### Monitoring
- [x] AC-18: `/automacao/pipeline` page shows pipeline execution history with per-step status
- [x] AC-19: Real-time pipeline progress visible via SSE on the automation page

### API
- [x] AC-20: `POST /automation/pipeline/trigger` — manually trigger the daily pipeline
- [x] AC-21: `GET /automation/pipeline/status` — get current pipeline execution status
- [x] AC-22: `GET /automation/pipeline/history` — list past executions (paginated)

### Testing
- [x] AC-23: Backend unit tests for pipeline orchestrator and step coordination (80%+ coverage)
- [x] AC-24: Frontend render tests for pipeline monitoring components

## Dev Notes

### Pipeline Orchestrator

```typescript
const DAILY_PIPELINE_STEPS = [
  { id: 'fetch-data',    service: 'EmailListenerService',  method: 'fetchAndProcess', dependsOn: [] },
  { id: 'etl',           service: 'IngestionService',      method: 'runIncrementalEtl', dependsOn: ['fetch-data'] },
  { id: 'update-stock',  service: 'InventoryService',      method: 'updateFromIngestion', dependsOn: ['etl'] },
  { id: 'forecast',      service: 'ForecastService',       method: 'runInference', dependsOn: [] },
  { id: 'mrp',           service: 'MrpService',            method: 'runIncremental', dependsOn: [] },
  { id: 'alerts',        service: 'NotificacaoService',    method: 'runAlertDetection', dependsOn: [] },
  { id: 'email',         service: 'DailySummaryService',   method: 'sendSummary', dependsOn: ['alerts'] },
];
```

### Design Decisions
- **SSE instead of WebSocket** for AC-19: NestJS codebase has no WebSocket gateway. SSE via `@Sse()` decorator achieves real-time progress with simpler infrastructure.
- **EventEmitter2** for progress: In-process event bus + in-memory subscriber Set per execution. Follows the existing NotificacaoService callback pattern.
- **Dependency relaxation** for graceful degradation: forecast/mrp/alerts have empty `dependsOn` arrays, so they always attempt execution even when ingestion steps fail. Only `etl` depends on `fetch-data`, `update-stock` on `etl`, and `email` on `alerts`.

### File Locations

**Backend:**
- `apps/api/src/modules/automation/pipeline/` — orchestrator, step definitions, processor
- `apps/api/src/modules/automation/pipeline/pipeline.processor.ts` — BullMQ job processor

**Frontend:**
- `apps/web/src/app/automacao/pipeline/page.tsx` — pipeline monitoring page
- `apps/web/src/hooks/use-pipeline.ts` — React Query hooks

---

## Tasks / Subtasks

- [x] **Task 1: Create pipeline orchestrator with step dependency management** (AC: 9, 10, 11, 12)
- [x] **Task 2: Implement BullMQ daily pipeline job** (AC: 1-8, 16)
- [x] **Task 3: Add graceful degradation for step failures** (AC: 13, 14, 15)
- [x] **Task 4: Create pipeline API endpoints** (AC: 17, 20, 21, 22)
- [x] **Task 5: Implement pipeline monitoring UI** (AC: 18, 19)
- [x] **Task 6: Write backend unit tests** (AC: 23)
- [x] **Task 7: Write frontend render tests** (AC: 24)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added PIPELINE_DIARIO to TipoExecucao |
| `apps/api/prisma/migrations/20260228020000_add_pipeline_type/migration.sql` | Created | Migration SQL for new enum value |
| `apps/api/src/modules/automation/automation.module.ts` | Modified | Registered daily-pipeline queue, PipelineController, PipelineService, PipelineRepository, PipelineProcessor |
| `apps/api/src/modules/automation/pipeline/pipeline.types.ts` | Created | PipelineStepId, PipelineStatus, PipelineConfig, PipelineExecution, PipelineProgressEvent, constants |
| `apps/api/src/modules/automation/pipeline/pipeline-steps.ts` | Created | 7 step definitions with dependencies, shouldSkipStep helper |
| `apps/api/src/modules/automation/pipeline/dto/filter-pipeline.dto.ts` | Created | FilterPipelineDto extending PaginationDto with sortBy allowlist |
| `apps/api/src/modules/automation/pipeline/pipeline.repository.ts` | Created | Data access layer for ExecucaoPlanejamento + ExecucaoStepLog (PIPELINE_DIARIO) |
| `apps/api/src/modules/automation/pipeline/pipeline.service.ts` | Created | Pipeline orchestrator with graceful degradation, config management, progress events |
| `apps/api/src/modules/automation/pipeline/pipeline.controller.ts` | Created | REST endpoints: POST trigger, GET status, GET history, GET :id, SSE :id/progress |
| `apps/api/src/modules/automation/pipeline/pipeline.processor.ts` | Created | BullMQ processor with ConflictException handling for repeatable jobs |
| `apps/api/src/modules/automation/pipeline/pipeline.service.spec.ts` | Created | Service unit tests (23 tests) |
| `apps/api/src/modules/automation/pipeline/pipeline.controller.spec.ts` | Created | Controller unit tests (6 tests) |
| `apps/web/src/types/pipeline.ts` | Created | Frontend types, labels, status colors |
| `apps/web/src/hooks/use-pipeline.ts` | Created | React Query hooks (usePipelineStatus, usePipelineHistory, usePipelineDetail, useTriggerPipeline, useSSEProgress) |
| `apps/web/src/app/automacao/pipeline/page.tsx` | Created | Pipeline monitoring page with status card, trigger button, SSE step progress, history table |
| `apps/web/src/app/automacao/pipeline/__tests__/pipeline-page.test.tsx` | Created | Frontend render tests (14 tests) |
| `apps/api/src/generated/prisma/` | Regenerated | Prisma client regenerated with PIPELINE_DIARIO + PARCIAL enums |

---

## Dependencies

- Story 4.1: Ingestion Mapping Templates (ETL step uses templates)
- Story 4.2: ERP Connector (data fetch step)
- Story 4.3: Email Listener (email fetch step)
- Story 4.4: Alert System (alert detection step)
- Story 4.5: Re-training Cycle Management (cycle coordination)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-28 | 0.2 | Schema, types, steps, repository, service, controller, processor, frontend, tests — all 24 ACs implemented | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: Roles import path, try/catch guard for dangling RUNNING records, simplified syncRepeatableJob, UUID validation on SSE endpoint, extracted shared PIPELINE_STATUS_MAP | Dex (Dev) |
| 2026-02-28 | 0.4 | QA fixes: ran prisma generate (removed `as any` casts), implemented useSSEProgress hook for real-time AC-19, added onComplete/emitCompletion for SSE stream termination, added SSE controller test | Dex (Dev) |
