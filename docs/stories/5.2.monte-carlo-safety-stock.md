# Story 5.2: Monte Carlo Safety Stock Simulation

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** Monte Carlo simulation for safety stock calculation on Class A SKUs,
**so that** I get more accurate safety stock levels that account for non-normal demand distributions and lead time variability.

## References

- FR-065: Monte Carlo Safety Stock (Class A)
- [Source: PRD §4.6 — Epic 5]
- [Story 3.3: Stock Parameter Calculation — existing SS infrastructure]

## Acceptance Criteria

### Monte Carlo Simulation Engine
- [x] AC-1: Implement Monte Carlo simulation in StockParamsService with configurable iterations (default 10,000)
- [x] AC-2: Simulation samples demand from historical distribution (52 weeks from SerieTemporal)
- [x] AC-3: Simulation samples lead time from normal distribution (mean=LT, stddev=σ_LT)
- [x] AC-4: For each iteration: total_demand = sum of sampled daily demands over sampled lead time
- [x] AC-5: SS = quantile(total_demand, service_level) - mean(total_demand)
- [x] AC-6: Only applies to Class A SKUs (from SkuClassification.classeAbc = 'A')

### Integration
- [x] AC-7: StockParamsService.calculateForProduct detects Class A → uses Monte Carlo
- [x] AC-8: Falls back to classical formula if insufficient historical data (<12 weeks)
- [x] AC-9: Stores result with metodoCalculo = 'MONTE_CARLO' in ParametrosEstoque
- [x] AC-10: Manual override (estoqueSegurancaManual) still takes precedence

### API Endpoint
- [x] AC-11: `POST /mrp/stock-params/monte-carlo?produtoId=X` — trigger simulation for a specific product
- [x] AC-12: Response includes: safetyStock, iterations, confidenceInterval (p5, p95), histogram buckets

### Frontend
- [x] AC-13: Monte Carlo result badge on stock parameters display (when metodoCalculo = MONTE_CARLO)
- [x] AC-14: Simulation histogram visualization showing demand distribution

### Testing
- [x] AC-15: Unit tests for Monte Carlo engine with seeded RNG for determinism
- [x] AC-16: Unit tests for Class A detection and fallback
- [x] AC-17: Frontend render tests for Monte Carlo badge

---

## Tasks / Subtasks

- [x] **Task 1: Implement Monte Carlo simulation engine** (AC: 1-5)
- [x] **Task 2: Integrate with StockParamsService** (AC: 6-10)
- [x] **Task 3: Create API endpoint** (AC: 11, 12)
- [x] **Task 4: Create frontend components** (AC: 13, 14)
- [x] **Task 5: Write backend tests** (AC: 15, 16)
- [x] **Task 6: Write frontend tests** (AC: 17)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/stock-params.interface.ts` | Modified | Add MONTE_CARLO to StockCalcMethod, add MonteCarloInput/Result/HistogramBucket interfaces |
| `apps/api/src/modules/mrp/engine/stock-params.service.ts` | Modified | Add calculateSafetyStockMonteCarlo, runMonteCarloSimulation, Class A detection in calculateForProduct, seeded RNG, Box-Muller sampling, quantile computation, histogram builder |
| `apps/api/src/modules/mrp/engine/stock-params.service.spec.ts` | Modified | 16 new Monte Carlo tests (8 engine + 6 Class A detection + 2 endpoint), added skuClassification mock |
| `apps/api/src/modules/mrp/mrp.controller.ts` | Modified | Add POST /mrp/stock-params/monte-carlo endpoint |
| `apps/api/src/modules/mrp/mrp.service.ts` | Modified | Add runMonteCarloSimulation delegator method |
| `apps/api/src/modules/mrp/dto/monte-carlo-simulation.dto.ts` | Created | MonteCarloSimulationDto with @IsUUID, optional serviceLevel/iterations |
| `apps/web/src/hooks/use-monte-carlo.ts` | Created | useMonteCarloSimulation React Query mutation hook |
| `apps/web/src/components/mrp/monte-carlo-badge.tsx` | Created | MonteCarloSimulation component with badge, metric cards, histogram visualization |
| `apps/web/src/components/mrp/__tests__/monte-carlo-badge.test.tsx` | Created | 8 frontend render tests for Monte Carlo badge |
| `apps/web/src/app/mrp/detail/page.tsx` | Modified | Add MonteCarloSimulation component to MRP detail page |

---

## Dependencies

- Story 3.3: Stock Parameter Calculation (existing infrastructure)
- Story 1.11: SKU Classification (ABC class data)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — Monte Carlo SS | River (SM) |
| 2026-02-28 | 0.2 | Full implementation: Monte Carlo simulation engine with seeded mulberry32 RNG, Box-Muller normal sampling, empirical demand sampling, quantile computation, histogram builder. Class A detection via SkuClassification, fallback for <12 weeks history. POST endpoint, frontend badge+histogram component, 16 backend + 8 frontend tests (17/17 ACs) | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: typed getAbcClass return as 'A'|'B'|'C'|null, consolidated double serieTemporal query into single getDemandHistory + computeDemandStatistics for Class A products | Quinn (QA) |
