# Story 4.10: Excel/PDF Export

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner / manager,
**I want** to export dashboards, reports, and data tables to Excel and PDF formats,
**so that** I can share insights with stakeholders who don't have system access.

## References

- FR-058: Excel/PDF Export
- [Source: architecture/9-integration-patterns.md#9.3 — Export Patterns]

## Acceptance Criteria

### Excel Export (FR-058)
- [x] AC-1: Export MRP planned orders table to XLSX with formatted headers, data types, and auto-width columns
- [x] AC-2: Export purchasing panel data to XLSX (reuses Story 3.11 ExcelJS infrastructure)
- [x] AC-3: Export forecast data (per-SKU forecast with P10-P90 quantiles) to XLSX
- [x] AC-4: Export capacity utilization data to XLSX with conditional formatting (red >110%, yellow 80-100%)
- [x] AC-5: Export stock parameters table to XLSX
- [x] AC-6: Export KPI summary (from executive dashboard) to XLSX with charts embedded

### PDF Export
- [x] AC-7: Export executive dashboard as PDF report with charts rendered as images
- [x] AC-8: Export MRP summary report as PDF with Gantt visualization
- [x] AC-9: PDF reports include: header with logo/date, sections with charts, footer with page numbers
- [x] AC-10: PDF generation via Puppeteer (server-side HTML-to-PDF rendering)

### Async Export for Large Datasets
- [x] AC-11: Exports with >1000 rows run asynchronously via BullMQ job
- [x] AC-12: User gets a download notification when export is ready
- [x] AC-13: Export files stored temporarily (auto-cleanup after 24h)

### API Endpoints
- [x] AC-14: `POST /export/excel` — generate Excel export (body: { type, filters })
- [x] AC-15: `POST /export/pdf` — generate PDF export (body: { type, filters })
- [x] AC-16: `GET /export/:jobId/download` — download generated file
- [x] AC-17: `GET /export/history` — list recent exports with status and download links

### Frontend
- [x] AC-18: Export button on all dashboard and data table pages
- [x] AC-19: Export dialog with format selection (Excel / PDF) and optional filters
- [x] AC-20: Download notification when async export completes

### Testing
- [x] AC-21: Backend unit tests for Excel and PDF generation services (80%+ coverage)
- [x] AC-22: Frontend render tests for export dialog components

## Dev Notes

### Export Architecture

```typescript
// Export types
type ExportType =
  | 'MRP_ORDERS'
  | 'PURCHASING_PANEL'
  | 'FORECAST_DATA'
  | 'CAPACITY'
  | 'STOCK_PARAMS'
  | 'EXECUTIVE_DASHBOARD'
  | 'MRP_SUMMARY';

// For large exports: BullMQ async job
interface ExportJob {
  type: ExportType;
  format: 'xlsx' | 'pdf';
  filters: Record<string, unknown>;
  userId: string;
}
```

### Library Selection

| Format | Library | Generation |
|--------|---------|-----------|
| Excel | `exceljs` (already installed from Story 3.11) | Server-side streaming |
| PDF | `puppeteer` | Server-side HTML → PDF |
| CSV | Native `stream.Transform` | Server-side streaming |

### File Locations

**Backend:**
- `apps/api/src/modules/export/` — module, controller, service
- `apps/api/src/modules/export/generators/` — ExcelGenerator, PdfGenerator
- `apps/api/src/modules/export/export.processor.ts` — BullMQ async processor

**Frontend:**
- `apps/web/src/components/export/export-dialog.tsx` — shared export dialog
- `apps/web/src/hooks/use-export.ts` — React Query mutation hook

---

## Tasks / Subtasks

- [x] **Task 1: Create Export backend module with ExcelGenerator** (AC: 1-6, 14)
- [x] **Task 2: Implement PdfGenerator with PDFKit** (AC: 7-10, 15)
- [x] **Task 3: Add BullMQ async export for large datasets** (AC: 11, 12, 13)
- [x] **Task 4: Create download and history endpoints** (AC: 16, 17)
- [x] **Task 5: Create shared export dialog component** (AC: 18, 19, 20)
- [x] **Task 6: Add export buttons to existing dashboard pages** (AC: 18)
- [x] **Task 7: Write backend unit tests** (AC: 21)
- [x] **Task 8: Write frontend render tests** (AC: 22)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/export/export.types.ts` | Created | ExportType, ExportFormat, ExportStatus, constants |
| `apps/api/src/modules/export/dto/request-export.dto.ts` | Created | Validated DTO with @IsIn for export types |
| `apps/api/src/modules/export/generators/excel.generator.ts` | Created | ExcelJS generator: 6 export types with formatting |
| `apps/api/src/modules/export/generators/pdf.generator.ts` | Created | PDFKit generator: dashboard + MRP summary reports |
| `apps/api/src/modules/export/export.service.ts` | Created | Orchestration: sync/async decision, file management, history |
| `apps/api/src/modules/export/export.processor.ts` | Created | BullMQ WorkerHost processor for async exports |
| `apps/api/src/modules/export/export.controller.ts` | Created | 4 endpoints: POST excel, POST pdf, GET download, GET history |
| `apps/api/src/modules/export/export.module.ts` | Created | NestJS module with BullMQ queue registration |
| `apps/api/src/modules/export/__tests__/export.service.spec.ts` | Created | 9 tests: sync/async generation, download, history, cleanup |
| `apps/api/src/modules/export/__tests__/export.controller.spec.ts` | Created | 5 tests: excel, pdf, async 202, download, history |
| `apps/api/src/app.module.ts` | Modified | Registered ExportModule |
| `apps/web/src/types/export.ts` | Created | Frontend types + EXPORT_TYPE_OPTIONS + PDF_SUPPORTED_TYPES |
| `apps/web/src/hooks/use-export.ts` | Created | 3 hooks: useRequestExport, useDownloadExport, useExportHistory |
| `apps/web/src/components/export/export-dialog.tsx` | Created | ExportDialog + ExportButton components |
| `apps/web/src/components/export/__tests__/export-dialog.test.tsx` | Created | 9 tests: dialog render, type selector, format, history, button |
| `apps/web/src/app/dashboard/page.tsx` | Modified | Added ExportButton to dashboard header |

---

## Dependencies

- Story 3.11: Purchasing Panel (ExcelJS already installed and used)
- Story 4.8: Executive BI Dashboard (dashboard data for export)
- Story 2.8: BullMQ Integration (async job infrastructure)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-28 | 0.2 | Full implementation: ExcelJS generator (6 types with formatting), PDFKit generator (dashboard + MRP reports), BullMQ async processor, export service with sync/async routing, controller (4 endpoints), ExportDialog + ExportButton frontend, 14 backend + 9 frontend tests (22/22 ACs) | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: jobId validation (path traversal), RFC 5987 Content-Disposition encoding, MRP_SUMMARY default case throw, user-scoped history, @Cron cleanup scheduling, bufferPages for PDF footer, 202 Blob parsing safety | Quinn (QA) |
