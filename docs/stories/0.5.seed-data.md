# Story 0.5: Synthetic Seed Data

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["prisma db seed", "typecheck", "lint"]

## Story

**As a** developer,
**I want** a Prisma seed script that populates the database with realistic, coherent synthetic data for all registration, capacity, and configuration tables,
**so that** I can develop and test features against a representative dataset without needing real production data.

## Acceptance Criteria

1. `apps/api/prisma/seed.ts` exists and is executable via `npx prisma db seed`
2. The seed script creates at least 100 products (SKUs) distributed across all `TipoProduto` types: ACABADO, SEMI_ACABADO, INSUMO, EMBALAGEM, MATERIA_PRIMA, REVENDA
3. The seed script creates at least 10 suppliers with realistic lead times (7-90 days), CNPJ format, and varied reliability percentages
4. BOM structures are multi-level (at least 3 levels): finished goods -> semi-finished -> raw materials, with valid `perda_percentual` values
5. Work centers (5 minimum) have associated shifts (2 per center), scheduled stops, and production routings
6. Inventory positions exist for all products across appropriate warehouses with realistic stock levels
7. Factory calendar covers a full year (365 days) with Brazilian holidays, weekends, and working days
8. System configuration (`config_sistema`) is seeded with all default values from PRD Section 3.4
9. Users are seeded: one per role (admin, manager, operator, viewer) with hashed passwords
10. The seed script is idempotent: running it multiple times does not create duplicate data (uses upsert or truncate-and-reseed strategy)
11. All foreign key references are valid: BOM references existing products, `produto_fornecedor` links valid products and suppliers, inventory references valid products and warehouses
12. `npx prisma db seed` completes without errors on a fresh database (after migration)

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Configure Prisma Seed Command** (AC: 1)
  - [x] Add seed configuration to `apps/api/prisma.config.ts` (Prisma 7 uses `prisma.config.ts` instead of `package.json`)
  - [x] Install `tsx` as a dev dependency for running TypeScript seed: `pnpm add -D tsx`
  - [x] Verify `npx prisma db seed` command is recognized

- [x] **Task 2: Create Seed Script Structure** (AC: 1, 10)
  - [x] Create `apps/api/prisma/seed.ts` with full structure using `PrismaClient` from generated client
  - [x] Use `PrismaPg` adapter for Prisma 7 compatibility
  - [x] Implement `cleanDatabase()` using `TRUNCATE ... CASCADE` for idempotency

- [x] **Task 3: Seed Unidades de Medida** (AC: 11)
  - [x] Create 8 units of measure: UN, KG, LT, CX, MT, M2, M3, PCT

- [x] **Task 4: Seed Categorias** (AC: 11)
  - [x] Create 20 categories in a 3-level hierarchy (5 root + 10 L1 + 5 L2)
  - [x] Use self-referencing `paiId` for hierarchy

- [x] **Task 5: Seed Produtos (100+ SKUs)** (AC: 2, 11)
  - [x] Create 100 products distributed by type: 25 ACABADO, 15 SEMI_ACABADO, 25 INSUMO, 10 EMBALAGEM, 20 MATERIA_PRIMA, 5 REVENDA
  - [x] Each product has unique codigo, realistic descricao, valid FK refs, costs, prices, lead times

- [x] **Task 6: Seed Fornecedores (10+)** (AC: 3, 11)
  - [x] Create 12 suppliers with realistic Brazilian data, CNPJ, lead times (7-90 days), confiabilidade

- [x] **Task 7: Seed Produto-Fornecedor Links** (AC: 3, 11)
  - [x] Created 174+ links (2-4 per purchasable product, one isPrincipal per product)

- [x] **Task 8: Seed BOM Structures (Multi-Level)** (AC: 4, 11)
  - [x] Created 179+ BOM entries with 3-level hierarchy: ACABADO → SEMI_ACABADO/INSUMO (L1) → MATERIA_PRIMA/INSUMO (L2), plus packaging
  - [x] 24 ACABADO products with verified 3-level chains (270 total chains)
  - [x] Valid perda_percentual, valido_desde, no circular references

- [x] **Task 9: Seed Depositos** (AC: 6, 11)
  - [x] Created 5 warehouses: DEP-MP, DEP-PA, DEP-WIP, DEP-EXP, DEP-QA with capacity values

- [x] **Task 10: Seed Inventario Atual** (AC: 6, 11)
  - [x] Created 100 inventory positions (one per product in appropriate warehouse)
  - [x] GENERATED columns (quantidade_total, valor_total_estoque) working correctly

- [x] **Task 11: Seed Centros de Trabalho, Turnos, Paradas** (AC: 5)
  - [x] Created 5 work centers, 10 turnos (2 per center), 10 paradas programadas

- [x] **Task 12: Seed Roteiros de Producao** (AC: 5, 11)
  - [x] Created 145 routing entries (4 steps/ACABADO, 3 steps/SEMI_ACABADO)

- [x] **Task 13: Seed Calendario Fabrica (Full Year)** (AC: 7)
  - [x] Created 365 days for 2026 with all 12 Brazilian holidays, férias coletivas (23-31/12)
  - [x] Weekdays UTIL (8h), Saturdays SABADO (0h), Sundays DOMINGO (0h)

- [x] **Task 14: Seed Config Sistema** (AC: 8)
  - [x] Created 9 configuration entries matching PRD Section 3.4

- [x] **Task 15: Seed Usuarios** (AC: 9)
  - [x] Created 4 users (admin, manager, operator, viewer) with bcrypt-hashed passwords
  - [x] Installed bcryptjs and @types/bcryptjs

- [x] **Task 16: Validate Seed End-to-End** (AC: 10, 11, 12)
  - [x] `npx prisma db seed` completes without errors
  - [x] No FK violation errors
  - [x] Record counts verified: Produtos 100, Fornecedores 12, BOM 179+, CT 5, Turnos 10, Depositos 5, Inventario 100, Calendario 365, Config 9, Usuarios 4
  - [x] Seed run twice — idempotency confirmed (counts identical)
  - [x] All 6 product types represented
  - [x] BOM multi-level structure verified (24 ACABADO with 3-level chains)

## Dev Notes

### Architecture Reference
[Source: docs/architecture/6-data-architecture.md, Section 6.6]

The seed data volumes and approach come from the data architecture document. For this story (dev environment), we use a reduced dataset (100 SKUs minimum) compared to the full 1,000 SKUs specified for later phases.

### Seed Data Volume (This Story)

| Entity | Target Volume | Notes |
|--------|--------------|-------|
| Categorias | 15 | 3-level hierarchy |
| Unidades de medida | 8 | UN, KG, LT, CX, MT, M2, M3, PCT |
| Produtos | 100+ | Distributed across all 6 types |
| Fornecedores | 10+ | With realistic lead times (7-90 days) |
| Produto-Fornecedor | 100+ | 2-4 suppliers per purchasable product |
| BOM | 50+ | 3-level structures for finished goods |
| Centros de trabalho | 5 | PRODUCAO x2, EMBALAGEM, MONTAGEM, CQ |
| Turnos | 10 | 2 shifts per center |
| Paradas programadas | 10-15 | 2-3 per center |
| Roteiros de producao | 50+ | 3-4 steps per ACABADO product |
| Depositos | 5 | By warehouse type |
| Inventario | 100+ | One position per product |
| Calendario fabrica | 365 | Full year 2026 with holidays |
| Config sistema | 9+ | Default configuration values from PRD |
| Usuarios | 4 | One per role |

### Data Coherence Rules

These rules MUST be followed to ensure referential integrity:

1. **BOM only references existing products**: `produto_pai_id` must point to ACABADO or SEMI_ACABADO. `produto_filho_id` must point to SEMI_ACABADO, INSUMO, MATERIA_PRIMA, or EMBALAGEM.
2. **No circular BOM references**: A product cannot be both parent and child of itself (directly or indirectly).
3. **Produto-fornecedor only for purchasable types**: INSUMO, MATERIA_PRIMA, EMBALAGEM, and REVENDA products need suppliers. ACABADO and SEMI_ACABADO are manufactured (may also have some supplier links).
4. **Each purchasable product has exactly one `is_principal = true` supplier**.
5. **Inventory warehouses match product type**: Raw materials go to DEP-MP, finished goods to DEP-PA, WIP to DEP-WIP.
6. **Routing sequences are contiguous**: Operations numbered 10, 20, 30 (increments of 10 for easy insertion).
7. **Calendar dates are unique**: No duplicate dates in `calendario_fabrica`.
8. **Shift times do not overlap** within the same work center.

### Idempotency Strategy

Use `TRUNCATE ... CASCADE` at the beginning of the seed script to ensure clean state:

```typescript
async function cleanDatabase() {
  const tablenames = await prisma.$queryRaw<Array<{ tablename: string }>>`
    SELECT tablename FROM pg_tables WHERE schemaname = 'public'
  `;

  for (const { tablename } of tablenames) {
    if (tablename === '_prisma_migrations') continue;
    await prisma.$executeRawUnsafe(`TRUNCATE TABLE "public"."${tablename}" CASCADE;`);
  }
}
```

This approach:
- Preserves the migration history table
- Handles FK dependencies via CASCADE
- Allows the seed to be run any number of times

### Password Hashing

Use `bcryptjs` (pure JavaScript, no native deps) for password hashing:

```typescript
import * as bcrypt from 'bcryptjs';

const hashedPassword = await bcrypt.hash('ForecastMRP2026!', 10);
```

The default dev password (`ForecastMRP2026!`) is only for the seed script. Production uses a different auth flow.

### Brazilian Holidays 2026

The following dates should be marked as FERIADO or PONTO_FACULTATIVO:

| Date | Holiday | Type |
|------|---------|------|
| 2026-01-01 | Confraternizacao Universal | FERIADO |
| 2026-02-17 | Carnaval (Terca) | FERIADO |
| 2026-02-18 | Quarta de Cinzas (ate 12h) | PONTO_FACULTATIVO |
| 2026-04-03 | Sexta-feira Santa | FERIADO |
| 2026-04-21 | Tiradentes | FERIADO |
| 2026-05-01 | Dia do Trabalho | FERIADO |
| 2026-06-04 | Corpus Christi | FERIADO |
| 2026-09-07 | Independencia do Brasil | FERIADO |
| 2026-10-12 | Nossa Senhora Aparecida | FERIADO |
| 2026-11-02 | Finados | FERIADO |
| 2026-11-15 | Proclamacao da Republica | FERIADO |
| 2026-12-25 | Natal | FERIADO |

### Prisma Seed Configuration
[Source: Prisma docs]

Add to `apps/api/package.json`:
```json
{
  "prisma": {
    "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
  }
}
```

### Dependencies

This story depends on:
- **Story 0.3** (Database Schema & Prisma Setup) -- must be completed first so that all models exist

### Pre-existing Files

The following files ALREADY EXIST and should be UPDATED:
- `apps/api/package.json` -- Add prisma.seed config and bcryptjs dependency
- `apps/api/prisma/schema.prisma` -- Already exists from Story 0.3

The following files should be CREATED:
- `apps/api/prisma/seed.ts` -- Main seed script

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story created during greenfield-fullstack workflow engine | River (SM) |
| 2026-02-25 | 0.2 | Implementation complete: all 16 tasks done, seed script validated | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (@dev / Dex)

### Debug Log References
- `npx prisma db seed`: completed successfully (first run and idempotency re-run)
- Record counts verified via psql: 15 tables populated with expected volumes
- BOM 3-level chain verified: 24 ACABADO products with ACABADO → SEMI_ACABADO → MATERIA_PRIMA chains
- GENERATED columns (quantidade_total, valor_total_estoque) verified working in inventario_atual
- Brazilian holidays 2026: 12 feriados + férias coletivas 23-31/12 confirmed

### Completion Notes List
- Used Prisma 7 `prisma.config.ts` seed configuration instead of `package.json` prisma.seed (Prisma 7 change)
- Used `tsx` runner instead of `ts-node` (simpler, no compiler-options needed)
- Import path: `../src/generated/prisma/client` (Prisma 7 generates `client.ts` instead of `index.ts`)
- Used `PrismaPg` adapter from `@prisma/adapter-pg` for Prisma 7 direct database connections
- 20 categories created (5 root + 10 L1 + 5 L2) instead of 15 from story spec — more realistic hierarchy
- Seed is fully idempotent via TRUNCATE CASCADE strategy
- All 12 Brazilian national holidays for 2026 included with correct dates (Easter-dependent holidays calculated)

### File List

**Created:**
- `apps/api/prisma/seed.ts` — Complete seed script with 15 seed functions covering all 26 tables

**Modified:**
- `apps/api/prisma.config.ts` — Added seed command: `tsx prisma/seed.ts`
- `apps/api/package.json` — Added dependencies: bcryptjs, @types/bcryptjs, tsx

## QA Results
(To be populated by QA agent)
