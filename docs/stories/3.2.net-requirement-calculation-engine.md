# Story 3.2: Net Requirement Calculation Engine

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** a net requirement calculation engine that computes gross-to-net requirements per SKU per period,
**so that** the MRP engine can determine exactly what needs to be ordered or produced after accounting for available stock and scheduled receipts.

## References

- FR-049: Net Requirement Calculation Engine
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/net-requirement.service.ts]

## Acceptance Criteria

- [x] AC-1: NetRequirementService calculates net requirements using the formula: `Net = Gross - Available Stock - Scheduled Receipts + Safety Stock`
- [x] AC-2: For each SKU and period, the service outputs: gross requirement, scheduled receipts, projected available stock, net requirement
- [x] AC-3: Net requirement is floored to 0 (never negative — if supply exceeds demand, net = 0 and excess carries forward as projected stock)
- [x] AC-4: Projected stock at end of period = projected stock at start + scheduled receipts - gross requirement + planned order receipts
- [x] AC-5: Safety stock acts as a lower bound: if projected stock would drop below SS, a net requirement is generated to bring it back to SS
- [x] AC-6: The service accepts an array of periods (weekly buckets) and returns the MRP grid (time-phased array) per SKU
- [x] AC-7: Available stock is read from inventario_atual (quantidadeDisponivel - quantidadeReservada)
- [x] AC-8: Scheduled receipts are read from existing OrdemPlanejada with status FIRME or LIBERADA and dataRecebimentoEsperado in the period
- [x] AC-9: The service is a pure calculation service with no side effects (does not persist results — caller persists)
- [x] AC-10: Unit tests >= 80% coverage with test cases covering: zero demand, demand exceeds stock, safety stock trigger, multi-period carry-forward

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/net-requirement.service.ts]

### Core Formula (FR-049)
```
For each SKU, for each period t:
  grossRequirement[t]    = demand from MPS or BOM explosion
  scheduledReceipts[t]   = orders already FIRME/LIBERADA arriving in period t
  projectedStock[t]      = projectedStock[t-1] + scheduledReceipts[t] - grossRequirement[t] + plannedOrderReceipts[t]
  netRequirement[t]      = MAX(0, grossRequirement[t] - projectedStock[t-1] - scheduledReceipts[t] + safetyStock)

  If projectedStock[t] < safetyStock AND netRequirement[t] == 0:
    netRequirement[t] = safetyStock - projectedStock[t]
```

### Data Structures (TypeScript interfaces)

```typescript
interface MrpGridRow {
  produtoId: string;
  periods: MrpPeriodBucket[];
}

interface MrpPeriodBucket {
  periodStart: Date;       // start of weekly bucket
  periodEnd: Date;         // end of weekly bucket
  grossRequirement: number;
  scheduledReceipts: number;
  projectedStock: number;
  netRequirement: number;
  plannedOrderReceipts: number;  // filled later by lot-sizing
}

interface NetRequirementInput {
  produtoId: string;
  initialStock: number;     // from inventario_atual
  safetyStock: number;      // from parametros_estoque or FR-035 calculation
  periods: {
    periodStart: Date;
    periodEnd: Date;
    grossRequirement: number;
    scheduledReceipts: number;
  }[];
}
```

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/engine/net-requirement.service.ts`
- `apps/api/src/modules/mrp/engine/net-requirement.service.spec.ts`
- `apps/api/src/modules/mrp/engine/interfaces/mrp-grid.interface.ts`

### Testing Requirements

Test cases:
1. Zero demand across all periods: net requirement = 0, projected stock = initial stock
2. Single period with demand < available stock: net = 0, projected stock decreases
3. Single period with demand > available stock: net = demand - stock + SS
4. Multi-period carry-forward: excess stock carries to next period
5. Safety stock trigger: projected stock drops below SS, net requirement generated
6. Scheduled receipts reduce net requirement
7. All-zero inputs: no errors, all outputs zero
8. Large numbers: no precision loss with Decimal handling

### Technical Constraints
- RULE: Net = Gross - Available Stock - Scheduled Receipts + Safety Stock
- Net requirement is NEVER negative (floor to 0)
- Projected stock can be negative only temporarily in intermediate calculations; the lot-sizing step (Story 3.5) will ensure planned orders fill the gap
- This service is STATELESS and PURE — receives inputs, returns outputs, no database writes
- All monetary/quantity calculations must use number type with explicit rounding to 4 decimal places

---

## Tasks / Subtasks

- [x] **Task 1: Define MRP Grid interfaces** (AC: 2, 6)
  - [x] Create `mrp-grid.interface.ts` with MrpGridRow, MrpPeriodBucket, NetRequirementInput interfaces (readonly props, JSDoc)

- [x] **Task 2: Implement NetRequirementService** (AC: 1-6, 9)
  - [x] `calculateNetRequirements(input: NetRequirementInput): MrpGridRow`
  - [x] Implement period-by-period loop with carry-forward projected stock
  - [x] Floor net requirement to 0
  - [x] Safety stock check: if projected stock < SS, generate additional net requirement

- [x] **Task 3: Implement inventory stock helper** (AC: 7)
  - [x] Method to read available stock from inventario_atual: quantidadeDisponivel - quantidadeReservada
  - [x] Aggregate across all depositos for a given produtoId
  - [x] Batch version `getAvailableStockBatch()` using groupBy for efficiency

- [x] **Task 4: Implement scheduled receipts helper** (AC: 8)
  - [x] Method to query OrdemPlanejada WHERE status IN (FIRME, LIBERADA) AND dataRecebimentoEsperado BETWEEN periodStart AND periodEnd
  - [x] Sum quantities per period
  - [x] Multi-period and batch versions for efficiency

- [x] **Task 5: Write comprehensive unit tests** (AC: 10)
  - [x] 32 unit tests covering all 10 ACs (95% coverage)
  - [x] Edge case: empty periods array
  - [x] Edge case: initial stock = 0, safety stock > 0
  - [x] Immutability and determinism verification tests

- [x] **Task 6: Register service in MRP module** (AC: all)
  - [x] Created `apps/api/src/modules/mrp/mrp.module.ts`
  - [x] Registered NetRequirementService, MrpInventoryHelper, MrpScheduledReceiptsHelper
  - [x] Updated `app.module.ts` to import MrpModule

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/mrp-grid.interface.ts` | Created | MRP grid interfaces (MrpGridRow, MrpPeriodBucket, NetRequirementInput) |
| `apps/api/src/modules/mrp/engine/net-requirement.service.ts` | Created | Pure calculation engine — FR-049 formula |
| `apps/api/src/modules/mrp/engine/mrp-inventory.helper.ts` | Created | Reads available stock from InventarioAtual |
| `apps/api/src/modules/mrp/engine/mrp-scheduled-receipts.helper.ts` | Created | Reads scheduled receipts from OrdemPlanejada |
| `apps/api/src/modules/mrp/mrp.module.ts` | Created | MRP NestJS module |
| `apps/api/src/modules/mrp/engine/net-requirement.service.spec.ts` | Created | 32 unit tests (95% coverage) |
| `apps/api/src/app.module.ts` | Modified | Added MrpModule import |

---

## Dependencies

- Story 0.3: Database Schema (InventarioAtual, OrdemPlanejada models)
- Story 1.9: Warehouse & Inventory Management (inventario_atual data available)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-26 | 0.2 | Implementation complete — 6 files created, 1 modified, 32 tests (95% coverage) | Dex (Dev) |
| 2026-02-26 | 0.3 | QA Review PASS — 10/10 AC verified, formula manually traced, 0 critical issues | Quinn (QA) |
