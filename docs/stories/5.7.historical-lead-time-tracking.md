# Story 5.7: Historical Lead Time Tracking

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** supply chain planner,
**I want** to track actual lead times per supplier-product pair,
**so that** I can compute accurate lead time variance (sigma_LT) from historical data instead of relying on min/max approximations.

## References

- FR-070: Historical Lead Time Tracking
- [Source: PRD §4 — Track actual lead times per supplier for sigma_LT calculation]
- [Story 3.3: Stock Parameter Calculation — currently uses (max-min)/6 approximation]
- [StockParamsService.getSupplierLeadTime() — integration point]

## Acceptance Criteria

### Schema
- [x] AC-1: New `HistoricoLeadTime` model — tracks actual delivery lead times per supplier-product
- [x] AC-2: Fields: produtoFornecedorId (FK), leadTimeRealDias, leadTimePlanejadoDias, dataEntrega, pedidoRef, observacao
- [x] AC-3: Index on (produtoFornecedorId, dataEntrega) for efficient queries

### Service (NestJS)
- [x] AC-4: LeadTimeTrackingService.record() — records a new lead time observation
- [x] AC-5: LeadTimeTrackingService.getHistory() — returns paginated history for a supplier-product
- [x] AC-6: LeadTimeTrackingService.calculateStats() — computes mean, stddev, min, max, count from historical data
- [x] AC-7: LeadTimeTrackingService.getSigmaLt() — returns sigma_LT for a product (used by StockParamsService)

### Integration
- [x] AC-8: StockParamsService.getSupplierLeadTime() prefers computed sigma from historical data over (max-min)/6 approximation when sufficient data exists (>=5 observations)

### API Endpoints
- [x] AC-9: `POST /lead-times` — record a new lead time observation (operator role)
- [x] AC-10: `GET /lead-times/:produtoFornecedorId` — get history with pagination
- [x] AC-11: `GET /lead-times/stats/:produtoId` — get computed statistics for a product

### Testing
- [x] AC-12: Unit tests for service methods (record, history, stats, sigmaLt)
- [x] AC-13: Tests for sigma_LT computation accuracy (known dataset)
- [x] AC-14: Tests for StockParamsService integration (fallback when <5 observations)

---

## Tasks / Subtasks

- [x] **Task 1: Schema** (AC: 1-3)
- [x] **Task 2: LeadTimeTrackingService** (AC: 4-7)
- [x] **Task 3: StockParamsService integration** (AC: 8)
- [x] **Task 4: API endpoints** (AC: 9-11)
- [x] **Task 5: Tests** (AC: 12-14)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added HistoricoLeadTime model with FK to ProdutoFornecedor, index |
| `apps/api/src/modules/fornecedores/lead-time/lead-time-tracking.service.ts` | Created | Service with record, getHistory, calculateStats, getSigmaLt |
| `apps/api/src/modules/fornecedores/lead-time/lead-time.controller.ts` | Created | REST endpoints for lead time recording and retrieval |
| `apps/api/src/modules/fornecedores/lead-time/dto/record-lead-time.dto.ts` | Created | DTO with class-validator decorators |
| `apps/api/src/modules/fornecedores/fornecedores.module.ts` | Modified | Added LeadTimeController and LeadTimeTrackingService |
| `apps/api/src/modules/mrp/engine/stock-params.service.ts` | Modified | getSupplierLeadTime now prefers historical sigma_LT (>=5 obs) |
| `apps/api/src/modules/fornecedores/lead-time/lead-time-tracking.service.spec.ts` | Created | 13 unit tests for service methods, stats accuracy, fallback |

---

## Dependencies

- Story 1.5: Supplier CRUD (existing fornecedores module)
- Story 3.3: Stock Parameter Calculation (StockParamsService)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — Historical Lead Time Tracking | River (SM) |
| 2026-02-28 | 0.2 | Schema + Service + Controller + Integration + Tests — Story Done | Dex (Dev) |
