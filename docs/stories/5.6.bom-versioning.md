# Story 5.6: BOM Versioning

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner / engineer,
**I want** full BOM version management with valid_from/valid_to date ranges,
**so that** I can track BOM changes over time, plan engineering changes with future effective dates, and maintain accurate historical costing.

## References

- FR-069: BOM Versioning
- [Source: PRD §4 — Full BOM version management with valid_from/valid_to dates]
- [Bom model already has validoDesde/validoAte fields]
- [Story 1.6: BOM CRUD, Tree & Exploded Cost — existing BOM infrastructure]

## Acceptance Criteria

### Schema Enhancement
- [x] AC-1: Add `versao` (version number) field to Bom model — auto-incremented per parent product
- [x] AC-2: Unique constraint on (produtoPaiId, produtoFilhoId, versao) to prevent duplicate versions

### Version Service (NestJS)
- [x] AC-3: BomVersionService.createNewVersion() — copies current active BOM lines for a parent product, creates new version with updated validoDesde, sets validoAte on previous version
- [x] AC-4: BomVersionService.getVersionHistory() — returns all versions for a parent product with date ranges
- [x] AC-5: BomVersionService.getVersionAt() — returns BOM lines effective at a specific date (date between validoDesde and validoAte)
- [x] AC-6: BomVersionService.getCurrentVersion() — returns currently active BOM version (validoAte is null)
- [x] AC-7: Version transition is atomic — previous version's validoAte is set in same transaction as new version creation

### API Endpoints
- [x] AC-8: `POST /bom/versions/:produtoPaiId` — create new BOM version for a parent product (operator role)
- [x] AC-9: `GET /bom/versions/:produtoPaiId` — list all versions for a parent product
- [x] AC-10: `GET /bom/versions/:produtoPaiId/at/:date` — get BOM at a specific date

### Testing
- [x] AC-11: Unit tests for version creation, history, date-based lookup
- [x] AC-12: Tests for version transition atomicity (previous validoAte set correctly)
- [x] AC-13: Tests for edge cases (no previous version, future effective dates)

---

## Tasks / Subtasks

- [x] **Task 1: Schema enhancement** (AC: 1, 2)
- [x] **Task 2: BomVersionService** (AC: 3-7)
- [x] **Task 3: API endpoints** (AC: 8-10)
- [x] **Task 4: Tests** (AC: 11-13)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added `versao` field, unique constraint, index to Bom model |
| `apps/api/src/modules/bom/bom-version.service.ts` | Created | BomVersionService with createNewVersion, getVersionHistory, getVersionAt, getCurrentVersion |
| `apps/api/src/modules/bom/bom.controller.ts` | Modified | Added 4 versioning endpoints (POST/GET versions, GET at date, GET current) |
| `apps/api/src/modules/bom/bom.module.ts` | Modified | Added BomVersionService to providers and exports |
| `apps/api/src/modules/bom/bom-version.service.spec.ts` | Created | 14 unit tests for version service (creation, history, date lookup, atomicity, edge cases) |
| `apps/api/src/modules/bom/bom.controller.spec.ts` | Modified | Added BomVersionService mock and 4 versioning endpoint tests |

---

## Dependencies

- Story 1.6: BOM CRUD (existing BOM module)
- Bom model with validoDesde/validoAte fields

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — BOM Versioning | River (SM) |
| 2026-02-28 | 0.2 | Schema + BomVersionService implemented | Dex (Dev) |
| 2026-02-28 | 0.3 | Endpoints, module update, tests complete — Story Done | Dex (Dev) |
