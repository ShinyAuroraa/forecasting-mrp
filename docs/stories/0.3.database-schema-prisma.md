# Story 0.3: Database Schema & Prisma Setup

## Status

Done

## Executor Assignment

executor: "@data-engineer"
quality_gate: "@dev"
quality_gate_tools: ["prisma migrate dev", "prisma validate", "typecheck"]

## Story

**As a** developer,
**I want** the complete PostgreSQL database schema defined in Prisma with all 26 tables from the PRD data model, proper enums, relationships, indexes, and a clean initial migration,
**so that** I can build features against a fully typed and validated database schema from day one.

## Acceptance Criteria

1. `apps/api/prisma/schema.prisma` contains models for all 26 tables: produto, categoria, unidade_medida, fornecedor, produto_fornecedor, bom, inventario_atual, deposito, centro_trabalho, turno, parada_programada, evento_capacidade, roteiro_producao, calendario_fabrica, config_sistema, execucao_planejamento, execucao_step_log, forecast_resultado, forecast_metrica, forecast_modelo, sku_classification, serie_temporal, parametros_estoque, ordem_planejada, carga_capacidade, usuario
2. All tables use UUID primary keys with `@default(uuid())` and have `created_at`/`updated_at` timestamp fields where specified in the PRD
3. All enums from the PRD are defined as Prisma enums: `TipoProduto`, `PoliticaRessuprimento`, `FonteAtualizacao`, `TipoDeposito`, `TipoCentroTrabalho`, `TipoParadaProgramada`, `TipoEventoCapacidade`, `TipoCalendarioFabrica`, `TipoExecucao`, `StatusExecucao`, `GatilhoExecucao`, `ModeloForecast`, `TargetType`, `Granularidade`, `PadraoDemanda`, `ClasseABC`, `ClasseXYZ`, `TipoOrdem`, `StatusOrdem`, `PrioridadeOrdem`, `Lotificacao`, `SugestaoCapacidade`, `UserRole`, `MetodoCalculo`
4. All foreign key relationships are correctly defined with appropriate `@relation` annotations
5. All unique constraints match the PRD: `produto.codigo`, `fornecedor.codigo`, `unidade_medida.sigla`, `deposito.codigo`, `centro_trabalho.codigo`, `usuario.email`, `produto_fornecedor(produto_id, fornecedor_id)`, `inventario_atual(produto_id, deposito_id, lote)`, `calendario_fabrica.data`, `serie_temporal(produto_id, data_referencia, granularidade)`, `sku_classification.produto_id`
6. All indexes from the data architecture document are defined: `idx_produto_codigo`, `idx_produto_tipo_ativo`, `idx_produto_categoria`, `idx_bom_pai_ativo`, `idx_bom_filho`, `idx_inv_produto_deposito`, `idx_forecast_exec_produto`, `idx_forecast_periodo`, `idx_ordem_exec_tipo`, `idx_ordem_prioridade`, `idx_ordem_data_liberacao`, `idx_carga_centro_periodo`, `idx_exec_tipo_status`
7. `npx prisma validate` passes with no errors
8. `npx prisma migrate dev --name initial_schema` creates a clean migration
9. The generated migration SQL creates all tables, enums, indexes, and constraints in PostgreSQL
10. `npx prisma generate` produces a typed Prisma Client with correct TypeScript types for all models

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Define Prisma Enums** (AC: 3)
  - [x] Define all enums in `apps/api/prisma/schema.prisma`:
    ```prisma
    enum TipoProduto {
      ACABADO
      SEMI_ACABADO
      INSUMO
      EMBALAGEM
      MATERIA_PRIMA
      REVENDA
    }

    enum PoliticaRessuprimento {
      PONTO_PEDIDO
      MIN_MAX
      REVISAO_PERIODICA
      KANBAN
    }

    enum FonteAtualizacao {
      MANUAL
      ERP_SYNC
      CONTAGEM
      UPLOAD
    }

    enum TipoDeposito {
      MATERIA_PRIMA
      PRODUTO_ACABADO
      WIP
      EXPEDICAO
      QUARENTENA
    }

    enum TipoCentroTrabalho {
      PRODUCAO
      EMBALAGEM
      MONTAGEM
      ACABAMENTO
      CONTROLE_QUALIDADE
    }

    enum TipoParadaProgramada {
      MANUTENCAO
      FERIAS_COLETIVAS
      SETUP
      LIMPEZA
      OUTRO
    }

    enum TipoEventoCapacidade {
      NOVO_MAQUINARIO
      QUEBRA
      REPARO
      MUDANCA_TURNO
      MUDANCA_EFICIENCIA
      AUMENTO_CAPACIDADE
      REDUCAO_CAPACIDADE
    }

    enum TipoCalendarioFabrica {
      UTIL
      FERIADO
      PONTO_FACULTATIVO
      FERIAS_COLETIVAS
      SABADO
      DOMINGO
    }

    enum TipoExecucao {
      FORECAST
      MRP
      COMPLETO
    }

    enum StatusExecucao {
      PENDENTE
      EXECUTANDO
      CONCLUIDO
      ERRO
    }

    enum GatilhoExecucao {
      MANUAL
      AGENDADO
      AUTO_INGESTAO
    }

    enum ModeloForecast {
      TFT
      ETS
      CROSTON
      LGBM
      ENSEMBLE
    }

    enum TargetType {
      VOLUME
      FATURAMENTO
    }

    enum Granularidade {
      diario
      semanal
      mensal
    }

    enum PadraoDemanda {
      REGULAR
      INTERMITENTE
      ERRATICO
      LUMPY
    }

    enum ClasseABC {
      A
      B
      C
    }

    enum ClasseXYZ {
      X
      Y
      Z
    }

    enum TipoOrdem {
      COMPRA
      PRODUCAO
    }

    enum StatusOrdem {
      PLANEJADA
      FIRME
      LIBERADA
      CANCELADA
    }

    enum PrioridadeOrdem {
      CRITICA
      ALTA
      MEDIA
      BAIXA
    }

    enum Lotificacao {
      L4L
      EOQ
      SILVER_MEAL
      WAGNER_WHITIN
    }

    enum SugestaoCapacidade {
      OK
      HORA_EXTRA
      ANTECIPAR
      SUBCONTRATAR
    }

    enum UserRole {
      admin
      manager
      operator
      viewer
    }

    enum MetodoCalculo {
      TFT_QUANTIL
      FORMULA_CLASSICA
      MONTE_CARLO
    }
    ```

- [x] **Task 2: Define Registration Table Models** (AC: 1, 2, 4, 5)
  - [x] Define `Produto` model with all fields from PRD 3.1.1:
    - `id`, `codigo` (unique), `descricao`, `tipo_produto` (enum), `categoria_id` (FK), `unidade_medida_id` (FK), `peso_liquido_kg`, `volume_m3`, `ativo`, `custo_unitario`, `custo_pedido`, `custo_manutencao_pct_ano`, `preco_venda`, `politica_ressuprimento` (enum), `intervalo_revisao_dias`, `lote_minimo`, `multiplo_compra`, `estoque_seguranca_manual`, `lead_time_producao_dias`, `created_at`, `updated_at`
    - Relations: `categoria`, `unidade_medida`, `bom_pai` (as parent), `bom_filho` (as child), `produto_fornecedor`, `inventario_atual`, `roteiro_producao`, `forecast_resultado`, `forecast_metrica`, `sku_classification`, `serie_temporal`, `parametros_estoque`, `ordem_planejada`
    - Use `@map()` for snake_case column names, `@@map("produto")` for table name
  - [x] Define `Categoria` model with all fields from PRD 3.1.2:
    - `id`, `nome`, `descricao`, `pai_id` (self-referencing FK)
    - Relations: self-referencing parent/children, `produtos`
    - `@@map("categoria")`
  - [x] Define `UnidadeMedida` model with all fields from PRD 3.1.3:
    - `id`, `sigla` (unique), `nome`, `fator_conversao`
    - Relations: `produtos`, `bom`
    - `@@map("unidade_medida")`
  - [x] Define `Fornecedor` model with all fields from PRD 3.1.4:
    - `id`, `codigo` (unique), `razao_social`, `nome_fantasia`, `cnpj`, `email`, `telefone`, `cidade`, `estado`, `lead_time_padrao_dias`, `lead_time_min_dias`, `lead_time_max_dias`, `confiabilidade_pct`, `avaliacao`, `ativo`, `created_at`, `updated_at`
    - Relations: `produto_fornecedor`, `ordem_planejada`
    - `@@map("fornecedor")`
  - [x] Define `ProdutoFornecedor` model with all fields from PRD 3.1.5:
    - `id`, `produto_id` (FK), `fornecedor_id` (FK), `lead_time_dias`, `preco_unitario`, `moq`, `multiplo_compra`, `is_principal`, `ultima_compra`, `created_at`, `updated_at`
    - Unique constraint: `@@unique([produto_id, fornecedor_id])`
    - `@@map("produto_fornecedor")`
  - [x] Define `Bom` model with all fields from PRD 3.1.6:
    - `id`, `produto_pai_id` (FK), `produto_filho_id` (FK), `quantidade`, `unidade_medida_id` (FK), `perda_percentual`, `nivel`, `observacao`, `ativo`, `valido_desde`, `valido_ate`, `created_at`, `updated_at`
    - Relations: `produto_pai`, `produto_filho`, `unidade_medida`
    - `@@map("bom")`
  - [x] Define `Deposito` model with all fields from PRD 3.1.8:
    - `id`, `codigo` (unique), `nome`, `tipo` (enum), `capacidade_m3`, `capacidade_posicoes`, `capacidade_kg`, `temperatura_min`, `temperatura_max`, `endereco`, `ativo`
    - Relations: `inventario_atual`
    - `@@map("deposito")`
  - [x] Define `InventarioAtual` model with all fields from PRD 3.1.7:
    - `id`, `produto_id` (FK), `deposito_id` (FK), `quantidade_disponivel`, `quantidade_reservada`, `quantidade_em_transito`, `quantidade_em_quarentena`, `lote`, `data_validade`, `data_ultima_contagem`, `custo_medio_unitario`, `fonte_atualizacao` (enum), `updated_at`
    - Note: `quantidade_total` and `valor_total_estoque` are GENERATED columns -- handle via `@default(dbgenerated())` or raw SQL in migration
    - Unique constraint: `@@unique([produto_id, deposito_id, lote])`
    - `@@map("inventario_atual")`

- [x] **Task 3: Define Capacity Table Models** (AC: 1, 2, 4, 5)
  - [x] Define `CentroTrabalho` model with all fields from PRD 3.2.1:
    - `id`, `codigo` (unique), `nome`, `tipo` (enum), `descricao`, `capacidade_hora_unidades`, `num_operadores`, `eficiencia_percentual`, `tempo_setup_minutos`, `custo_hora`, `ativo`, `observacoes`, `created_at`, `updated_at`
    - Relations: `turnos`, `paradas_programadas`, `eventos_capacidade`, `roteiro_producao`, `ordem_planejada`, `carga_capacidade`
    - `@@map("centro_trabalho")`
  - [x] Define `Turno` model with all fields from PRD 3.2.2:
    - `id`, `centro_trabalho_id` (FK), `nome`, `hora_inicio`, `hora_fim`, `dias_semana` (Int array), `ativo`, `valido_desde`, `valido_ate`
    - `@@map("turno")`
  - [x] Define `ParadaProgramada` model with all fields from PRD 3.2.3:
    - `id`, `centro_trabalho_id` (FK), `tipo` (enum), `data_inicio`, `data_fim`, `motivo`, `recorrente`, `cron_expression`
    - `@@map("parada_programada")`
  - [x] Define `EventoCapacidade` model with all fields from PRD 3.2.4:
    - `id`, `centro_trabalho_id` (FK), `tipo` (enum), `data_evento`, `campo_alterado`, `valor_anterior`, `valor_novo`, `motivo`, `previsao_resolucao`, `usuario_id` (FK), `created_at`
    - `@@map("evento_capacidade")`
  - [x] Define `RoteiroProducao` model with all fields from PRD 3.2.5:
    - `id`, `produto_id` (FK), `centro_trabalho_id` (FK), `sequencia`, `operacao`, `tempo_setup_minutos`, `tempo_unitario_minutos`, `tempo_espera_minutos`, `descricao`, `ativo`
    - `@@map("roteiro_producao")`
  - [x] Define `CalendarioFabrica` model with all fields from PRD 3.2.6:
    - `id`, `data` (unique), `tipo` (enum), `descricao`, `horas_produtivas`
    - `@@map("calendario_fabrica")`

- [x] **Task 4: Define Result Table Models** (AC: 1, 2, 4, 5)
  - [x] Define `ExecucaoPlanejamento` model with all fields from PRD 3.3.1:
    - `id`, `tipo` (enum), `status` (enum), `gatilho` (enum), `parametros` (Json), `resultado_resumo` (Json), `started_at`, `completed_at`, `error_message`, `created_by` (FK to usuario), `created_at`
    - Relations: `step_logs`, `forecast_resultados`, `forecast_metricas`, `forecast_modelos`, `parametros_estoque`, `ordens_planejadas`, `cargas_capacidade`, `usuario`
    - `@@map("execucao_planejamento")`
  - [x] Define `ExecucaoStepLog` model with all fields from PRD 3.3.2:
    - `id` (BigInt autoincrement), `execucao_id` (FK), `step_name`, `step_order`, `status`, `records_processed` (BigInt), `duration_ms`, `details` (Json), `started_at`, `completed_at`
    - `@@map("execucao_step_log")`
  - [x] Define `ForecastResultado` model with all fields from PRD 3.3.3:
    - `id`, `execucao_id` (FK), `produto_id` (FK), `periodo`, `horizonte_semanas`, `modelo_usado` (enum), `target_type` (enum), `p10`, `p25`, `p50`, `p75`, `p90`, `faturamento_p50`, `faturamento_p10`, `faturamento_p90`
    - `@@map("forecast_resultado")`
  - [x] Define `ForecastMetrica` model with all fields from PRD 3.3.4:
    - `id`, `execucao_id` (FK), `produto_id` (FK), `modelo`, `mape`, `mae`, `rmse`, `bias`, `classe_abc`, `created_at`
    - `@@map("forecast_metrica")`
  - [x] Define `ForecastModelo` model with all fields from PRD 3.3.5:
    - `id`, `execucao_id` (FK), `tipo_modelo`, `versao`, `parametros` (Json), `metricas_treino` (Json), `arquivo_path`, `is_champion`, `treinado_em`, `created_at`
    - `@@map("forecast_modelo")`
  - [x] Define `SkuClassification` model with all fields from PRD 3.3.6:
    - `id`, `produto_id` (FK, unique), `classe_abc` (enum), `classe_xyz` (enum), `padrao_demanda` (enum), `modelo_forecast_sugerido`, `percentual_receita`, `cv_demanda`, `calculado_em`, `created_at`, `updated_at`
    - `@@map("sku_classification")`
  - [x] Define `SerieTemporal` model with all fields from PRD 3.3.7:
    - `id`, `produto_id` (FK), `data_referencia`, `granularidade` (enum), `volume`, `receita`, `fonte`, `qualidade`, `created_at`
    - Unique constraint: `@@unique([produto_id, data_referencia, granularidade])`
    - `@@map("serie_temporal")`
  - [x] Define `ParametrosEstoque` model with all fields from PRD 3.3.8:
    - `id`, `execucao_id` (FK), `produto_id` (FK), `safety_stock`, `reorder_point`, `estoque_minimo`, `estoque_maximo`, `eoq`, `dias_cobertura_atual`, `metodo_calculo` (enum), `nivel_servico_usado`, `calculated_at`
    - `@@map("parametros_estoque")`
  - [x] Define `OrdemPlanejada` model with all fields from PRD 3.3.9:
    - `id`, `execucao_id` (FK), `produto_id` (FK), `tipo` (enum), `quantidade`, `data_necessidade`, `data_liberacao`, `data_recebimento_esperado`, `fornecedor_id` (FK, optional), `centro_trabalho_id` (FK, optional), `custo_estimado`, `lotificacao_usada` (enum, optional), `prioridade` (enum), `status` (enum), `mensagem_acao`, `motivo`, `observacao`
    - `@@map("ordem_planejada")`
  - [x] Define `CargaCapacidade` model with all fields from PRD 3.3.10:
    - `id`, `execucao_id` (FK), `centro_trabalho_id` (FK), `periodo`, `capacidade_disponivel_horas`, `carga_planejada_horas`, `utilizacao_percentual`, `sobrecarga`, `horas_excedentes`, `sugestao` (enum, optional)
    - `@@map("carga_capacidade")`

- [x] **Task 5: Define System Table Models** (AC: 1, 2, 4, 5)
  - [x] Define `ConfigSistema` model with all fields from PRD 3.4:
    - `chave` (String, @id -- NOT UUID, uses VARCHAR primary key), `valor` (Json), `descricao`, `updated_at`, `updated_by` (FK to usuario, optional)
    - `@@map("config_sistema")`
  - [x] Define `Usuario` model with all fields from PRD 3.5.1:
    - `id`, `email` (unique), `nome`, `senha_hash`, `role` (enum), `ativo`, `created_at`, `updated_at`
    - Relations: `execucoes_planejamento`, `eventos_capacidade`
    - `@@map("usuario")`

- [x] **Task 6: Define Indexes** (AC: 6)
  - [x] Add composite and single-column indexes using `@@index`:
    ```prisma
    // On Produto:
    @@index([tipo_produto, ativo], map: "idx_produto_tipo_ativo")
    @@index([categoria_id], map: "idx_produto_categoria")

    // On Bom:
    @@index([produto_pai_id, ativo], map: "idx_bom_pai_ativo")
    @@index([produto_filho_id], map: "idx_bom_filho")

    // On ForecastResultado:
    @@index([execucao_id, produto_id], map: "idx_forecast_exec_produto")
    @@index([periodo], map: "idx_forecast_periodo")

    // On OrdemPlanejada:
    @@index([execucao_id, tipo], map: "idx_ordem_exec_tipo")
    @@index([prioridade], map: "idx_ordem_prioridade")
    @@index([data_liberacao], map: "idx_ordem_data_liberacao")

    // On CargaCapacidade:
    @@index([centro_trabalho_id, periodo], map: "idx_carga_centro_periodo")

    // On ExecucaoPlanejamento:
    @@index([tipo, status], map: "idx_exec_tipo_status")
    ```

- [x] **Task 7: Configure Prisma Datasource and Generator** (AC: 7, 10)
  - [x] Configure datasource in `schema.prisma`:
    ```prisma
    datasource db {
      provider = "postgresql"
      url      = env("DATABASE_URL")
    }

    generator client {
      provider = "prisma-client-js"
    }
    ```
  - [x] Run `npx prisma validate` -- must pass with no errors
  - [x] Run `npx prisma generate` -- must produce typed client

- [x] **Task 8: Create Initial Migration** (AC: 8, 9)
  - [x] Run `npx prisma migrate dev --name initial_schema`
  - [x] Verify migration SQL in `apps/api/prisma/migrations/{timestamp}_initial_schema/migration.sql`
  - [x] Verify all 26 tables are created in PostgreSQL
  - [x] Manually add GENERATED ALWAYS AS columns for `inventario_atual` via a custom SQL migration if Prisma cannot handle them natively:
    - `quantidade_total NUMERIC(12,4) GENERATED ALWAYS AS (quantidade_disponivel + quantidade_reservada + quantidade_em_quarentena) STORED`
    - `valor_total_estoque NUMERIC(14,4) GENERATED ALWAYS AS (quantidade_total * custo_medio_unitario) STORED`
  - [x] Manually add GIN indexes for JSONB columns via raw SQL in migration:
    ```sql
    CREATE INDEX idx_exec_parametros ON execucao_planejamento USING GIN (parametros);
    CREATE INDEX idx_exec_resultado ON execucao_planejamento USING GIN (resultado_resumo);
    CREATE INDEX idx_config_valor ON config_sistema USING GIN (valor);
    ```
  - [x] Verify migration runs cleanly on a fresh database

## Dev Notes

### Complete Table Reference
[Source: docs/prd/3-data-model.md]

The PRD defines 26 tables organized into 5 groups:

| Group | Tables | Count |
|-------|--------|-------|
| Registration | produto, categoria, unidade_medida, fornecedor, produto_fornecedor, bom, deposito | 7 |
| Capacity | centro_trabalho, turno, parada_programada, evento_capacidade, roteiro_producao, calendario_fabrica | 6 |
| Inventory | inventario_atual | 1 |
| Results | execucao_planejamento, execucao_step_log, forecast_resultado, forecast_metrica, forecast_modelo, parametros_estoque, ordem_planejada, carga_capacidade | 8 |
| Classification | sku_classification, serie_temporal | 2 |
| System | config_sistema, usuario | 2 |

### Column-by-Column Reference

**produto** (PRD 3.1.1): id (UUID PK), codigo (VARCHAR(50) UNIQUE), descricao (VARCHAR(255)), tipo_produto (ENUM), categoria_id (UUID FK), unidade_medida_id (UUID FK), peso_liquido_kg (NUMERIC(10,4)), volume_m3 (NUMERIC(10,6)), ativo (BOOLEAN default true), custo_unitario (NUMERIC(12,4)), custo_pedido (NUMERIC(12,4)), custo_manutencao_pct_ano (NUMERIC(5,2) default 25.00), preco_venda (NUMERIC(12,4)), politica_ressuprimento (ENUM default PONTO_PEDIDO), intervalo_revisao_dias (INT), lote_minimo (NUMERIC(12,4) default 1), multiplo_compra (NUMERIC(12,4) default 1), estoque_seguranca_manual (NUMERIC(12,4)), lead_time_producao_dias (INT), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)

**categoria** (PRD 3.1.2): id (UUID PK), nome (VARCHAR(100)), descricao (TEXT), pai_id (UUID FK self-ref)

**unidade_medida** (PRD 3.1.3): id (UUID PK), sigla (VARCHAR(10) UNIQUE), nome (VARCHAR(50)), fator_conversao (NUMERIC(12,6) default 1)

**fornecedor** (PRD 3.1.4): id (UUID PK), codigo (VARCHAR(50) UNIQUE), razao_social (VARCHAR(255)), nome_fantasia (VARCHAR(255)), cnpj (VARCHAR(18)), email (VARCHAR(255)), telefone (VARCHAR(20)), cidade (VARCHAR(100)), estado (VARCHAR(2)), lead_time_padrao_dias (INT), lead_time_min_dias (INT), lead_time_max_dias (INT), confiabilidade_pct (NUMERIC(5,2) default 90.00), avaliacao (SMALLINT default 3), ativo (BOOLEAN default true), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)

**produto_fornecedor** (PRD 3.1.5): id (UUID PK), produto_id (UUID FK), fornecedor_id (UUID FK), lead_time_dias (INT), preco_unitario (NUMERIC(12,4)), moq (NUMERIC(12,4) default 1), multiplo_compra (NUMERIC(12,4) default 1), is_principal (BOOLEAN default false), ultima_compra (TIMESTAMPTZ), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ). UNIQUE(produto_id, fornecedor_id)

**bom** (PRD 3.1.6): id (UUID PK), produto_pai_id (UUID FK), produto_filho_id (UUID FK), quantidade (NUMERIC(12,6)), unidade_medida_id (UUID FK), perda_percentual (NUMERIC(5,2) default 0), nivel (SMALLINT), observacao (TEXT), ativo (BOOLEAN default true), valido_desde (DATE), valido_ate (DATE), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)

**inventario_atual** (PRD 3.1.7): id (UUID PK), produto_id (UUID FK), deposito_id (UUID FK), quantidade_disponivel (NUMERIC(12,4) default 0), quantidade_reservada (NUMERIC(12,4) default 0), quantidade_em_transito (NUMERIC(12,4) default 0), quantidade_em_quarentena (NUMERIC(12,4) default 0), quantidade_total (GENERATED), lote (VARCHAR(50)), data_validade (DATE), data_ultima_contagem (DATE), custo_medio_unitario (NUMERIC(12,4)), valor_total_estoque (GENERATED), fonte_atualizacao (ENUM default MANUAL), updated_at (TIMESTAMPTZ). UNIQUE(produto_id, deposito_id, lote)

**deposito** (PRD 3.1.8): id (UUID PK), codigo (VARCHAR(50) UNIQUE), nome (VARCHAR(100)), tipo (ENUM), capacidade_m3 (NUMERIC(10,2)), capacidade_posicoes (INT), capacidade_kg (NUMERIC(12,2)), temperatura_min (NUMERIC(5,2)), temperatura_max (NUMERIC(5,2)), endereco (TEXT), ativo (BOOLEAN default true)

**centro_trabalho** (PRD 3.2.1): id (UUID PK), codigo (VARCHAR(50) UNIQUE), nome (VARCHAR(100)), tipo (ENUM), descricao (TEXT), capacidade_hora_unidades (NUMERIC(10,2)), num_operadores (INT), eficiencia_percentual (NUMERIC(5,2) default 100), tempo_setup_minutos (NUMERIC(8,2) default 0), custo_hora (NUMERIC(10,2)), ativo (BOOLEAN default true), observacoes (TEXT), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)

**turno** (PRD 3.2.2): id (UUID PK), centro_trabalho_id (UUID FK), nome (VARCHAR(50)), hora_inicio (TIME), hora_fim (TIME), dias_semana (INT[]), ativo (BOOLEAN default true), valido_desde (DATE), valido_ate (DATE)

**parada_programada** (PRD 3.2.3): id (UUID PK), centro_trabalho_id (UUID FK), tipo (ENUM), data_inicio (TIMESTAMPTZ), data_fim (TIMESTAMPTZ), motivo (TEXT), recorrente (BOOLEAN default false), cron_expression (VARCHAR(100))

**evento_capacidade** (PRD 3.2.4): id (UUID PK), centro_trabalho_id (UUID FK), tipo (ENUM), data_evento (TIMESTAMPTZ), campo_alterado (VARCHAR(50)), valor_anterior (VARCHAR(100)), valor_novo (VARCHAR(100)), motivo (TEXT), previsao_resolucao (DATE), usuario_id (UUID FK), created_at (TIMESTAMPTZ)

**roteiro_producao** (PRD 3.2.5): id (UUID PK), produto_id (UUID FK), centro_trabalho_id (UUID FK), sequencia (SMALLINT), operacao (VARCHAR(100)), tempo_setup_minutos (NUMERIC(8,2) default 0), tempo_unitario_minutos (NUMERIC(8,4)), tempo_espera_minutos (NUMERIC(8,2) default 0), descricao (TEXT), ativo (BOOLEAN default true)

**calendario_fabrica** (PRD 3.2.6): id (UUID PK), data (DATE UNIQUE), tipo (ENUM), descricao (VARCHAR(100)), horas_produtivas (NUMERIC(4,2) default 0)

**execucao_planejamento** (PRD 3.3.1): id (UUID PK), tipo (ENUM), status (ENUM default PENDENTE), gatilho (ENUM), parametros (JSONB), resultado_resumo (JSONB), started_at (TIMESTAMPTZ), completed_at (TIMESTAMPTZ), error_message (TEXT), created_by (UUID FK), created_at (TIMESTAMPTZ)

**execucao_step_log** (PRD 3.3.2): id (BIGSERIAL PK), execucao_id (UUID FK), step_name (VARCHAR(50)), step_order (SMALLINT), status (VARCHAR(20)), records_processed (BIGINT), duration_ms (INT), details (JSONB), started_at (TIMESTAMPTZ), completed_at (TIMESTAMPTZ)

**forecast_resultado** (PRD 3.3.3): id (UUID PK), execucao_id (UUID FK), produto_id (UUID FK), periodo (DATE), horizonte_semanas (INT), modelo_usado (ENUM), target_type (ENUM), p10 (NUMERIC(14,4)), p25 (NUMERIC(14,4)), p50 (NUMERIC(14,4)), p75 (NUMERIC(14,4)), p90 (NUMERIC(14,4)), faturamento_p50 (NUMERIC(14,4)), faturamento_p10 (NUMERIC(14,4)), faturamento_p90 (NUMERIC(14,4))

**forecast_metrica** (PRD 3.3.4): id (UUID PK), execucao_id (UUID FK), produto_id (UUID FK), modelo (VARCHAR(50)), mape (NUMERIC(8,4)), mae (NUMERIC(12,4)), rmse (NUMERIC(12,4)), bias (NUMERIC(8,4)), classe_abc (CHAR(1)), created_at (TIMESTAMPTZ)

**forecast_modelo** (PRD 3.3.5): id (UUID PK), execucao_id (UUID FK), tipo_modelo (VARCHAR(50)), versao (INT), parametros (JSONB), metricas_treino (JSONB), arquivo_path (VARCHAR(500)), is_champion (BOOLEAN default false), treinado_em (TIMESTAMPTZ), created_at (TIMESTAMPTZ)

**sku_classification** (PRD 3.3.6): id (UUID PK), produto_id (UUID FK UNIQUE), classe_abc (ENUM), classe_xyz (ENUM), padrao_demanda (ENUM), modelo_forecast_sugerido (VARCHAR(50)), percentual_receita (NUMERIC(6,4)), cv_demanda (NUMERIC(6,4)), calculado_em (TIMESTAMPTZ), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)

**serie_temporal** (PRD 3.3.7): id (UUID PK), produto_id (UUID FK), data_referencia (DATE), granularidade (ENUM default semanal), volume (NUMERIC(14,4) default 0), receita (NUMERIC(14,4) default 0), fonte (VARCHAR(30)), qualidade (NUMERIC(4,2)), created_at (TIMESTAMPTZ). UNIQUE(produto_id, data_referencia, granularidade)

**parametros_estoque** (PRD 3.3.8): id (UUID PK), execucao_id (UUID FK), produto_id (UUID FK), safety_stock (NUMERIC(12,4)), reorder_point (NUMERIC(12,4)), estoque_minimo (NUMERIC(12,4)), estoque_maximo (NUMERIC(12,4)), eoq (NUMERIC(12,4)), dias_cobertura_atual (NUMERIC(8,2)), metodo_calculo (ENUM), nivel_servico_usado (NUMERIC(5,4)), calculated_at (TIMESTAMPTZ)

**ordem_planejada** (PRD 3.3.9): id (UUID PK), execucao_id (UUID FK), produto_id (UUID FK), tipo (ENUM), quantidade (NUMERIC(12,4)), data_necessidade (DATE), data_liberacao (DATE), data_recebimento_esperado (DATE), fornecedor_id (UUID FK optional), centro_trabalho_id (UUID FK optional), custo_estimado (NUMERIC(14,4)), lotificacao_usada (ENUM optional), prioridade (ENUM), status (ENUM default PLANEJADA), mensagem_acao (VARCHAR(100)), motivo (VARCHAR(100)), observacao (TEXT)

**carga_capacidade** (PRD 3.3.10): id (UUID PK), execucao_id (UUID FK), centro_trabalho_id (UUID FK), periodo (DATE), capacidade_disponivel_horas (NUMERIC(8,2)), carga_planejada_horas (NUMERIC(8,2)), utilizacao_percentual (NUMERIC(5,2)), sobrecarga (BOOLEAN default false), horas_excedentes (NUMERIC(8,2) default 0), sugestao (ENUM optional)

**config_sistema** (PRD 3.4): chave (VARCHAR(100) PK -- NOT UUID), valor (JSONB), descricao (TEXT), updated_at (TIMESTAMPTZ), updated_by (UUID FK optional)

**usuario** (PRD 3.5.1): id (UUID PK), email (VARCHAR(255) UNIQUE), nome (VARCHAR(150)), senha_hash (VARCHAR(255)), role (ENUM default viewer), ativo (BOOLEAN default true), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)

### Prisma Limitations / Workarounds

1. **GENERATED columns**: Prisma does not natively support `GENERATED ALWAYS AS ... STORED`. Use `@default(dbgenerated())` as a placeholder and add the actual generated column via raw SQL in a custom migration step.
2. **GIN indexes**: Prisma does not support GIN indexes. Add them via raw SQL in the migration file after Prisma generates it.
3. **Integer arrays**: Use `Int[]` in Prisma for PostgreSQL `INTEGER[]` columns (e.g., `dias_semana`).
4. **JSONB columns**: Use `Json` type in Prisma, maps to `JSONB` in PostgreSQL.
5. **Decimal precision**: Use `Decimal` type with `@db.Decimal(x,y)` for NUMERIC columns.
6. **Table mapping**: Use `@@map("table_name")` on every model to ensure snake_case table names.
7. **Column mapping**: Use `@map("column_name")` on fields where the Prisma field name (camelCase) differs from the DB column (snake_case).

### Index Strategy Reference
[Source: docs/architecture/6-data-architecture.md, Section 6.4]

All indexes listed in AC 6 come from the architecture document. Additionally, 3 GIN indexes for JSONB columns must be added via raw SQL.

### Migration Strategy
[Source: docs/architecture/6-data-architecture.md, Section 6.5]

- Tool: Prisma Migrate
- Migration naming: `{timestamp}_{description}`
- Workflow: modify schema -> `prisma migrate dev` -> verify SQL -> commit

### Coding Standards for DB
[Source: docs/architecture/coding-standards.md]

- Primary key: UUID, column name `id`
- Timestamps: Always `created_at`, `updated_at` (TIMESTAMPTZ NOT NULL DEFAULT NOW())
- Foreign keys: `{table}_id` naming
- Enums: Prisma enums map to PostgreSQL enums
- Soft delete: `ativo BOOLEAN DEFAULT true`
- Indexes: Named `idx_{table}_{columns}`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story created during greenfield-fullstack workflow engine | River (SM) |
| 2026-02-25 | 0.2 | Implementation complete: all 8 tasks done, 26 tables + 24 enums migrated | Dex (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (@dev / Dex)

### Debug Log References
- `npx prisma validate`: schema valid
- `npx prisma generate`: client generated to `src/generated/prisma` (211ms)
- `npx prisma migrate dev --name initial_schema`: 26 tables, 24 enums, all indexes and FKs created
- Custom migration `20260225214200_add_generated_columns_and_gin_indexes`: 2 GENERATED columns + 3 GIN indexes
- `npx prisma migrate status`: 2 migrations applied, schema up to date
- `pnpm --filter @forecasting-mrp/api run typecheck`: passes without errors
- PostgreSQL table count verification: 26 tables (+ _prisma_migrations)

### Completion Notes List
- Prisma 7.4.1 breaking change: `url` no longer allowed in `datasource` block in schema.prisma — moved to `prisma.config.ts`
- Prisma 7 generator: changed from `prisma-client-js` to `prisma-client` with mandatory `output` field (`src/generated/prisma`)
- Installed `@prisma/adapter-pg` for Prisma 7 direct database connection support
- Port conflict: local PostgreSQL 16 (Windows) was running on port 5432, conflicting with Docker container. Changed Docker PostgreSQL port to 5434 via `POSTGRES_PORT=5434` in `.env`
- GENERATED ALWAYS AS columns for `inventario_atual` (quantidade_total, valor_total_estoque) added via custom SQL migration since Prisma doesn't support them natively
- GIN indexes on JSONB columns (parametros, resultado_resumo, valor) also added via custom SQL migration
- `prisma init` created a local `.env` in `apps/api/` with placeholder credentials — updated to point to correct database
- Added `src/generated/` to `apps/api/.gitignore` (Prisma client is regenerated, not versioned)

### File List

**Created:**
- `apps/api/prisma/schema.prisma` — Complete schema: 26 models, 24 enums, all indexes, relations, and constraints
- `apps/api/prisma/migrations/20260225214128_initial_schema/migration.sql` — Auto-generated: 26 tables, 24 enums, all FKs and indexes
- `apps/api/prisma/migrations/20260225214200_add_generated_columns_and_gin_indexes/migration.sql` — Custom: GENERATED columns + GIN indexes
- `apps/api/prisma.config.ts` — Prisma 7 config (auto-generated by `prisma init`, modified with correct datasource URL)
- `apps/api/src/generated/prisma/` — Generated Prisma client (gitignored)

**Modified:**
- `apps/api/package.json` — Added `@prisma/client`, `@prisma/adapter-pg` to dependencies; `prisma` to devDependencies
- `apps/api/.gitignore` — Added `src/generated/` exclusion
- `apps/api/.env` — Updated DATABASE_URL to correct credentials and port
- `.env` (root) — Changed POSTGRES_PORT from 5432 to 5434, updated DATABASE_URL
- `pnpm-lock.yaml` — Updated with new dependencies

## QA Results
(To be populated by QA agent)
