# Story 1.6: BOM CRUD, Tree & Exploded Cost

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** production engineer,
**I want** to manage Bills of Materials (BOM) with tree visualization and exploded cost display,
**so that** I can define product structures and validate component costs before production planning.

## Acceptance Criteria

1. `POST /api/v1/bom` creates a new BOM line linking parent-child products
2. `GET /api/v1/bom` returns paginated BOM lines with filter by produtoPaiId
3. `GET /api/v1/bom/:id` returns a single BOM line with product relations
4. `PATCH /api/v1/bom/:id` updates BOM line fields
5. `DELETE /api/v1/bom/:id` soft-deletes the BOM line (ativo: false)
6. `GET /api/v1/bom/tree/:produtoId` returns the full multi-level BOM tree for a product
7. `GET /api/v1/bom/cost/:produtoId` returns the exploded cost for a product (recursive sum of component costs with loss)
8. Circular reference detection prevents a product from being its own ancestor
9. Loss percentage is applied in cost calculation: lineCost = childCost * qty * (1 + loss/100)
10. Quantity must be > 0, loss percentage must be 0-100%
11. BOM module requires operator role for write, viewer for read, admin for delete
12. All services are covered by unit tests with >= 80% coverage

## Tasks / Subtasks

- [x] **Task 1: Create BOM DTOs** (AC: 1, 2, 10)
  - [x] `create-bom.dto.ts` with validation
  - [x] `update-bom.dto.ts` (PartialType)
  - [x] `filter-bom.dto.ts` (extends PaginationDto)

- [x] **Task 2: Create BOM Repository** (AC: 1-5)
  - [x] CRUD with Prisma, include product relations
  - [x] findByProdutoPaiId for tree building

- [x] **Task 3: Create BOM Service** (AC: 6-9)
  - [x] CRUD delegation to repository
  - [x] buildTree: recursive multi-level BOM tree
  - [x] calculateExplodedCost: recursive cost roll-up with loss
  - [x] detectCircularReference: prevent circular BOM

- [x] **Task 4: Create BOM Controller** (AC: 1-7, 11)
  - [x] Standard CRUD endpoints
  - [x] GET /bom/tree/:produtoId
  - [x] GET /bom/cost/:produtoId

- [x] **Task 5: Create BOM Module and register in AppModule** (AC: all)

- [x] **Task 6: Write Unit Tests** (AC: 12)
  - [x] Repository tests
  - [x] Service tests (tree building, cost calculation, circular detection)
  - [x] Controller tests

## Dev Notes

### Dependencies
- **Story 1.3** (Produto model, custoUnitario field)
- **Story 1.1** (PrismaService, common infrastructure)

### Exploded Cost Formula
```
lineCost = childProduct.custoUnitario * bom.quantidade * (1 + bom.perdaPercentual/100)
totalCost = sum of all lineCosts at all levels (recursive)
```

### Tree Response Shape
```json
{
  "produtoId": "uuid",
  "codigo": "SKU-001",
  "descricao": "Produto Acabado",
  "children": [
    {
      "bomId": "uuid",
      "produtoId": "uuid",
      "codigo": "MP-001",
      "descricao": "Materia Prima",
      "quantidade": 0.5,
      "perdaPercentual": 2,
      "children": []
    }
  ]
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created during greenfield-fullstack workflow engine | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- No errors encountered — clean implementation

### Completion Notes List
- 27 new tests passing (7 repo, 12 service, 8 controller)
- 181/181 total tests passing across 26 suites
- Build clean, no TypeScript errors
- Multi-level BOM tree traversal with recursive algorithm
- Exploded cost with loss calculation: lineCost = cost * qty * (1 + loss/100)
- Circular reference detection prevents cycles in BOM hierarchy
- Tree/cost routes placed before :id route to avoid path conflicts

### File List

**Created:**
- `apps/api/src/modules/bom/dto/create-bom.dto.ts`
- `apps/api/src/modules/bom/dto/update-bom.dto.ts`
- `apps/api/src/modules/bom/dto/filter-bom.dto.ts`
- `apps/api/src/modules/bom/bom.repository.ts`
- `apps/api/src/modules/bom/bom.repository.spec.ts`
- `apps/api/src/modules/bom/bom.service.ts`
- `apps/api/src/modules/bom/bom.service.spec.ts`
- `apps/api/src/modules/bom/bom.controller.ts`
- `apps/api/src/modules/bom/bom.controller.spec.ts`
- `apps/api/src/modules/bom/bom.module.ts`

**Modified:**
- `apps/api/src/app.module.ts` (added BomModule)

## QA Results
(To be populated by QA agent)
