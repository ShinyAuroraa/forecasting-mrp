# Story 4.9: What-If Scenario Analysis

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** demand planner,
**I want** to create what-if scenarios by adjusting forecast parameters with sliders and seeing the impact on MRP results,
**so that** I can evaluate different demand assumptions before committing to a plan.

## References

- FR-057: What-If Scenario Analysis
- [Source: architecture/3-frontend-architecture.md#3.1 — forecast/scenarios/page.tsx]

## Acceptance Criteria

### Scenario Creation (FR-057)
- [x] AC-1: User can create a named scenario based on the current forecast baseline
- [x] AC-2: Slider-based adjustment: global demand multiplier (0.5x to 2.0x, step 0.05)
- [x] AC-3: Per-class adjustment: separate sliders for Class A, B, C demand multipliers
- [x] AC-4: Per-SKU override: manually set demand for specific SKUs in the scenario
- [x] AC-5: Scenario saved with name, description, adjustments, and creation date

### Impact Visualization
- [x] AC-6: Side-by-side comparison: baseline vs scenario forecast line chart
- [x] AC-7: Impact on total planned orders (purchase + production) count and value
- [x] AC-8: Impact on capacity utilization (work centers affected by demand change)
- [x] AC-9: Impact on inventory investment (total projected stock value)

### Scenario Management
- [x] AC-10: `GET /scenarios` — list saved scenarios
- [x] AC-11: `POST /scenarios` — create new scenario with adjustments
- [x] AC-12: `GET /scenarios/:id/impact` — compute impact analysis for a scenario
- [x] AC-13: `DELETE /scenarios/:id` — delete scenario

### Frontend
- [x] AC-14: `/forecast/scenarios` page with scenario list and creation wizard
- [x] AC-15: Slider controls with real-time preview of adjusted demand curves
- [x] AC-16: Impact summary cards showing delta vs baseline
- [x] AC-17: Comparison chart (ECharts) overlaying baseline and scenario forecasts

### Testing
- [x] AC-18: Backend unit tests for scenario computation and impact analysis (80%+ coverage)
- [x] AC-19: Frontend render tests for scenario components

## Dev Notes

### Scenario Computation

```typescript
// Apply multiplier to baseline forecast
adjustedDemand[sku][week] = baselineDemand[sku][week] * multiplier(classOf(sku))

// Override for specific SKUs
if (overrides[sku]) adjustedDemand[sku] = overrides[sku]

// Run lightweight MRP simulation (read-only, no persist)
impact = simulateMrp(adjustedDemand, currentStockParams, currentCapacity)
```

### File Locations

**Backend:**
- `apps/api/src/modules/scenarios/` — module, controller, service
- `apps/api/src/modules/scenarios/scenario.service.ts` — computation engine

**Frontend:**
- `apps/web/src/app/forecast/scenarios/page.tsx`
- `apps/web/src/app/forecast/scenarios/components/scenario-sliders.tsx`
- `apps/web/src/app/forecast/scenarios/components/impact-summary.tsx`
- `apps/web/src/app/forecast/scenarios/components/comparison-chart.tsx`
- `apps/web/src/hooks/use-scenarios.ts`

---

## Tasks / Subtasks

- [x] **Task 1: Create scenario types and storage via ConfigSistema** (AC: 5)
- [x] **Task 2: Implement scenario CRUD API** (AC: 10, 11, 13)
- [x] **Task 3: Implement impact analysis computation** (AC: 6-9, 12)
- [x] **Task 4: Create scenario slider controls with real-time preview** (AC: 2, 3, 4, 15)
- [x] **Task 5: Create impact summary and comparison chart** (AC: 16, 17)
- [x] **Task 6: Assemble scenarios page** (AC: 14)
- [x] **Task 7: Write backend unit tests** (AC: 18)
- [x] **Task 8: Write frontend render tests** (AC: 19)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/scenarios/scenario.types.ts` | Created | Types, constants, interfaces for scenarios and impact |
| `apps/api/src/modules/scenarios/dto/create-scenario.dto.ts` | Created | Validated DTO with @Min/@Max multiplier constraints |
| `apps/api/src/modules/scenarios/scenario.service.ts` | Created | CRUD via ConfigSistema + impact analysis engine |
| `apps/api/src/modules/scenarios/scenario.controller.ts` | Created | 4 endpoints: GET list, POST create, GET impact, DELETE |
| `apps/api/src/modules/scenarios/scenario.module.ts` | Created | NestJS module registration |
| `apps/api/src/modules/scenarios/__tests__/scenario.service.spec.ts` | Created | 11 tests: CRUD + impact analysis |
| `apps/api/src/modules/scenarios/__tests__/scenario.controller.spec.ts` | Created | 4 tests: controller endpoint delegation |
| `apps/api/src/app.module.ts` | Modified | Registered ScenarioModule |
| `apps/web/src/types/scenario.ts` | Created | Frontend types + DEFAULT_ADJUSTMENTS |
| `apps/web/src/hooks/use-scenarios.ts` | Created | 4 React Query hooks: list, create, impact, delete |
| `apps/web/src/app/forecast/scenarios/page.tsx` | Created | Scenarios page with wizard + list + impact display |
| `apps/web/src/app/forecast/scenarios/components/scenario-sliders.tsx` | Created | Global + per-class ABC sliders |
| `apps/web/src/app/forecast/scenarios/components/impact-summary.tsx` | Created | 4 delta cards: orders, value, capacity, inventory |
| `apps/web/src/app/forecast/scenarios/components/comparison-chart.tsx` | Created | Baseline vs scenario ECharts line chart |
| `apps/web/src/app/forecast/scenarios/__tests__/scenarios-page.test.tsx` | Created | 6 tests: render, list, actions |

---

## Dependencies

- Story 2.6: Forecast Execution Pipeline (baseline forecast data)
- Story 3.10: MRP Orchestrator (MRP simulation for impact analysis)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Full implementation: types, DTO with validation, service (CRUD + impact engine), controller, module, 3 frontend components, hooks, page, 15 backend + 6 frontend tests (19/19 ACs) | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: corrected import path (DTO class), added @MaxLength/@ArrayMaxSize/@Min/@Max validators, TOCTOU fix (delete with P2025 catch), take:500 forecast limit, error handling on create, delete confirmation dialog | Quinn (QA) |
