# Story 2.5: Feature Engineering & LightGBM Ensemble

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["pytest", "ruff", "mypy"]

## Story

**As a** demand planner,
**I want** LightGBM quantile regression and a weighted ensemble (TFT 0.6 + LGBM 0.4) for Class A SKUs,
**so that** high-value products benefit from model combination that reduces individual error risk.

## References

- FR-022: Model Selection Matrix (ensemble for Class A)
- FR-056: Ensemble Model (TFT 0.6 + LGBM 0.4)

## Acceptance Criteria

1. [x] LightGBM model implements AbstractForecastModel interface
2. [x] Feature matrix built from lag features (1w, 2w, 4w, 8w, 13w) and rolling stats (4w, 13w)
3. [x] LGBM generates quantile forecasts (P10-P90) via quantile regression
4. [x] Ensemble model combines TFT and LGBM with weighted quantile averaging
5. [x] Default weights: TFT 0.6, LGBM 0.4
6. [x] Custom weights supported
7. [x] Ensemble delegates train/backtest to sub-models
8. [x] Unit tests >= 80% coverage

## File List

| File | Action |
|------|--------|
| `apps/forecast-engine/src/models/lgbm/__init__.py` | Created |
| `apps/forecast-engine/src/models/lgbm/lgbm_model.py` | Created |
| `apps/forecast-engine/src/models/ensemble/__init__.py` | Created |
| `apps/forecast-engine/src/models/ensemble/ensemble_model.py` | Created |
| `apps/forecast-engine/tests/test_lgbm_model.py` | Created |
| `apps/forecast-engine/tests/test_ensemble_model.py` | Created |

## Quality Gate Results

| Gate | Result |
|------|--------|
| ruff check | PASS — 0 errors |
| mypy --strict | PASS — 0 issues (4 files) |
| pytest | PASS — 21/21 tests |
| Coverage (lgbm_model.py) | 98% |
| Coverage (ensemble_model.py) | 91% |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |
| 2026-02-26 | 1.0 | Implementation complete, all quality gates pass | Dex (Dev) |
