# Story 4.1: Ingestion Mapping Templates

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** system administrator,
**I want** to create and manage reusable column mapping templates for recurring data sources,
**so that** daily ingestion can automatically apply the correct mapping without manual intervention.

## References

- FR-061: Ingestion Mapping Template
- [Source: architecture/9-integration-patterns.md]
- [Source: architecture/4-backend-architecture.md]

## Acceptance Criteria

### Template CRUD (FR-061)
- [x] AC-1: Admin can create a mapping template with name, source type (CSV/XLSX/API/DB), and column mappings
- [x] AC-2: Column mapping defines: source column name → target field, data type, transformation rule (optional), validation rule (optional)
- [x] AC-3: Templates are persisted in `config_sistema` or a dedicated `mapping_template` table
- [x] AC-4: Admin can list, edit, and delete mapping templates
- [x] AC-5: Admin can duplicate an existing template as a starting point

### Template Application
- [x] AC-6: When uploading a file, system suggests matching templates based on column headers
- [x] AC-7: Selected template auto-maps columns; user can override individual mappings before confirming
- [x] AC-8: Template tracks last used date and usage count for sorting

### API Endpoints
- [x] AC-9: `GET /ingestion/templates` — list all templates (paginated)
- [x] AC-10: `POST /ingestion/templates` — create template
- [x] AC-11: `PUT /ingestion/templates/:id` — update template
- [x] AC-12: `DELETE /ingestion/templates/:id` — delete template

### Frontend
- [x] AC-13: `/ingestao/templates` page with template list and CRUD form
- [x] AC-14: Column mapping editor with drag-and-drop or select-based mapping UI

### Testing
- [x] AC-15: Backend unit tests for template CRUD service (80%+ coverage)
- [x] AC-16: Frontend render tests for template management components

## Dev Notes

### Data Model

```typescript
interface MappingTemplate {
  id: string;
  nome: string;
  tipoFonte: 'CSV' | 'XLSX' | 'API' | 'DB';
  colunas: ColumnMapping[];
  validationRules: ValidationRule[];
  lastUsedAt: Date | null;
  usageCount: number;
  createdAt: Date;
  updatedAt: Date;
}

interface ColumnMapping {
  sourceColumn: string;
  targetField: string;
  dataType: 'string' | 'number' | 'date' | 'boolean';
  transformation?: string; // e.g., 'trim', 'uppercase', 'parseDate(dd/MM/yyyy)'
  required: boolean;
}
```

### File Locations

**Backend:**
- `apps/api/src/modules/ingestion/` — module, controller, service, DTOs
- `apps/api/prisma/` — migration for mapping_template table

**Frontend:**
- `apps/web/src/app/ingestao/templates/page.tsx`
- `apps/web/src/app/ingestao/templates/components/`

---

## Tasks / Subtasks

- [x] **Task 1: Create Prisma model and migration for mapping templates** (AC: 3)
- [x] **Task 2: Implement backend CRUD service and controller** (AC: 9-12)
- [x] **Task 3: Add template suggestion logic based on column headers** (AC: 6, 7)
- [x] **Task 4: Implement frontend template list and CRUD form** (AC: 13, 14)
- [x] **Task 5: Implement column mapping editor UI** (AC: 1, 2, 14)
- [x] **Task 6: Add template application to file upload flow** (AC: 6, 7, 8)
- [x] **Task 7: Write backend unit tests** (AC: 15)
- [x] **Task 8: Write frontend render tests** (AC: 16)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added TipoFonte enum and MappingTemplate model |
| `apps/api/prisma/migrations/20260227010000_add_mapping_template/migration.sql` | Created | Migration for mapping_template table |
| `apps/api/src/modules/ingestao/dto/create-mapping-template.dto.ts` | Created | DTO for template creation with nested ColumnMappingDto |
| `apps/api/src/modules/ingestao/dto/update-mapping-template.dto.ts` | Created | DTO for template updates (all fields optional) |
| `apps/api/src/modules/ingestao/dto/filter-mapping-template.dto.ts` | Created | DTO for template filtering and pagination |
| `apps/api/src/modules/ingestao/mapping-template.repository.ts` | Created | Repository with CRUD + findByHeaders + incrementUsage |
| `apps/api/src/modules/ingestao/mapping-template.service.ts` | Created | Service with business logic and NotFoundException handling |
| `apps/api/src/modules/ingestao/mapping-template.controller.ts` | Created | REST controller: GET/POST/PUT/DELETE + duplicate + suggest |
| `apps/api/src/modules/ingestao/ingestao.module.ts` | Modified | Registered MappingTemplate controller/service/repository |
| `apps/api/src/modules/ingestao/ingestao-upload.service.ts` | Modified | Now accepts optional templateId, builds dynamic column map |
| `apps/api/src/modules/ingestao/ingestao.controller.ts` | Modified | Upload endpoint accepts templateId + suggest-template endpoint |
| `apps/api/src/modules/ingestao/mapping-template.service.spec.ts` | Created | Service unit tests (8 test cases) |
| `apps/api/src/modules/ingestao/mapping-template.controller.spec.ts` | Created | Controller unit tests (7 test cases) |
| `apps/api/src/modules/ingestao/mapping-template.repository.spec.ts` | Created | Repository unit tests (10 test cases) |
| `apps/web/src/types/ingestion.ts` | Created | TypeScript interfaces for mapping templates |
| `apps/web/src/hooks/use-ingestion-templates.ts` | Created | React Query hooks for template CRUD + suggest |
| `apps/web/src/app/ingestao/templates/page.tsx` | Created | Template management page with list/create/edit views |
| `apps/web/src/app/ingestao/templates/components/template-list.tsx` | Created | Table component for template listing |
| `apps/web/src/app/ingestao/templates/components/template-form.tsx` | Created | Form component for create/edit with column mapping |
| `apps/web/src/app/ingestao/templates/components/column-mapping-editor.tsx` | Created | Interactive column mapping editor with add/remove rows |
| `apps/web/src/app/ingestao/__tests__/templates-page.test.tsx` | Created | Frontend render tests (10 test cases) |
| `apps/api/src/modules/ingestao/dto/suggest-templates.dto.ts` | Created | Validated DTO for suggest endpoint |

---

## Dependencies

- Story 1.10: Data Ingestion Pipeline (existing upload + mapping infrastructure)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Implementation: Prisma model, backend CRUD, template suggestion, upload integration, frontend page, tests | Dex (Dev) |
| 2026-02-27 | 0.3 | QA fixes: route collision, suggest DTO validation, ColumnMappingEditor single source of truth, sortBy allowlist, findById active filter, dataType @IsIn, ativo Transform, extractHeaders XLSX support, DELETE 204 | Dex (Dev) |
