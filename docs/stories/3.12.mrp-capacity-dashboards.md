# Story 3.12: MRP & Capacity Dashboards

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** MRP Gantt, MRP Detail Table, Stock Projection Chart, and Capacity Dashboard visualizations,
**so that** I can visually analyze the MRP plan, drill into individual SKU requirements, monitor projected stock levels, and identify capacity constraints.

## References

- FR-043: MRP Dashboard (Gantt)
- FR-044: MRP Detail Table
- FR-045: Stock Projection Chart
- FR-046: Capacity Dashboard
- [Source: architecture/3-frontend-architecture.md#3.1 — mrp/ pages]

## Acceptance Criteria

### MRP Gantt (FR-043)
- [x] AC-1: `/mrp` page displays a Gantt timeline chart for planned orders
- [x] AC-2: Purchase orders displayed as blue bars; production orders as green bars
- [x] AC-3: Gantt x-axis = weekly periods (planning horizon), y-axis = SKUs or work centers
- [x] AC-4: Clicking a bar shows order details (quantity, dates, supplier/work center, cost)

### MRP Detail Table (FR-044)
- [x] AC-5: `/mrp/detail` page with SKU selector dropdown
- [x] AC-6: For selected SKU, display MRP grid table: columns = periods (weeks), rows = Gross Req, Scheduled Receipts, Projected Stock, Net Req, Planned Orders
- [x] AC-7: Cell values color-coded: red for negative projected stock, orange for below safety stock

### Stock Projection Chart (FR-045)
- [x] AC-8: `/mrp/stock` page with per-SKU stock projection line chart
- [x] AC-9: Chart shows projected stock line over planning horizon
- [x] AC-10: Horizontal reference lines for Safety Stock (SS), Reorder Point (ROP), and Max stock levels
- [x] AC-11: Areas below SS highlighted in red, between SS and ROP highlighted in yellow

### Capacity Dashboard (FR-046)
- [x] AC-12: `/mrp/capacity` page with capacity visualizations
- [x] AC-13: Stacked bar chart: planned load vs available capacity per work center per week
- [x] AC-14: Weekly heatmap: cells colored by utilization percentage (green < 80%, yellow 80-100%, orange 100-110%, red > 110%)
- [x] AC-15: Warehouse gauge: circular gauge showing current/projected storage utilization per deposito
- [x] AC-16: Overload alerts list: work centers with utilization > 100%, showing suggestion (HORA_EXTRA/ANTECIPAR/SUBCONTRATAR)

### General
- [x] AC-17: All pages include an execution selector to switch between MRP runs
- [x] AC-18: All charts use Apache ECharts (via chart-base.tsx wrapper)
- [x] AC-19: All pages are responsive and work on desktop (1280px+)
- [x] AC-20: Frontend components have basic render tests

## Dev Notes

### Architecture References
- [Source: architecture/3-frontend-architecture.md#3.1 — mrp/ pages]
- [Source: architecture/3-frontend-architecture.md#3.5 — ECharts integration pattern]
- [Source: architecture/3-frontend-architecture.md#3.8 — Route mapping]

### API Endpoints Used

| Page | API Endpoint | Data |
|------|-------------|------|
| MRP Gantt | GET /mrp/orders?execucaoId=X | All planned orders for Gantt bars |
| MRP Detail | GET /mrp/orders?execucaoId=X&produtoId=Y | Orders for selected SKU |
| MRP Detail | GET /mrp/stock-params?execucaoId=X&produtoId=Y | SS/ROP for grid display |
| Stock Projection | GET /mrp/stock-params?execucaoId=X&produtoId=Y | SS/ROP/Max lines |
| Stock Projection | GET /mrp/orders?execucaoId=X&produtoId=Y | Planned receipts for projection |
| Capacity | GET /mrp/capacity?execucaoId=X | Capacity load data |

### Gantt Chart Configuration (ECharts)

```typescript
// ECharts custom chart for Gantt
const ganttOption = {
  tooltip: { trigger: 'item' },
  xAxis: { type: 'time', min: horizonStart, max: horizonEnd },
  yAxis: { type: 'category', data: skuList },
  series: [
    {
      type: 'custom',
      renderItem: (params, api) => {
        // Render blue rect for COMPRA, green rect for PRODUCAO
      },
      encode: { x: [0, 1], y: 2 }, // start, end, category
      data: ordersAsGanttBars,
    },
  ],
};
```

### MRP Grid Table Layout

```
| Period     | Week 1 | Week 2 | Week 3 | ... | Week 13 |
|------------|--------|--------|--------|-----|---------|
| Gross Req  |   100  |   150  |   120  |     |    80   |
| Sched Rec  |    50  |     0  |    80  |     |     0   |
| Proj Stock |   200  |    50  |    10  |     |   -20   | ← red
| Net Req    |     0  |   100  |    30  |     |   100   |
| Planned    |     0  |   100  |    50  |     |   100   |
```

### Stock Projection Chart Configuration

```typescript
const stockOption = {
  xAxis: { type: 'category', data: weekLabels },
  yAxis: { type: 'value', name: 'Quantity' },
  series: [
    { name: 'Projected Stock', type: 'line', data: projectedStockData },
    { name: 'Safety Stock', type: 'line', data: ssLine, lineStyle: { type: 'dashed', color: 'red' } },
    { name: 'Reorder Point', type: 'line', data: ropLine, lineStyle: { type: 'dashed', color: 'orange' } },
    { name: 'Max Stock', type: 'line', data: maxLine, lineStyle: { type: 'dashed', color: 'green' } },
  ],
  visualMap: {
    // Color areas below SS in red, between SS and ROP in yellow
  },
};
```

### Capacity Dashboard Components

1. **Stacked Bar Chart**: available (blue) + overload (red) per work center per week
2. **Heatmap**: work centers (y) x weeks (x), cell color = utilization %
3. **Gauge**: one gauge per warehouse, showing % of capacidadeM3 used
4. **Alert List**: overloaded work centers with badge (HORA_EXTRA/ANTECIPAR/SUBCONTRATAR)

### File Locations

**Frontend (new files):**
- `apps/web/src/app/(main)/mrp/page.tsx` — MRP Gantt page
- `apps/web/src/app/(main)/mrp/components/gantt-chart.tsx`
- `apps/web/src/app/(main)/mrp/components/execution-selector.tsx`
- `apps/web/src/app/(main)/mrp/detail/page.tsx` — MRP Detail page
- `apps/web/src/app/(main)/mrp/detail/components/mrp-grid-table.tsx`
- `apps/web/src/app/(main)/mrp/detail/components/sku-selector.tsx`
- `apps/web/src/app/(main)/mrp/stock/page.tsx` — Stock Projection page
- `apps/web/src/app/(main)/mrp/stock/components/stock-projection-chart.tsx`
- `apps/web/src/app/(main)/mrp/capacity/page.tsx` — Capacity Dashboard page
- `apps/web/src/app/(main)/mrp/capacity/components/capacity-bar-chart.tsx`
- `apps/web/src/app/(main)/mrp/capacity/components/utilization-heatmap.tsx`
- `apps/web/src/app/(main)/mrp/capacity/components/warehouse-gauge.tsx`
- `apps/web/src/app/(main)/mrp/capacity/components/overload-alerts.tsx`
- `apps/web/src/lib/queries/mrp.ts` — React Query hooks for MRP data

### Testing Requirements

**Frontend render test cases:**
1. MRP Gantt page renders with chart container
2. MRP Detail page renders with SKU selector and grid table
3. Stock Projection page renders with chart and reference lines
4. Capacity Dashboard renders with all four visualization sections
5. Execution selector renders with dropdown options
6. MRP grid table renders with correct row labels

### Technical Constraints
- All charts use ECharts dynamic import (SSR-safe via chart-base.tsx wrapper)
- Gantt uses ECharts custom series (not a built-in chart type)
- Heatmap uses ECharts heatmap chart type
- Gauge uses ECharts gauge chart type
- Data fetching via React Query hooks (staleTime: 5 min)
- Color coding: Purchase = blue (#3B82F6), Production = green (#10B981)
- Overload colors: OK = green, HORA_EXTRA = yellow, ANTECIPAR = orange, SUBCONTRATAR = red

---

## Tasks / Subtasks

- [x] **Task 1: Create shared execution selector component** (AC: 17)
  - [x] Reused ExecutionSelector from purchasing module
  - [x] Created SkuSelector for Detail/Stock pages
  - [x] Created ChartBase ECharts wrapper

- [x] **Task 2: Create React Query hooks for MRP data** (AC: all)
  - [x] useMrpOrders(execucaoId, filters)
  - [x] useMrpCapacity(execucaoId, filters)
  - [x] useMrpStockParams(execucaoId, produtoId)
  - [x] useMrpExecutions() (reused from use-purchasing.ts)

- [x] **Task 3: Implement MRP Gantt page** (AC: 1-4)
  - [x] Page with execution selector
  - [x] Gantt chart with ECharts custom series
  - [x] Blue bars for COMPRA, green bars for PRODUCAO
  - [x] Tooltip on bar click showing order details

- [x] **Task 4: Implement MRP Detail page** (AC: 5-7)
  - [x] SKU selector dropdown
  - [x] MRP grid table (Gross Req, Scheduled Receipts, Projected Stock, Net Req, Planned Orders x Periods)
  - [x] Color coding: red for negative stock, orange for below SS

- [x] **Task 5: Implement Stock Projection page** (AC: 8-11)
  - [x] SKU selector
  - [x] Line chart with projected stock
  - [x] Dashed reference lines for SS, ROP, Max
  - [x] Area highlighting below SS (red) and between SS-ROP (yellow)

- [x] **Task 6: Implement Capacity Dashboard page** (AC: 12-16)
  - [x] Stacked bar chart (load vs capacity)
  - [x] Weekly heatmap (utilization %)
  - [x] Warehouse gauge (storage utilization)
  - [x] Overload alerts list with suggestion badges

- [x] **Task 7: Write frontend render tests** (AC: 20)
  - [x] 24 render test cases across 6 test suites

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/web/src/types/mrp.ts` | Created | TypeScript interfaces for all MRP dashboard data |
| `apps/web/src/hooks/use-mrp.ts` | Created | React Query hooks: useMrpOrders, useMrpCapacity, useMrpStockParams |
| `apps/web/src/components/charts/chart-base.tsx` | Created | Reusable ECharts wrapper with SSR-safe dynamic import |
| `apps/web/src/components/mrp/sku-selector.tsx` | Created | SKU selector dropdown for Detail/Stock pages |
| `apps/web/src/app/mrp/page.tsx` | Created | MRP Gantt page with execution selector |
| `apps/web/src/app/mrp/components/gantt-chart.tsx` | Created | Gantt timeline chart (ECharts custom series) |
| `apps/web/src/app/mrp/detail/page.tsx` | Created | MRP Detail page with SKU selector and grid |
| `apps/web/src/app/mrp/detail/components/mrp-grid-table.tsx` | Created | MRP grid table with color-coded cells |
| `apps/web/src/app/mrp/stock/page.tsx` | Created | Stock Projection page |
| `apps/web/src/app/mrp/stock/components/stock-projection-chart.tsx` | Created | Line chart with SS/ROP/Max reference lines |
| `apps/web/src/app/mrp/capacity/page.tsx` | Created | Capacity Dashboard page (4 visualizations) |
| `apps/web/src/app/mrp/capacity/components/capacity-bar-chart.tsx` | Created | Stacked bar chart: load vs capacity |
| `apps/web/src/app/mrp/capacity/components/utilization-heatmap.tsx` | Created | Weekly utilization heatmap |
| `apps/web/src/app/mrp/capacity/components/warehouse-gauge.tsx` | Created | Circular gauge per deposito |
| `apps/web/src/app/mrp/capacity/components/overload-alerts.tsx` | Created | Overload alerts table with suggestion badges |
| `apps/web/src/lib/mrp-utils.ts` | Created | Shared MRP utility functions (getWeekStart, formatWeekLabel, escapeHtml) |
| `apps/web/src/app/mrp/__tests__/mrp-pages.test.tsx` | Created | 24 render tests across 6 suites |

---

## Dependencies

- Story 3.10: MRP Orchestrator & Execution API (all backend endpoints must be available)
- Story 3.9: CRP & Storage Capacity Validation (capacity data in carga_capacidade)
- Story 3.3: Stock Parameter Calculation (SS/ROP/Max values for stock projection)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-27 | 0.2 | Implementation complete — 16 files created, 0 modified, 24 tests (frontend) | Dex (Dev) |
| 2026-02-27 | 0.3 | QA fixes — shared mrp-utils.ts, XSS escaping, stock projection logic, capacity chart grouped bars, heatmap O(1) lookups, warehouse gauge wired, error states, ANTECIPAR badge orange, test mock updated (17 files) | Dex (Dev) |
