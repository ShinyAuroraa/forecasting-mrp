# Story 3.1: Production Routing & Factory Calendar CRUD

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production engineer,
**I want** to manage production routings (product-to-work-center operation sequences) and factory calendar entries,
**so that** the MRP engine can calculate production lead times and available working days for capacity planning.

## References

- FR-047: Production Routing CRUD
- FR-048: Factory Calendar Management
- [Source: architecture/4-backend-architecture.md#4.1 — capacidade module]

## Acceptance Criteria

- [x] AC-1: `POST /api/v1/roteiros` creates a production routing linking product, work center, sequence, operation, setup time, unit time, wait time
- [x] AC-2: `GET /api/v1/roteiros` returns paginated routings with filters (produtoId, centroTrabalhoId, ativo)
- [x] AC-3: `GET /api/v1/roteiros/:id` returns a single routing with product and work center relations
- [x] AC-4: `PATCH /api/v1/roteiros/:id` updates routing fields
- [x] AC-5: `DELETE /api/v1/roteiros/:id` soft-deletes the routing (ativo: false)
- [x] AC-6: `GET /api/v1/roteiros/produto/:produtoId` returns all routing steps for a product ordered by sequencia ASC
- [x] AC-7: Validation: sequencia must be unique per produtoId, tempoUnitarioMinutos > 0, tempoSetupMinutos >= 0, tempoEsperaMinutos >= 0
- [x] AC-8: `POST /api/v1/calendario` creates a factory calendar entry with date, type (UTIL/FERIADO/PONTO_FACULTATIVO/FERIAS_COLETIVAS/SABADO/DOMINGO), description, productive hours
- [x] AC-9: `GET /api/v1/calendario` returns paginated calendar entries with filters (date range, tipo)
- [x] AC-10: `PATCH /api/v1/calendario/:id` updates a calendar entry
- [x] AC-11: `DELETE /api/v1/calendario/:id` deletes a calendar entry
- [x] AC-12: `POST /api/v1/calendario/bulk` accepts an array of calendar entries for bulk creation (e.g., generate full year)
- [x] AC-13: `GET /api/v1/calendario/working-days?start=YYYY-MM-DD&end=YYYY-MM-DD` returns count of working days (tipo=UTIL) in a date range
- [x] AC-14: Calendar entries have unique date constraint (one entry per date)
- [x] AC-15: Module requires operator role for write, viewer for read
- [x] AC-16: All services are covered by unit tests with >= 80% coverage

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — capacidade/roteiros/ and capacidade/calendario/]
- [Source: architecture/6-data-architecture.md#6.2 — Capacity tables group]

### Data Models

**RoteiroProducao (Prisma model — already exists in schema):**
```prisma
model RoteiroProducao {
  id                   String  @id @default(uuid())
  produtoId            String  @map("produto_id")
  centroTrabalhoId     String  @map("centro_trabalho_id")
  sequencia            Int     @db.SmallInt
  operacao             String  @db.VarChar(100)
  tempoSetupMinutos    Decimal @default(0) @map("tempo_setup_minutos") @db.Decimal(8, 2)
  tempoUnitarioMinutos Decimal @map("tempo_unitario_minutos") @db.Decimal(8, 4)
  tempoEsperaMinutos   Decimal @default(0) @map("tempo_espera_minutos") @db.Decimal(8, 2)
  descricao            String? @db.Text
  ativo                Boolean @default(true)

  produto        Produto        @relation(fields: [produtoId], references: [id])
  centroTrabalho CentroTrabalho @relation(fields: [centroTrabalhoId], references: [id])
  @@map("roteiro_producao")
}
```

**CalendarioFabrica (Prisma model — already exists in schema):**
```prisma
model CalendarioFabrica {
  id              String                @id @default(uuid())
  data            DateTime              @unique @db.Date
  tipo            TipoCalendarioFabrica
  descricao       String?               @db.VarChar(100)
  horasProdutivas Decimal               @default(0) @map("horas_produtivas") @db.Decimal(4, 2)
  @@map("calendario_fabrica")
}
```

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /api/v1/roteiros | Create routing |
| GET | /api/v1/roteiros | List routings (paginated) |
| GET | /api/v1/roteiros/:id | Get routing detail |
| PATCH | /api/v1/roteiros/:id | Update routing |
| DELETE | /api/v1/roteiros/:id | Soft-delete routing |
| GET | /api/v1/roteiros/produto/:produtoId | Get routing steps for product |
| POST | /api/v1/calendario | Create calendar entry |
| GET | /api/v1/calendario | List calendar entries (paginated) |
| PATCH | /api/v1/calendario/:id | Update calendar entry |
| DELETE | /api/v1/calendario/:id | Delete calendar entry |
| POST | /api/v1/calendario/bulk | Bulk create calendar entries |
| GET | /api/v1/calendario/working-days | Count working days in range |

### UI Components
- `apps/web/src/app/(main)/cadastros/capacidade/roteiros/page.tsx` — Production Routing list (data table with product/work-center columns)
- `apps/web/src/app/(main)/mrp/calendar/page.tsx` — Factory Calendar management page

### File Locations

**Backend (new files):**
- `apps/api/src/modules/capacidade/roteiros/dto/create-roteiro.dto.ts`
- `apps/api/src/modules/capacidade/roteiros/dto/update-roteiro.dto.ts`
- `apps/api/src/modules/capacidade/roteiros/dto/filter-roteiro.dto.ts`
- `apps/api/src/modules/capacidade/roteiros/roteiros.repository.ts`
- `apps/api/src/modules/capacidade/roteiros/roteiros.service.ts`
- `apps/api/src/modules/capacidade/roteiros/roteiros.controller.ts`
- `apps/api/src/modules/capacidade/roteiros/roteiros.service.spec.ts`
- `apps/api/src/modules/capacidade/roteiros/roteiros.controller.spec.ts`
- `apps/api/src/modules/capacidade/calendario/dto/create-calendario.dto.ts`
- `apps/api/src/modules/capacidade/calendario/dto/update-calendario.dto.ts`
- `apps/api/src/modules/capacidade/calendario/dto/filter-calendario.dto.ts`
- `apps/api/src/modules/capacidade/calendario/calendario.repository.ts`
- `apps/api/src/modules/capacidade/calendario/calendario.service.ts`
- `apps/api/src/modules/capacidade/calendario/calendario.controller.ts`
- `apps/api/src/modules/capacidade/calendario/calendario.service.spec.ts`
- `apps/api/src/modules/capacidade/calendario/calendario.controller.spec.ts`

**Modified:**
- `apps/api/src/modules/capacidade/capacidade.module.ts` (register roteiros and calendario sub-modules)

### Testing Requirements
- Unit tests for roteiros service: CRUD operations, sequence uniqueness validation, findByProdutoId ordering
- Unit tests for calendario service: CRUD operations, bulk creation, working-days calculation, unique date enforcement
- Controller tests for both sub-modules
- Edge case: calendar bulk-create with overlapping dates should reject duplicates

### Technical Constraints
- Routing sequencia must be unique per produtoId (validate at service level, DB composite index recommended)
- Calendar data column is unique (one entry per date)
- horasProdutivas defaults to 0 for non-working days (FERIADO, SABADO, DOMINGO)
- Working days query: count entries WHERE tipo = 'UTIL' AND data BETWEEN start AND end

---

## Tasks / Subtasks

- [x] **Task 1: Create Roteiro DTOs** (AC: 1, 2, 7)
  - [x] `create-roteiro.dto.ts` with validation (produtoId, centroTrabalhoId UUID, sequencia Int, operacao String, tempoSetupMinutos >= 0, tempoUnitarioMinutos > 0, tempoEsperaMinutos >= 0)
  - [x] `update-roteiro.dto.ts` (PartialType)
  - [x] `filter-roteiro.dto.ts` (extends PaginationDto, optional produtoId, centroTrabalhoId, ativo)

- [x] **Task 2: Create Roteiro Repository** (AC: 1-6)
  - [x] CRUD with Prisma, include produto and centroTrabalho relations
  - [x] findByProdutoId: ordered by sequencia ASC
  - [x] checkSequenceUnique: verify no duplicate sequencia for same produtoId

- [x] **Task 3: Create Roteiro Service** (AC: 1-7)
  - [x] CRUD with sequence uniqueness validation
  - [x] findByProdutoId returning ordered routing steps
  - [x] Soft-delete (set ativo = false)

- [x] **Task 4: Create Roteiro Controller** (AC: 1-6, 15)
  - [x] Standard CRUD endpoints under /roteiros
  - [x] GET /roteiros/produto/:produtoId (placed before :id route)
  - [x] Role guards: operator for write, viewer for read

- [x] **Task 5: Create Calendario DTOs** (AC: 8, 9, 12)
  - [x] `create-calendario.dto.ts` (data Date, tipo enum, descricao optional, horasProdutivas Decimal)
  - [x] `update-calendario.dto.ts` (PartialType)
  - [x] `filter-calendario.dto.ts` (extends PaginationDto, optional dateStart, dateEnd, tipo)

- [x] **Task 6: Create Calendario Repository** (AC: 8-14)
  - [x] CRUD with Prisma
  - [x] bulkCreate: createMany with skipDuplicates
  - [x] countWorkingDays: count where tipo = UTIL and data between start/end

- [x] **Task 7: Create Calendario Service** (AC: 8-14)
  - [x] CRUD with unique date validation
  - [x] Bulk creation with duplicate rejection
  - [x] Working days calculation

- [x] **Task 8: Create Calendario Controller** (AC: 8-13, 15)
  - [x] Standard CRUD endpoints under /calendario
  - [x] POST /calendario/bulk
  - [x] GET /calendario/working-days?start=&end=
  - [x] Role guards

- [x] **Task 9: Register in CentrosTrabalhoModule** (AC: all)
  - [x] Add RoteirosService, RoteirosController, RoteirosRepository to CentrosTrabalhoModule
  - [x] Add CalendarioService, CalendarioController, CalendarioRepository to CentrosTrabalhoModule

- [x] **Task 10: Write Unit Tests** (AC: 16)
  - [x] Roteiro service tests (13 tests — CRUD, sequence validation, findByProdutoId)
  - [x] Roteiro controller tests (8 tests — all endpoints + error propagation)
  - [x] Calendario service tests (12 tests — CRUD, bulk, working-days)
  - [x] Calendario controller tests (14 tests — all endpoints + validation)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/centros-trabalho/roteiros/dto/create-roteiro.dto.ts` | Created | Create DTO with class-validator |
| `apps/api/src/modules/centros-trabalho/roteiros/dto/update-roteiro.dto.ts` | Created | PartialType of CreateRoteiroDto |
| `apps/api/src/modules/centros-trabalho/roteiros/dto/filter-roteiro.dto.ts` | Created | Filter DTO extending PaginationDto |
| `apps/api/src/modules/centros-trabalho/roteiros/roteiros.repository.ts` | Created | Prisma repository with CRUD + findByProdutoId |
| `apps/api/src/modules/centros-trabalho/roteiros/roteiros.service.ts` | Created | Service with sequence uniqueness validation |
| `apps/api/src/modules/centros-trabalho/roteiros/roteiros.controller.ts` | Created | REST controller with role guards |
| `apps/api/src/modules/centros-trabalho/roteiros/roteiros.service.spec.ts` | Created | 13 unit tests for service |
| `apps/api/src/modules/centros-trabalho/roteiros/roteiros.controller.spec.ts` | Created | 8 unit tests for controller |
| `apps/api/src/modules/centros-trabalho/calendario/dto/create-calendario.dto.ts` | Created | Create DTO with TipoCalendarioFabrica enum |
| `apps/api/src/modules/centros-trabalho/calendario/dto/update-calendario.dto.ts` | Created | PartialType of CreateCalendarioDto |
| `apps/api/src/modules/centros-trabalho/calendario/dto/filter-calendario.dto.ts` | Created | Filter DTO with date range + tipo |
| `apps/api/src/modules/centros-trabalho/calendario/calendario.repository.ts` | Created | Prisma repository with bulkCreate + countWorkingDays |
| `apps/api/src/modules/centros-trabalho/calendario/calendario.service.ts` | Created | Service with bulk create + working days |
| `apps/api/src/modules/centros-trabalho/calendario/calendario.controller.ts` | Created | REST controller with bulk + working-days endpoints |
| `apps/api/src/modules/centros-trabalho/calendario/calendario.service.spec.ts` | Created | 12 unit tests for service |
| `apps/api/src/modules/centros-trabalho/calendario/calendario.controller.spec.ts` | Created | 14 unit tests for controller |
| `apps/api/src/modules/centros-trabalho/centros-trabalho.module.ts` | Modified | Added roteiros + calendario providers/controllers/exports |

---

## Dependencies

- Story 1.7: Work Center & Shift Management (CentroTrabalho model must exist)
- Story 1.3: Product CRUD (Produto model must exist)
- Story 0.3: Database Schema (Prisma schema with RoteiroProducao and CalendarioFabrica models)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-26 | 0.2 | Implementation complete — 16 files created, 1 modified, 47 tests passing | Dex (Dev) |
| 2026-02-26 | 0.3 | QA Review PASS — 16/16 AC verified, 0 critical issues, 4 recommendations | Quinn (QA) |
