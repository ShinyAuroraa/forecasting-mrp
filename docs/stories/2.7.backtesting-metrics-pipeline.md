# Story 2.7: Backtesting & Metrics Pipeline

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["pytest", "ruff", "mypy"]

## Story

**As a** demand planner,
**I want** an automated backtesting pipeline that evaluates forecast accuracy per SKU and per class,
**so that** I can compare models against a baseline and track model metadata over time.

## References

- FR-029: Backtesting Pipeline (Train T-13, predict 13w, compare actual)
- FR-032: Forecast Metrics Storage (MAPE, MAE, RMSE per SKU, aggregated per class)
- FR-033: Model Metadata Storage (version, parameters, training metrics, training date)

## Acceptance Criteria

1. [x] Backtester orchestrator runs backtest across all models for given products
2. [x] Metrics aggregated per ABC class (A, B, C)
3. [x] Baseline comparison against 12-week moving average
4. [x] Model metadata dataclass tracks version, parameters, training metrics
5. [x] Pipeline Step 8 integrated with backtester (no longer SKIPPED)
6. [x] Backtester returns per-product and per-class metrics
7. [x] Unit tests >= 80% coverage

## File List

| File | Action |
|------|--------|
| `apps/forecast-engine/src/backtesting/metrics.py` | Created |
| `apps/forecast-engine/src/backtesting/backtester.py` | Created |
| `apps/forecast-engine/src/models/base.py` | Modified (added series_by_product to backtest signature) |
| `apps/forecast-engine/src/pipeline/executor.py` | Modified (integrated Step 8 with Backtester) |
| `apps/forecast-engine/tests/test_backtesting_metrics.py` | Created |
| `apps/forecast-engine/tests/test_backtester.py` | Created |

## Quality Gate Results

| Gate | Result |
|------|--------|
| ruff check | PASS — 0 errors |
| mypy --strict | PASS — 0 issues |
| pytest | PASS — 178/178 tests (26 new) |
| Coverage (metrics.py) | 100% |
| Coverage (backtester.py) | 98% |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |
| 2026-02-26 | 1.0 | Implementation complete, all quality gates pass | Dex (Dev) |
