# Story 3.10: MRP Orchestrator & Execution API

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** a single API endpoint that orchestrates a complete MRP run (MPS -> Stock Params -> BOM Explosion -> Netting -> Lot Sizing -> Order Generation -> Action Messages -> CRP -> Storage Validation) and tracks execution progress,
**so that** I can trigger the full MRP engine with one click and monitor each step's status in real time.

## References

- FR-034 through FR-049 (full MRP engine orchestration)
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/mrp.service.ts, mrp.controller.ts]

## Acceptance Criteria

- [x] AC-1: `POST /api/v1/mrp/execute` triggers a full MRP run and returns 202 Accepted with the execucaoId
- [x] AC-2: The MRP run creates an ExecucaoPlanejamento record with tipo = MRP, status = EXECUTANDO
- [x] AC-3: The orchestrator executes these steps in order: (1) MPS, (2) Stock Parameters, (3) BOM Explosion + Netting, (4) Lot Sizing, (5) Order Generation, (6) Action Messages, (7) CRP, (8) Storage Validation
- [x] AC-4: Each step logs to ExecucaoStepLog with stepName, stepOrder, status, recordsProcessed, durationMs
- [x] AC-5: If any step fails, the execution stops, status = ERRO, and errorMessage is recorded
- [x] AC-6: On successful completion: status = CONCLUIDO, resultadoResumo contains summary statistics (total orders, total cost, overloaded work centers, storage alerts)
- [x] AC-7: `GET /api/v1/mrp/executions` returns paginated list of MRP executions with status and summary
- [x] AC-8: `GET /api/v1/mrp/executions/:id` returns execution detail with all step logs
- [x] AC-9: `GET /api/v1/mrp/orders?execucaoId=X` returns planned orders for an execution with pagination, filters (tipo, prioridade, produtoId)
- [x] AC-10: `GET /api/v1/mrp/capacity?execucaoId=X` returns capacity load data for an execution with filters (centroTrabalhoId)
- [x] AC-11: `GET /api/v1/mrp/stock-params?execucaoId=X` returns stock parameters for an execution
- [x] AC-12: Request body accepts optional parameters: planningHorizonWeeks, firmOrderHorizonWeeks, forceRecalculate
- [x] AC-13: MRP execution requires manager or admin role
- [x] AC-14: Unit tests >= 80% coverage for orchestrator service, controller, and repository

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp module]
- [Source: architecture/4-backend-architecture.md#4.2 — mrp module: POST /mrp/execute, GET /mrp/orders, GET /mrp/capacity]

### MRP Execution Pipeline (8 Steps)

```
Step 1: MPS Generation (MpsService)
  Input: forecast results, firm orders
  Output: time-phased demand for finished products

Step 2: Stock Parameters (StockParamsService)
  Input: demand statistics, forecast quantiles, product data
  Output: SS, ROP, EOQ, Min, Max for all SKUs

Step 3: BOM Explosion + Netting (BomExplosionService + NetRequirementService)
  Input: MPS demand, BOM structure, stock positions, safety stock
  Output: net requirements per item per period at all BOM levels

Step 4: Lot Sizing (LotSizingService)
  Input: net requirements, lot sizing parameters
  Output: planned order quantities (receipts and releases)

Step 5: Order Generation (OrderGenerationService)
  Input: lot-sized requirements, supplier/routing data
  Output: planned COMPRA and PRODUCAO orders persisted to DB

Step 6: Action Messages (ActionMessagesService)
  Input: new planned orders, existing firm orders
  Output: CANCEL/INCREASE/REDUCE/EXPEDITE/NEW messages

Step 7: CRP (CrpService)
  Input: production orders, work center capacity, calendar
  Output: capacity load per work center per week, overload suggestions

Step 8: Storage Validation (StorageValidationService)
  Input: projected inventory, warehouse capacity
  Output: storage utilization alerts
```

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /api/v1/mrp/execute | Trigger MRP run |
| GET | /api/v1/mrp/executions | List MRP executions |
| GET | /api/v1/mrp/executions/:id | Get execution detail |
| GET | /api/v1/mrp/orders | Get planned orders |
| GET | /api/v1/mrp/capacity | Get capacity data |
| GET | /api/v1/mrp/stock-params | Get stock parameters |

### Request/Response DTOs

```typescript
// POST /mrp/execute body
class ExecuteMrpDto {
  @IsOptional() @IsInt() @Min(1) @Max(52)
  planningHorizonWeeks?: number; // default 13

  @IsOptional() @IsInt() @Min(1) @Max(12)
  firmOrderHorizonWeeks?: number; // default from config

  @IsOptional() @IsBoolean()
  forceRecalculate?: boolean; // recalculate stock params even if recent
}

// Response 202
{
  execucaoId: string;
  status: 'EXECUTANDO';
  message: 'MRP execution started';
}
```

### Step Log Structure

```typescript
interface MrpStepLog {
  stepName: string;   // e.g., 'MPS_GENERATION'
  stepOrder: number;  // 1-8
  status: 'RUNNING' | 'COMPLETED' | 'FAILED';
  recordsProcessed: number;
  durationMs: number;
  details?: object;   // step-specific metadata
}
```

### Result Summary (resultadoResumo JSONB)

```json
{
  "totalOrders": 1250,
  "purchaseOrders": 800,
  "productionOrders": 450,
  "totalEstimatedCost": 2500000.00,
  "overloadedWorkCenters": 2,
  "storageAlerts": 1,
  "criticalStorageAlerts": 0,
  "productsProcessed": 500,
  "actionMessages": {
    "CANCEL": 10,
    "INCREASE": 25,
    "REDUCE": 15,
    "EXPEDITE": 8,
    "NEW": 120
  }
}
```

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/mrp.module.ts`
- `apps/api/src/modules/mrp/mrp.controller.ts`
- `apps/api/src/modules/mrp/mrp.service.ts`
- `apps/api/src/modules/mrp/mrp.repository.ts`
- `apps/api/src/modules/mrp/mrp.controller.spec.ts`
- `apps/api/src/modules/mrp/mrp.service.spec.ts`
- `apps/api/src/modules/mrp/mrp.repository.spec.ts`
- `apps/api/src/modules/mrp/dto/execute-mrp.dto.ts`
- `apps/api/src/modules/mrp/dto/filter-orders.dto.ts`
- `apps/api/src/modules/mrp/dto/filter-capacity.dto.ts`
- `apps/api/src/modules/mrp/dto/filter-executions.dto.ts`
- `apps/api/src/modules/mrp/dto/filter-stock-params.dto.ts`

**Modified:**
- `apps/api/src/app.module.ts` (register MrpModule)

### Testing Requirements

Test cases:
1. Full MRP run: all 8 steps execute in order, status transitions PENDENTE -> EXECUTANDO -> CONCLUIDO
2. Step failure: step 3 fails -> execution stops, status = ERRO, error message recorded, steps 4-8 not executed
3. Step logging: each step creates ExecucaoStepLog with correct stepOrder
4. POST /mrp/execute: returns 202 with execucaoId
5. GET /mrp/executions: paginated list with status filter
6. GET /mrp/orders: filtered by execucaoId, tipo, prioridade
7. GET /mrp/capacity: filtered by execucaoId, centroTrabalhoId
8. Role guard: viewer cannot trigger execution (403)
9. Result summary: correct counts in resultadoResumo
10. Optional parameters: custom planning horizon honored

### Technical Constraints
- MRP execution is synchronous within a single request (not BullMQ — MRP is fast enough for synchronous)
- If MRP execution grows too slow, future story can move to async BullMQ pattern (like forecast)
- All results from a single MRP run share the same execucaoId
- Previous MRP results are NOT deleted — historical runs preserved for comparison
- Only one MRP execution should run at a time (use advisory lock or check for existing EXECUTANDO status)

---

## Tasks / Subtasks

- [x] **Task 1: Create MRP DTOs** (AC: 12)
  - [x] `execute-mrp.dto.ts` with optional parameters
  - [x] `filter-orders.dto.ts` (extends PaginationDto, execucaoId, tipo, prioridade, produtoId)
  - [x] `filter-capacity.dto.ts` (extends PaginationDto, execucaoId, centroTrabalhoId)
  - [x] `filter-executions.dto.ts` (extends PaginationDto, status)
  - [x] `filter-stock-params.dto.ts` (extends PaginationDto, execucaoId, produtoId)

- [x] **Task 2: Create MRP Repository** (AC: 7-11)
  - [x] createExecution: create ExecucaoPlanejamento
  - [x] updateExecution: update status, resultadoResumo
  - [x] createStepLog: log each step
  - [x] findExecutions: paginated with filters
  - [x] findExecutionById: with step logs
  - [x] findOrders: paginated with filters
  - [x] findCapacity: paginated with filters
  - [x] findStockParams: paginated with filters

- [x] **Task 3: Create MRP Orchestrator Service** (AC: 1-6)
  - [x] executeMrp method: orchestrate all 8 steps
  - [x] Step execution with try/catch per step
  - [x] Step logging (stepName, duration, records processed)
  - [x] Status transitions: PENDENTE -> EXECUTANDO -> CONCLUIDO/ERRO
  - [x] Result summary generation
  - [x] Concurrency guard (reject if another MRP is EXECUTANDO)

- [x] **Task 4: Create MRP Controller** (AC: 1, 7-11, 13)
  - [x] POST /mrp/execute (returns 202)
  - [x] GET /mrp/executions (paginated)
  - [x] GET /mrp/executions/:id (detail with steps)
  - [x] GET /mrp/orders (paginated with filters)
  - [x] GET /mrp/capacity (paginated with filters)
  - [x] GET /mrp/stock-params (paginated with filters)
  - [x] Role guards: manager/admin for execute, viewer for read

- [x] **Task 5: Create MRP Module and register in AppModule** (AC: all)
  - [x] Import all engine services
  - [x] Register controller, service, repository
  - [x] AppModule already imports MrpModule — no change needed

- [x] **Task 6: Write unit tests** (AC: 14)
  - [x] Service tests: full orchestration, step failure, logging (15 tests)
  - [x] Controller tests: all endpoints, filters (15 tests)
  - [x] Repository tests: CRUD operations, pagination (18 tests)
  - [x] 48 total tests covering all testing requirements

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/dto/execute-mrp.dto.ts` | Created | Execute MRP DTO with optional planningHorizonWeeks, firmOrderHorizonWeeks, forceRecalculate |
| `apps/api/src/modules/mrp/dto/filter-executions.dto.ts` | Created | Filter DTO extending PaginationDto with optional status filter |
| `apps/api/src/modules/mrp/dto/filter-orders.dto.ts` | Created | Filter DTO extending PaginationDto with execucaoId, tipo, prioridade, produtoId |
| `apps/api/src/modules/mrp/dto/filter-capacity.dto.ts` | Created | Filter DTO extending PaginationDto with execucaoId, centroTrabalhoId |
| `apps/api/src/modules/mrp/dto/filter-stock-params.dto.ts` | Created | Filter DTO extending PaginationDto with execucaoId, produtoId |
| `apps/api/src/modules/mrp/mrp.repository.ts` | Created | MRP repository — CRUD for executions, step logs, and read queries for orders/capacity/stock-params |
| `apps/api/src/modules/mrp/mrp.service.ts` | Created | MRP orchestrator — 8-step pipeline with step logging, concurrency guard, result summary (~920 lines) |
| `apps/api/src/modules/mrp/mrp.controller.ts` | Created | MRP controller — 6 endpoints (POST execute, 5 GET reads) with role guards |
| `apps/api/src/modules/mrp/mrp.controller.spec.ts` | Created | Controller tests — 15 tests covering all endpoints |
| `apps/api/src/modules/mrp/mrp.service.spec.ts` | Created | Orchestrator tests — 15 tests covering full run, step failures, concurrency |
| `apps/api/src/modules/mrp/mrp.repository.spec.ts` | Created | Repository tests — 18 tests covering CRUD, pagination, filters |
| `apps/api/src/modules/mrp/mrp.module.ts` | Modified | Added MrpController, MrpService, MrpRepository (14 providers/exports) |

---

## Dependencies

- Story 3.6: Master Production Schedule (Step 1)
- Story 3.3: Stock Parameter Calculation (Step 2)
- Story 3.4: Multi-Level BOM Explosion (Step 3)
- Story 3.2: Net Requirement Calculation Engine (Step 3)
- Story 3.5: Lot Sizing Engine (Step 4)
- Story 3.7: Planned Order Generation (Step 5)
- Story 3.8: Action Messages (Step 6)
- Story 3.9: CRP & Storage Capacity Validation (Steps 7-8)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-27 | 0.2 | Implementation complete — 11 files created, 1 modified, 48 tests (80%+ coverage) | Dex (Dev) |
| 2026-02-27 | 0.3 | QA Review PASS WITH CONCERNS — 14/14 AC, 0 CRITICAL, 2 HIGH (forceRecalculate fixed, role hierarchy verified), 5 MEDIUM, 5 LOW | Quinn (QA) |
