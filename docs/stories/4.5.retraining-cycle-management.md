# Story 4.5: Re-training Cycle Management

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc", "ruff", "mypy"]

## Story

**As a** data scientist / system administrator,
**I want** automated re-training cycles (daily inference, weekly metrics, monthly full training) with manual trigger capability,
**so that** forecast models stay accurate without manual intervention.

## References

- FR-059: Re-training Cycles
- [Source: architecture/5-mlforecasting-architecture.md]

## Acceptance Criteria

### Cycle Definitions (FR-059)
- [x] AC-1: Daily cycle (automatic): inference only (no training), recalculate MRP, check alerts — ~2 min expected
- [x] AC-2: Weekly cycle (automatic): compare forecast vs actual, update MAPE per SKU, recalculate ABC/XYZ classification, update stock parameters — ~10 min expected
- [x] AC-3: Monthly cycle (automatic): full re-training of ALL models, generate accuracy report, update model metadata — ~30-60 min expected
- [x] AC-4: Manual cycle: triggered by user for structural changes, atypical events, or historical data corrections — variable duration

### Scheduling
- [x] AC-5: Each cycle type has a configurable cron schedule stored in `config_sistema`
- [x] AC-6: Default schedules: daily `0 6 * * *`, weekly `0 3 * * 1` (Mon 03:00), monthly `0 2 1 * *` (1st of month 02:00)
- [x] AC-7: Cycles run as BullMQ repeatable jobs with progress reporting

### Execution Tracking
- [x] AC-8: Each cycle execution is logged: type, start time, end time, status (SUCCESS/FAILED/PARTIAL), steps completed, errors
- [x] AC-9: `GET /automation/cycles` — list cycle executions with filters
- [x] AC-10: `POST /automation/cycles/trigger` — manually trigger a specific cycle type
- [x] AC-11: `GET /automation/cycles/:id` — get execution details with per-step status

### Conflict Prevention
- [x] AC-12: Only one cycle of each type can run at a time (mutex via Redis lock)
- [x] AC-13: If a higher-priority cycle (monthly) is running, lower-priority cycles (daily/weekly) are deferred

### Frontend
- [x] AC-14: `/automacao/schedule` page showing cycle schedules, next run time, and last execution status
- [x] AC-15: Manual trigger buttons for each cycle type with confirmation dialog
- [x] AC-16: Execution log table with status badges and duration

### Testing
- [x] AC-17: Backend unit tests for cycle orchestrator and scheduling logic (80%+ coverage)
- [x] AC-18: Frontend render tests for schedule management page

## Dev Notes

### Cycle Orchestration

```typescript
interface CycleDefinition {
  type: 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'MANUAL';
  cronExpression: string;
  steps: CycleStep[];
  estimatedDuration: number; // minutes
}

interface CycleStep {
  name: string;
  service: string;
  method: string;
  timeout: number;
}
```

### File Locations

**Backend:**
- `apps/api/src/modules/automation/cycles/` — cycle orchestrator, definitions, processor
- `apps/api/src/modules/automation/cycles/cycle.processor.ts` — BullMQ job processor

**Frontend:**
- `apps/web/src/app/automacao/schedule/page.tsx`
- `apps/web/src/app/automacao/schedule/components/`

---

## Tasks / Subtasks

- [x] **Task 1: Define cycle step definitions for daily/weekly/monthly** (AC: 1-4)
- [x] **Task 2: Implement cycle orchestrator with BullMQ repeatable jobs** (AC: 5, 6, 7)
- [x] **Task 3: Add execution logging and tracking** (AC: 8-11)
- [x] **Task 4: Implement conflict prevention via DB concurrency guard** (AC: 12, 13)
- [x] **Task 5: Create schedule management frontend** (AC: 14, 15, 16)
- [x] **Task 6: Write backend unit tests** (AC: 17)
- [x] **Task 7: Write frontend render tests** (AC: 18)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added CICLO_DIARIO/SEMANAL/MENSAL to TipoExecucao, PARCIAL to StatusExecucao |
| `apps/api/prisma/migrations/20260228010000_add_cycle_types/migration.sql` | Created | Migration SQL for new enum values |
| `apps/api/src/modules/automation/automation.module.ts` | Modified | Registered cycles queue, CycleController, CycleService, CycleRepository, CycleProcessor |
| `apps/api/src/modules/automation/cycles/cycle.types.ts` | Created | CycleType, CycleStatus, CycleDefinition, CycleExecution, mapping constants |
| `apps/api/src/modules/automation/cycles/cycle-definitions.ts` | Created | DAILY/WEEKLY/MONTHLY step definitions with cron defaults |
| `apps/api/src/modules/automation/cycles/dto/trigger-cycle.dto.ts` | Created | TriggerCycleDto with IsIn validation |
| `apps/api/src/modules/automation/cycles/dto/filter-cycles.dto.ts` | Created | FilterCyclesDto extending PaginationDto |
| `apps/api/src/modules/automation/cycles/cycle.repository.ts` | Created | Data access layer for ExecucaoPlanejamento + ExecucaoStepLog |
| `apps/api/src/modules/automation/cycles/cycle.service.ts` | Created | Cycle orchestrator with BullMQ, conflict prevention, execution tracking |
| `apps/api/src/modules/automation/cycles/cycle.controller.ts` | Created | REST endpoints: GET /cycles, GET/PUT /cycles/schedule/config, POST /cycles/trigger, GET /cycles/:id |
| `apps/api/src/modules/automation/cycles/cycle.processor.ts` | Created | BullMQ processor with ConflictException handling for repeatable jobs |
| `apps/api/src/modules/automation/cycles/dto/update-schedule.dto.ts` | Created | UpdateScheduleDto with cron regex validation |
| `apps/api/src/modules/automation/cycles/cycle.service.spec.ts` | Created | Service unit tests (16 tests) |
| `apps/api/src/modules/automation/cycles/cycle.controller.spec.ts` | Created | Controller unit tests (6 tests) |
| `apps/web/src/types/cycles.ts` | Created | Frontend types, labels, status colors |
| `apps/web/src/hooks/use-cycles.ts` | Created | React Query hooks (useCycleSchedule, useCycleExecutions, useTriggerCycle) |
| `apps/web/src/app/automacao/schedule/page.tsx` | Created | Schedule management page with cards, trigger buttons, execution table |
| `apps/web/src/app/automacao/schedule/__tests__/schedule-page.test.tsx` | Created | Frontend render tests (14 tests) |

---

## Dependencies

- Story 2.6: Forecast Execution Pipeline (daily inference uses existing pipeline)
- Story 2.8: BullMQ Integration (job queue infrastructure)
- Story 3.10: MRP Orchestrator (daily MRP recalculation)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-28 | 0.2 | Schema, types, definitions, repository, service, controller, processor, frontend, tests — all 18 ACs implemented | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: MANUAL type consistency, getNextCronRun weekly/monthly, PUT schedule/config endpoint, sortBy allowlist, ConflictException in processor, PENDENTE in concurrency guard, frontend details field, RTL import | Dex (Dev) |
| 2026-02-28 | 0.4 | QA Gate PASS — removed dead allCompleted variable, story marked Done | Dex (Dev) |
