# Story 1.1: NestJS Common Infrastructure & Prisma Service

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** backend developer,
**I want** a shared NestJS infrastructure layer with Prisma database service, global validation, exception handling, response transformation, and pagination support,
**so that** all subsequent CRUD modules follow consistent patterns and I don't need to reimplement cross-cutting concerns in every module.

## Acceptance Criteria

1. `PrismaModule` exists as a global NestJS module that provides `PrismaService` with connection lifecycle management (onModuleInit, onModuleDestroy)
2. A global `ValidationPipe` is configured in `main.ts` with `whitelist: true`, `forbidNonWhitelisted: true`, `transform: true`, and `enableImplicitConversion: true`
3. A global `HttpExceptionFilter` returns standardized error responses with `{ statusCode, error, message, details, timestamp, path }` format
4. A `PrismaExceptionFilter` maps Prisma error codes to HTTP status codes: P2002 → 409, P2025 → 404, P2003 → 409 (FK violation)
5. A `TransformInterceptor` wraps all successful responses in a `{ data }` envelope
6. A `PaginationDto` exists with `page`, `limit`, `sortBy`, `sortOrder` fields with proper validation and defaults (page=1, limit=50, max limit=500)
7. A `PaginatedResponseDto<T>` generic type provides `{ data: T[], meta: { total, page, limit, hasNext, hasPrev } }` structure
8. A `UuidValidationPipe` validates URL params as valid UUIDs and returns 400 if invalid
9. The API global prefix is set to `api/v1` in `main.ts`
10. A health check endpoint `GET /api/v1/health` returns `{ status: 'ok', timestamp }` (publicly accessible, no auth required)
11. CORS is enabled in `main.ts` with configurable origins from environment variable `CORS_ORIGINS`
12. All infrastructure is covered by unit tests with >= 80% coverage

## CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

## Tasks / Subtasks

- [x] **Task 1: Create PrismaModule & PrismaService** (AC: 1)
  - [x] Create `apps/api/src/prisma/prisma.module.ts` as a `@Global()` module
  - [x] Create `apps/api/src/prisma/prisma.service.ts`:
    - Import `PrismaClient` from `../generated/prisma/client`
    - Use `PrismaPg` adapter from `@prisma/adapter-pg` (Prisma 7 requirement)
    - Implement `onModuleInit()` with `$connect()`
    - Implement `onModuleDestroy()` with `$disconnect()`
    - Implement `enableShutdownHooks(app)` for graceful shutdown
  - [x] Register `PrismaModule` in `AppModule` imports
  - [x] Write unit test: `prisma.service.spec.ts`

- [x] **Task 2: Configure Global ValidationPipe** (AC: 2)
  - [x] Update `apps/api/src/main.ts`:
    ```typescript
    app.useGlobalPipes(new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
      transformOptions: {
        enableImplicitConversion: true,
      },
    }));
    ```
  - [x] Install `class-validator` and `class-transformer` as dependencies
  - [x] Verify that unknown properties are stripped (whitelist) and rejected (forbidNonWhitelisted)

- [x] **Task 3: Create HttpExceptionFilter** (AC: 3)
  - [x] Create `apps/api/src/common/filters/http-exception.filter.ts`
  - [x] Implement `@Catch(HttpException)` filter that returns:
    ```json
    {
      "statusCode": 400,
      "error": "Bad Request",
      "message": "Validation failed",
      "details": { ... },
      "timestamp": "2026-02-25T10:30:00.000Z",
      "path": "/api/v1/produtos"
    }
    ```
  - [x] Register as global filter in `main.ts` or via `APP_FILTER` provider
  - [x] Write unit test: `http-exception.filter.spec.ts`

- [x] **Task 4: Create PrismaExceptionFilter** (AC: 4)
  - [x] Create `apps/api/src/common/filters/prisma-exception.filter.ts`
  - [x] Implement `@Catch(Prisma.PrismaClientKnownRequestError)` filter with mappings:
    - `P2002` (unique constraint) → 409 Conflict with field name in details
    - `P2025` (record not found) → 404 Not Found
    - `P2003` (FK constraint) → 409 Conflict with referenced table info
    - Default → 500 Internal Server Error
  - [x] Register as global filter (before HttpExceptionFilter in priority)
  - [x] Write unit test: `prisma-exception.filter.spec.ts`

- [x] **Task 5: Create TransformInterceptor** (AC: 5)
  - [x] Create `apps/api/src/common/interceptors/transform.interceptor.ts`
  - [x] Implement `@Injectable()` interceptor that wraps response in `{ data: response }`
  - [x] Skip wrapping if response is already an object with `data` property (to avoid double-wrapping paginated responses)
  - [x] Register as global interceptor
  - [x] Write unit test: `transform.interceptor.spec.ts`

- [x] **Task 6: Create Pagination DTOs** (AC: 6, 7)
  - [x] Create `apps/api/src/common/dto/pagination.dto.ts`:
    ```typescript
    export class PaginationDto {
      @IsOptional()
      @IsInt()
      @Min(1)
      page?: number = 1;

      @IsOptional()
      @IsInt()
      @Min(1)
      @Max(500)
      limit?: number = 50;

      @IsOptional()
      @IsString()
      sortBy?: string = 'createdAt';

      @IsOptional()
      @IsIn(['asc', 'desc'])
      sortOrder?: 'asc' | 'desc' = 'desc';
    }
    ```
  - [x] Create `apps/api/src/common/dto/paginated-response.dto.ts`:
    ```typescript
    export class PaginatedResponseDto<T> {
      data: T[];
      meta: {
        total: number;
        page: number;
        limit: number;
        totalPages: number;
        hasNext: boolean;
        hasPrev: boolean;
      };
    }
    ```
  - [x] Create helper function `buildPaginatedResponse<T>(data, total, page, limit): PaginatedResponseDto<T>`

- [x] **Task 7: Create UuidValidationPipe** (AC: 8)
  - [x] Create `apps/api/src/common/pipes/uuid-validation.pipe.ts`
  - [x] Validate that the value matches UUID v4 format regex
  - [x] Throw `BadRequestException` with message `"Invalid UUID format: {value}"` if invalid
  - [x] Write unit test: `uuid-validation.pipe.spec.ts`

- [x] **Task 8: Configure main.ts (Prefix, CORS, Health)** (AC: 9, 10, 11)
  - [x] Set global prefix: `app.setGlobalPrefix('api/v1')`
  - [x] Enable CORS:
    ```typescript
    app.enableCors({
      origin: process.env.CORS_ORIGINS?.split(',') || ['http://localhost:3000'],
      credentials: true,
    });
    ```
  - [x] Update existing `HealthController` to return `{ status: 'ok', timestamp: new Date().toISOString() }`
  - [x] Exclude health endpoint from global prefix if needed, OR keep it at `/api/v1/health`
  - [x] Add `CORS_ORIGINS` to `.env.example`

- [x] **Task 9: Create Common Module Barrel Exports** (AC: 1-8)
  - [x] Create `apps/api/src/common/common.module.ts` as a `@Global()` module
  - [x] Export all filters, interceptors, pipes, and DTOs
  - [x] Create `apps/api/src/common/index.ts` barrel export for easy imports
  - [x] Register `CommonModule` in `AppModule`

- [x] **Task 10: Write Integration Tests** (AC: 12)
  - [x] Test ValidationPipe behavior: send invalid DTO, verify 400 response format
  - [x] Test PrismaExceptionFilter: mock Prisma errors, verify correct HTTP status codes
  - [x] Test TransformInterceptor: verify response wrapping
  - [x] Test UuidValidationPipe: valid/invalid UUIDs
  - [x] Test health endpoint: verify `GET /api/v1/health` returns 200 with status
  - [x] Verify test coverage >= 80% for all common/ files

## Dev Notes

### Architecture Reference
[Source: docs/architecture/3-backend-architecture.md]

This story implements the cross-cutting infrastructure layer that all Epic 1 CRUD modules will consume. The patterns defined here (response format, error handling, pagination, validation) become the standard for the entire API.

### Prisma 7 Considerations

**IMPORTANT:** This project uses Prisma 7.4.1 which has breaking changes from Prisma 6:
- Import `PrismaClient` from `../generated/prisma/client` (NOT `@prisma/client`)
- Use `PrismaPg` adapter from `@prisma/adapter-pg` for database connections
- The `datasource url` is configured in `prisma.config.ts`, NOT in `schema.prisma`
- The generated client outputs to `src/generated/prisma/` (configured via `output` in generator block)

### Response Format Standard

**Success (single):**
```json
{ "data": { /* entity */ } }
```

**Success (paginated):**
```json
{
  "data": [ /* entities */ ],
  "meta": { "total": 100, "page": 1, "limit": 50, "totalPages": 2, "hasNext": true, "hasPrev": false }
}
```

**Error:**
```json
{
  "statusCode": 409,
  "error": "Conflict",
  "message": "Produto com codigo SKU-001 ja existe",
  "details": { "field": "codigo", "value": "SKU-001", "constraint": "produto_codigo_key" },
  "timestamp": "2026-02-25T10:30:00.000Z",
  "path": "/api/v1/produtos"
}
```

### Prisma Error Code Mapping

| Prisma Code | HTTP Status | Scenario |
|-------------|-------------|----------|
| P2002 | 409 Conflict | Unique constraint violated |
| P2025 | 404 Not Found | Record not found |
| P2003 | 409 Conflict | Foreign key constraint failed |
| P2014 | 400 Bad Request | Required relation violation |
| Default | 500 Internal Server Error | Unknown Prisma error |

### NestJS Module Hierarchy

```
AppModule
├── PrismaModule (global) ← THIS STORY
├── CommonModule (global) ← THIS STORY
├── HealthModule ← UPDATE (already exists from Story 0.1)
├── AuthModule ← Story 1.2
├── ProdutosModule ← Story 1.3
├── ...remaining modules
```

### Dependencies

This story depends on:
- **Story 0.1** (NestJS app scaffold exists)
- **Story 0.3** (Prisma schema and generated client exist)

This story is a prerequisite for:
- **ALL subsequent Epic 1 stories** (1.2 through 1.11)

### Pre-existing Files

The following files ALREADY EXIST and should be UPDATED:
- `apps/api/src/main.ts` — Add global prefix, CORS, ValidationPipe, filters, interceptors
- `apps/api/src/app.module.ts` — Import PrismaModule and CommonModule
- `apps/api/src/health/health.controller.ts` — Update response format

The following files should be CREATED:
- `apps/api/src/prisma/prisma.module.ts`
- `apps/api/src/prisma/prisma.service.ts`
- `apps/api/src/prisma/prisma.service.spec.ts`
- `apps/api/src/common/common.module.ts`
- `apps/api/src/common/index.ts`
- `apps/api/src/common/filters/http-exception.filter.ts`
- `apps/api/src/common/filters/http-exception.filter.spec.ts`
- `apps/api/src/common/filters/prisma-exception.filter.ts`
- `apps/api/src/common/filters/prisma-exception.filter.spec.ts`
- `apps/api/src/common/interceptors/transform.interceptor.ts`
- `apps/api/src/common/interceptors/transform.interceptor.spec.ts`
- `apps/api/src/common/dto/pagination.dto.ts`
- `apps/api/src/common/dto/paginated-response.dto.ts`
- `apps/api/src/common/pipes/uuid-validation.pipe.ts`
- `apps/api/src/common/pipes/uuid-validation.pipe.spec.ts`

### NPM Dependencies to Install

```bash
pnpm add class-validator class-transformer
pnpm add -D @nestjs/testing
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 0.1 | Story created during greenfield-fullstack workflow engine (Epic 1 start) | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- PrismaService test failure: Prisma 7 validates adapter at construction time — required mocking both `PrismaPg` and `PrismaClient` constructor
- main.ts: Changed `CORS_ORIGIN` → `CORS_ORIGINS` with `.split(',')` support

### Completion Notes List
- All 10 tasks completed, 12/12 AC met
- 28/28 unit tests passing
- Coverage: 100% on all common/ modules (filters, interceptor, pipe, DTOs, PrismaService)
- Build: 3/3 packages successful (shared, api, forecast-engine)
- Prisma 7 pattern: import from `generated/prisma/client`, PrismaPg adapter required
- jest.config.ts created (did not exist prior)
- CommonModule registered as @Global() with APP_FILTER and APP_INTERCEPTOR providers

### File List
**Created:**
- `apps/api/src/prisma/prisma.service.ts`
- `apps/api/src/prisma/prisma.module.ts`
- `apps/api/src/prisma/prisma.service.spec.ts`
- `apps/api/src/common/common.module.ts`
- `apps/api/src/common/index.ts`
- `apps/api/src/common/filters/http-exception.filter.ts`
- `apps/api/src/common/filters/http-exception.filter.spec.ts`
- `apps/api/src/common/filters/prisma-exception.filter.ts`
- `apps/api/src/common/filters/prisma-exception.filter.spec.ts`
- `apps/api/src/common/interceptors/transform.interceptor.ts`
- `apps/api/src/common/interceptors/transform.interceptor.spec.ts`
- `apps/api/src/common/dto/pagination.dto.ts`
- `apps/api/src/common/dto/paginated-response.dto.ts`
- `apps/api/src/common/dto/paginated-response.spec.ts`
- `apps/api/src/common/pipes/uuid-validation.pipe.ts`
- `apps/api/src/common/pipes/uuid-validation.pipe.spec.ts`
- `apps/api/jest.config.ts`

**Modified:**
- `apps/api/src/main.ts` — Added ValidationPipe, updated CORS config
- `apps/api/src/app.module.ts` — Added PrismaModule, CommonModule imports

## QA Results
(To be populated by QA agent)
