# Story 1.11: Automatic SKU Classification (ABC/XYZ)

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** demand planner,
**I want** SKUs to be automatically classified by ABC (revenue), XYZ (variability), and demand pattern,
**so that** the forecasting engine selects the optimal model per SKU.

## Acceptance Criteria

1. `GET /api/v1/classificacao` lists classifications with filters (classeAbc, classeXyz, padraoDemanda) and pagination
2. `GET /api/v1/classificacao/:produtoId` returns classification for a single product
3. `PATCH /api/v1/classificacao/:produtoId` allows manual override of classification fields
4. `POST /api/v1/classificacao/recalcular` triggers batch recalculation from serie_temporal data
5. ABC classification uses Pareto thresholds: A (cumulative <=80%), B (80-95%), C (>95%)
6. XYZ classification uses CV thresholds: X (<=0.5), Y (0.5-1.0), Z (>1.0)
7. Demand pattern detection: REGULAR (<=5% zeros), INTERMITENTE (5-25%), ERRATICO (25-50%), LUMPY (>50%)
8. Suggested forecast model is auto-assigned based on ABC + demand pattern matrix
9. Module requires operator role for write, viewer for read
10. All services covered by unit tests >= 80%

## Tasks / Subtasks

- [x] **Task 1: Create Classification DTOs, Repository**
- [x] **Task 2: Create Classification Service with ABC/XYZ/Demand algorithms**
- [x] **Task 3: Create Classification Controller**
- [x] **Task 4: Register ClassificacaoModule in AppModule**
- [x] **Task 5: Write Unit Tests**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- No errors encountered — clean implementation

### Completion Notes List
- 27 new tests (22 classificacao service incl. algorithm tests, 5 controller)
- 301/301 total tests passing across 43 suites
- Build clean, no TypeScript errors
- ABC: Pareto-based cumulative revenue classification (A<=80%, B<=95%, C>95%)
- XYZ: Coefficient of variation thresholds (X<=0.5, Y<=1.0, Z>1.0)
- Demand pattern: Zero-week percentage (REGULAR<=5%, INTERMITENTE<=25%, ERRATICO<=50%, LUMPY>50%)
- Model suggestion matrix: 12 combinations of ABC + demand pattern → forecast model
- Batch recalculation from serie_temporal data with weekly aggregation
- Manual override support via PATCH endpoint
- Product search filter (codigo/descricao) on classification list

### File List

**Created:**
- `apps/api/src/modules/classificacao/dto/filter-classificacao.dto.ts`
- `apps/api/src/modules/classificacao/dto/update-classificacao.dto.ts`
- `apps/api/src/modules/classificacao/classificacao.repository.ts`
- `apps/api/src/modules/classificacao/classificacao.service.ts`
- `apps/api/src/modules/classificacao/classificacao.service.spec.ts`
- `apps/api/src/modules/classificacao/classificacao.controller.ts`
- `apps/api/src/modules/classificacao/classificacao.controller.spec.ts`
- `apps/api/src/modules/classificacao/classificacao.module.ts`

**Modified:**
- `apps/api/src/app.module.ts` (added ClassificacaoModule import)
