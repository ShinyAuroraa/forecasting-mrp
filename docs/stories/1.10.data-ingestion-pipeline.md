# Story 1.10: Data Ingestion Pipeline

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** data analyst,
**I want** to ingest time-series data (sales volume and revenue) via manual entry or CSV/XLSX upload,
**so that** the forecasting engine has historical data to generate demand predictions.

## Acceptance Criteria

1. `POST /api/v1/series-temporais` creates a single time-series record
2. `GET /api/v1/series-temporais` lists records with filters (produtoId, granularidade, dateFrom, dateTo) and pagination
3. `GET /api/v1/series-temporais/:id` returns a single record with product info
4. `POST /api/v1/ingestao/upload` uploads CSV/XLSX, validates, and upserts time-series data
5. Upload validates that SKU codes exist in produto table before inserting
6. Upload uses upsert on unique constraint (produtoId, dataReferencia, granularidade)
7. Upload returns ImportResult with imported count, rejected count, and error details
8. Upload supports auto-detection of CSV delimiter (comma or semicolon)
9. Each record tracks fonteAtualizacao (MANUAL, UPLOAD, ERP_SYNC, CONTAGEM)
10. Module requires operator role for write, viewer for read
11. All services covered by unit tests >= 80%

## Tasks / Subtasks

- [x] **Task 1: Create SerieTemporal DTOs, Repository, Service, Controller**
- [x] **Task 2: Create IngestaoUpload Service (CSV/XLSX parser + validator)**
- [x] **Task 3: Create Ingestao Controller (upload endpoint)**
- [x] **Task 4: Register IngestaoModule in AppModule**
- [x] **Task 5: Write Unit Tests**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- No errors encountered — clean implementation

### Completion Notes List
- 21 new tests (4 ingestao service, 6 ingestao controller, 11 upload service)
- 274/274 total tests passing across 41 suites
- Build clean, no TypeScript errors
- SerieTemporal: CRUD with date range filters, product include, pagination
- Upload: CSV/XLSX parsing with auto-delimiter detection (comma/semicolon)
- DD/MM/YYYY date format support alongside ISO dates
- Upsert logic: findFirst + update if exists, create if new
- SKU validation against produto table (case-insensitive)
- Requires both volume/receita — at least one must be present
- ImportResult tracks imported (new), updated (existing), rejected (errors)

### File List

**Created:**
- `apps/api/src/modules/ingestao/dto/create-serie-temporal.dto.ts`
- `apps/api/src/modules/ingestao/dto/filter-serie-temporal.dto.ts`
- `apps/api/src/modules/ingestao/ingestao.repository.ts`
- `apps/api/src/modules/ingestao/ingestao.service.ts`
- `apps/api/src/modules/ingestao/ingestao.service.spec.ts`
- `apps/api/src/modules/ingestao/ingestao-upload.service.ts`
- `apps/api/src/modules/ingestao/ingestao-upload.service.spec.ts`
- `apps/api/src/modules/ingestao/ingestao.controller.ts`
- `apps/api/src/modules/ingestao/ingestao.controller.spec.ts`
- `apps/api/src/modules/ingestao/ingestao.module.ts`

**Modified:**
- `apps/api/src/app.module.ts` (added IngestaoModule import)
