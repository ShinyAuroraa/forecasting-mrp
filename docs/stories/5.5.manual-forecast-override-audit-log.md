# Story 5.5: Manual Forecast Override with Audit Log

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** demand planner / operations manager,
**I want** to manually override forecast values for specific products and periods with full audit logging,
**so that** I can incorporate domain knowledge (seasonal events, promotions, supply disruptions) while maintaining complete traceability of manual adjustments.

## References

- FR-068: Manual Forecast Override
- [Source: PRD §4 — Allow users to manually override forecast values with audit logging]
- [Front-end Spec: "Trust Through Transparency" — Allow manual overrides with audit logging]
- [Success Metric: Manual override rate < 15% of forecast recommendations]
- [ForecastResultado — stores per-product per-period forecast values (p10/p25/p50/p75/p90)]

## Acceptance Criteria

### Prisma Schema
- [x] AC-1: New `ForecastOverride` model with fields: id, forecastResultadoId, produtoId, periodo, originalP50, overrideP50, motivo (reason), categoriaOverride (SEASONAL, PROMOTION, SUPPLY_DISRUPTION, MARKET_INTELLIGENCE, OTHER), createdBy (userId), createdAt
- [x] AC-2: ForecastOverride linked to ForecastResultado (optional FK — override can exist without original if manual forecast) and Produto (required FK)

### Override Service (NestJS)
- [x] AC-3: ForecastOverrideService.create() — validate product exists, store override with audit fields, return created override
- [x] AC-4: ForecastOverrideService.findByProduct() — list overrides for a product with pagination (most recent first)
- [x] AC-5: ForecastOverrideService.findByPeriod() — list overrides within a date range across all products
- [x] AC-6: ForecastOverrideService.revert() — soft-revert an override (create new override with original value, reason "REVERT")
- [x] AC-7: Override values validated: overrideP50 must be >= 0, periodo must be a valid date, motivo required (non-empty)

### API Endpoints (NestJS)
- [x] AC-8: `POST /forecast/overrides` — create a new override (operator role)
- [x] AC-9: `GET /forecast/overrides` — list overrides with optional filters (produtoId, dateFrom, dateTo, categoriaOverride)
- [x] AC-10: `GET /forecast/overrides/:id` — get single override detail
- [x] AC-11: `POST /forecast/overrides/:id/revert` — revert an override (operator role)

### Frontend
- [x] AC-12: Override form modal on forecast chart — click a data point to override, enter new value + reason + category
- [x] AC-13: Override history panel showing all overrides with user, timestamp, reason, original vs override value
- [x] AC-14: Visual indicator on forecast chart for overridden data points (different color/marker)

### Testing
- [x] AC-15: Unit tests for override service (create, find, revert, validation)
- [x] AC-16: Controller endpoint tests
- [x] AC-17: Frontend render tests for override form and history panel

---

## Tasks / Subtasks

- [x] **Task 1: Prisma schema + migration** (AC: 1, 2)
- [x] **Task 2: Override service + DTOs** (AC: 3-7)
- [x] **Task 3: API endpoints** (AC: 8-11)
- [x] **Task 4: Frontend components** (AC: 12-14)
- [x] **Task 5: Backend tests** (AC: 15, 16)
- [x] **Task 6: Frontend tests** (AC: 17)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added CategoriaOverride enum and ForecastOverride model with FKs to ForecastResultado, Produto, Usuario |
| `apps/api/src/modules/forecast/dto/create-override.dto.ts` | Created | CreateOverrideDto with validation (produtoId, periodo, overrideP50>=0, motivo required, categoriaOverride enum) |
| `apps/api/src/modules/forecast/dto/filter-overrides.dto.ts` | Created | FilterOverridesDto extending PaginationDto with produtoId, dateFrom, dateTo, categoriaOverride filters |
| `apps/api/src/modules/forecast/forecast-override.service.ts` | Created | ForecastOverrideService with create, findByProduct, findAll, findById, revert methods |
| `apps/api/src/modules/forecast/forecast.controller.ts` | Modified | Added 4 override endpoints (POST/GET/GET/:id/POST/:id/revert) |
| `apps/api/src/modules/forecast/forecast.module.ts` | Modified | Added ForecastOverrideService to providers and exports |
| `apps/api/src/modules/forecast/forecast-override.service.spec.ts` | Created | 14 unit tests: create, validation, findByProduct, findAll filters, findById, revert |
| `apps/api/src/modules/forecast/forecast.controller.spec.ts` | Modified | Added ForecastOverrideService mock to controller test module |
| `apps/web/src/hooks/use-overrides.ts` | Created | useOverrides, useCreateOverride, useRevertOverride hooks |
| `apps/web/src/components/forecast/override-form.tsx` | Created | OverrideForm modal with value, category, reason inputs |
| `apps/web/src/components/forecast/override-history.tsx` | Created | OverrideHistory panel with category badges, delta display, revert button |
| `apps/web/src/app/forecast/page.tsx` | Modified | Added OverrideHistory component |
| `apps/web/src/components/forecast/__tests__/override.test.tsx` | Created | 15 frontend tests: history panel, form modal, category badges |

---

## Dependencies

- Story 2.10: Forecast Dashboard (existing chart component)
- ForecastResultado table (forecast values to override)
- Produto table (product validation)
- Usuario table (audit — who made the override)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — Manual Forecast Override with Audit Log | River (SM) |
| 2026-02-28 | 0.2 | Implemented ForecastOverride schema, service, API endpoints, frontend components | Dex (Dev) |
| 2026-02-28 | 0.3 | Backend tests (14) + frontend tests (15) — All 17 ACs complete, Story Done | Dex (Dev) |
