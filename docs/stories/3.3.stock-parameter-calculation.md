# Story 3.3: Stock Parameter Calculation

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** inventory manager,
**I want** the system to automatically calculate Safety Stock, Reorder Point, Min, Max, and EOQ for all SKUs,
**so that** MRP can use optimal stock parameters based on either TFT probabilistic forecasts or classical formulas.

## References

- FR-035: Stock Parameter Calculation
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/stock-params.service.ts]

## Acceptance Criteria

- [x] AC-1: StockParamsService calculates SS, ROP, Min, Max, EOQ for a given SKU
- [x] AC-2: RULE — If TFT forecast is available: `SS = P(service_level) - P50` of demand accumulated over lead time
- [x] AC-3: RULE — If TFT forecast is NOT available: `SS = Z * sqrt(LT * sigma_d^2 + d_bar^2 * sigma_LT^2)` (classical formula)
- [x] AC-4: RULE — `ROP = d_bar * LT + SS` (Reorder Point)
- [x] AC-5: RULE — `EOQ = sqrt(2 * D_annual * K / h)` (Economic Order Quantity, Wilson formula)
- [x] AC-6: RULE — `Min = ROP` (Minimum stock level equals reorder point)
- [x] AC-7: RULE — `Max = d_bar * (LT + R) + SS` where R = intervaloRevisaoDias from Produto
- [x] AC-8: The service stores calculation results in the parametros_estoque table linked to the current execucaoId
- [x] AC-9: The calculation method is recorded: TFT_QUANTIL when TFT is available, FORMULA_CLASSICA otherwise
- [x] AC-10: Service-level Z-scores are mapped: 90% -> 1.28, 95% -> 1.645, 97.5% -> 1.96, 99% -> 2.326
- [x] AC-11: If a product has estoqueSegurancaManual override set, use that value instead of calculated SS
- [x] AC-12: Unit tests >= 80% coverage with test cases for both TFT-available and classical formula paths

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/stock-params.service.ts]
- [Source: architecture/6-data-architecture.md — parametros_estoque table]

### Data Models

**ParametrosEstoque (Prisma — already exists):**
```prisma
model ParametrosEstoque {
  id                 String        @id @default(uuid())
  execucaoId         String        @map("execucao_id")
  produtoId          String        @map("produto_id")
  safetyStock        Decimal?      @map("safety_stock") @db.Decimal(12, 4)
  reorderPoint       Decimal?      @map("reorder_point") @db.Decimal(12, 4)
  estoqueMinimo      Decimal?      @map("estoque_minimo") @db.Decimal(12, 4)
  estoqueMaximo      Decimal?      @map("estoque_maximo") @db.Decimal(12, 4)
  eoq                Decimal?      @db.Decimal(12, 4)
  diasCoberturaAtual Decimal?      @map("dias_cobertura_atual") @db.Decimal(8, 2)
  metodoCalculo      MetodoCalculo @map("metodo_calculo")
  nivelServicoUsado  Decimal?      @map("nivel_servico_usado") @db.Decimal(5, 4)
  calculatedAt       DateTime?     @map("calculated_at") @db.Timestamptz()
}
```

### Formulas Detail

**TFT-based Safety Stock (when TFT forecast available):**
```
SS = quantile(service_level) - P50
     where quantile is selected from forecast_resultado quantile columns
     accumulated over lead time periods

Example: service_level = 95% -> use P90 column (nearest available quantile)
         SS = sum(P90 over LT weeks) - sum(P50 over LT weeks)
```

**Classical Safety Stock (when TFT NOT available):**
```
SS = Z * sqrt(LT * sigma_d^2 + d_bar^2 * sigma_LT^2)

Where:
  Z = Z-score for service level
  LT = lead time in weeks (from Produto.leadTimeProducaoDias / 7 or ProdutoFornecedor.leadTimeDias / 7)
  sigma_d = standard deviation of weekly demand (from SerieTemporal)
  d_bar = average weekly demand (from SerieTemporal)
  sigma_LT = standard deviation of lead time (from ProdutoFornecedor.leadTimeMinDias, leadTimeMaxDias)
```

**EOQ (Wilson Formula):**
```
EOQ = sqrt(2 * D_annual * K / h)

Where:
  D_annual = annual demand (d_bar * 52)
  K = ordering cost (Produto.custoPedido)
  h = holding cost per unit per year (Produto.custoUnitario * Produto.custoManutencaoPctAno / 100)
```

### Inputs Required

| Input | Source | Field |
|-------|--------|-------|
| Lead time (days) | ProdutoFornecedor (COMPRA) or Produto.leadTimeProducaoDias (PRODUCAO) | leadTimeDias |
| Average demand | SerieTemporal (last 52 weeks) | volume |
| Demand std dev | SerieTemporal (last 52 weeks) | calculated from volume |
| LT std dev | ProdutoFornecedor | (leadTimeMaxDias - leadTimeMinDias) / 6 |
| TFT quantiles | ForecastResultado | p10, p25, p50, p75, p90 |
| Ordering cost | Produto | custoPedido |
| Unit cost | Produto | custoUnitario |
| Holding % | Produto | custoManutencaoPctAno |
| Review interval | Produto | intervaloRevisaoDias |
| Service level | ConfigSistema | default 95% |
| Manual SS override | Produto | estoqueSegurancaManual |

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/engine/stock-params.service.ts`
- `apps/api/src/modules/mrp/engine/stock-params.service.spec.ts`

**Modified:**
- `apps/api/src/modules/mrp/mrp.module.ts` (register StockParamsService)

### Testing Requirements

Test cases:
1. TFT path: TFT forecast available, SS calculated from quantile difference
2. Classical path: no TFT, SS calculated from Z * sqrt formula
3. Manual override: estoqueSegurancaManual set, skip calculation
4. EOQ calculation with known inputs (verify against manual calculation)
5. ROP = d_bar * LT + SS (verify)
6. Min = ROP, Max = d_bar * (LT + R) + SS (verify)
7. Edge case: zero demand -> SS = 0, EOQ = 0
8. Edge case: missing custoPedido -> EOQ defaults to 0 or uses L4L
9. Different service levels: 90%, 95%, 99% produce increasing SS values

### Technical Constraints
- RULE: If TFT available: SS = P(service_level) - P50 of demand accumulated over lead time
- RULE: If TFT not available: SS = Z * sqrt(LT * sigma_d^2 + d_bar^2 * sigma_LT^2)
- RULE: ROP = d_bar * LT + SS
- RULE: EOQ = sqrt(2 * D_annual * K / h)
- RULE: Min = ROP; Max = d_bar * (LT + R) + SS
- MetodoCalculo must be set correctly: TFT_QUANTIL or FORMULA_CLASSICA
- All calculations use 4-decimal precision

---

## Tasks / Subtasks

- [x] **Task 1: Implement Z-score lookup table** (AC: 10)
  - [x] Static ReadonlyMap with nearest-match fallback
  - [x] Support: 90%→1.28, 95%→1.645, 97.5%→1.96, 99%→2.326

- [x] **Task 2: Implement demand statistics helper** (AC: 2, 3)
  - [x] Calculate d_bar (average weekly demand) from SerieTemporal last 52 weeks
  - [x] Calculate sigma_d (population std dev of weekly demand)
  - [x] Calculate D_annual (d_bar * 52)

- [x] **Task 3: Implement lead time statistics helper** (AC: 3, 4)
  - [x] COMPRA: ProdutoFornecedor (isPrincipal) + Fornecedor.leadTimeMinDias/MaxDias
  - [x] PRODUCAO: Produto.leadTimeProducaoDias, sigma_LT = 0
  - [x] sigma_LT = (leadTimeMaxDias - leadTimeMinDias) / 6

- [x] **Task 4: Implement TFT-based SS calculation** (AC: 2)
  - [x] Query latest ForecastResultado with targetType=VOLUME
  - [x] Quantile mapping: 90%→p75, 95%→p90, etc.
  - [x] SS = SUM(P_quantile over LT weeks) - SUM(P50 over LT weeks), floored to 0

- [x] **Task 5: Implement classical SS calculation** (AC: 3)
  - [x] SS = Z * sqrt(LT * sigma_d^2 + d_bar^2 * sigma_LT^2)

- [x] **Task 6: Implement EOQ, ROP, Min, Max calculations** (AC: 4-7)
  - [x] EOQ = sqrt(2 * D_annual * K / h) with L4L fallback for invalid inputs
  - [x] ROP = d_bar * LT + SS
  - [x] Min = ROP
  - [x] Max = d_bar * (LT + R) + SS

- [x] **Task 7: Implement main calculateForProduct method** (AC: 1, 8, 9, 11)
  - [x] Manual override check first (AC-11)
  - [x] TFT path → Classical fallback (AC-9)
  - [x] Persists to parametros_estoque (AC-8)

- [x] **Task 8: Write comprehensive unit tests** (AC: 12)
  - [x] 52 tests covering TFT path, classical path, manual override, EOQ, ROP, Min/Max, edge cases
  - [x] 99% statement coverage, 98% branch coverage

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/stock-params.interface.ts` | Created | Interfaces for stock param calculation |
| `apps/api/src/modules/mrp/engine/stock-params.service.ts` | Created | SS, ROP, EOQ, Min, Max calculation service (549 lines) |
| `apps/api/src/modules/mrp/engine/stock-params.service.spec.ts` | Created | 52 unit tests (99% coverage) |
| `apps/api/src/modules/mrp/mrp.module.ts` | Modified | Added StockParamsService provider/export |

---

## Dependencies

- Story 2.6: Forecast Execution Pipeline (ForecastResultado with quantile outputs must exist)
- Story 1.9: Warehouse & Inventory Management (InventarioAtual data)
- Story 1.3: Product CRUD (Produto with cost fields)
- Story 1.5: Supplier CRUD (ProdutoFornecedor with lead time fields)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-26 | 0.2 | Implementation complete — 3 files created, 1 modified, 52 tests (99% coverage) | Dex (Dev) |
| 2026-02-26 | 0.3 | QA Review PASS w/ CONCERNS — 12/12 AC, formulas correct, 2 non-blocking concerns | Quinn (QA) |
