# Story 3.6: Master Production Schedule (MPS)

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** the system to generate a Master Production Schedule from forecast and firm orders for finished products,
**so that** the MRP engine has a validated demand plan as its top-level input driving all downstream planning.

## References

- FR-034: Master Production Schedule (MPS)
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/mps.service.ts]

## Acceptance Criteria

- [x] AC-1: MpsService generates an MPS for all finished products (tipoProduto = ACABADO) over a configurable planning horizon (default 13 weeks)
- [x] AC-2: RULE — `demand(t) = MAX(forecast_P50(t), firm_orders(t))` for each product and period
- [x] AC-3: RULE — Firm order horizon: configurable 2-4 weeks (default from ConfigSistema); within this horizon, firm orders take priority via MAX comparison
- [x] AC-4: Beyond the firm order horizon: demand = forecast_P50 only (no firm orders beyond this window)
- [x] AC-5: Forecast data is read from ForecastResultado for the latest completed forecast execution (targetType = VOLUME, modeloUsado = latest)
- [x] AC-6: Firm orders are read from OrdemPlanejada with status = FIRME and tipo = PRODUCAO, grouped by product and period
- [x] AC-7: The MPS output is a map of produtoId -> time-phased demand array (weekly buckets), used as input for BOM explosion (level 0 demand)
- [x] AC-8: If no forecast exists for a product, MPS uses firm orders only (with warning logged)
- [x] AC-9: If no firm orders exist for a product, MPS uses forecast only
- [x] AC-10: MPS generation logs the number of products processed and total demand planned
- [x] AC-11: Unit tests >= 80% coverage with test cases for MAX rule, firm order horizon, and missing data scenarios

## Dev Notes

### Architecture References
- [Source: architecture/4-backend-architecture.md#4.1 — mrp/engine/mps.service.ts]

### MPS Generation Algorithm

```
1. Determine planning horizon: today + N weeks (default N = 13)
2. Determine firm order horizon: today + M weeks (default M = 2-4, from ConfigSistema)
3. Load latest ForecastResultado (targetType = VOLUME) per finished product
4. Load firm OrdemPlanejada per finished product

For each finished product:
  For each weekly bucket t in planning horizon:
    forecastDemand = ForecastResultado.p50 for product in period t (or 0 if missing)
    firmOrderDemand = sum of OrdemPlanejada.quantidade WHERE status=FIRME AND dataNecessidade in period t

    if t <= firmOrderHorizon:
      demand[t] = MAX(forecastDemand, firmOrderDemand)
    else:
      demand[t] = forecastDemand

  mps[produtoId] = demand array
```

### Data Structures

```typescript
interface MpsInput {
  planningHorizonWeeks: number;     // default 13
  firmOrderHorizonWeeks: number;    // default from ConfigSistema (2-4)
  startDate: Date;                   // planning start (typically current week Monday)
}

interface MpsDemandBucket {
  periodStart: Date;
  periodEnd: Date;
  forecastDemand: number;
  firmOrderDemand: number;
  mpsDemand: number; // MAX(forecast, firmOrders) or forecast-only
}

interface MpsOutput {
  generatedAt: Date;
  planningHorizonWeeks: number;
  firmOrderHorizonWeeks: number;
  products: Map<string, MpsDemandBucket[]>;
  totalProductsProcessed: number;
  totalDemandPlanned: number;
}
```

### ConfigSistema Keys

| Key | Default | Description |
|-----|---------|-------------|
| `mrp.planning_horizon_weeks` | 13 | Number of weeks for MPS/MRP planning |
| `mrp.firm_order_horizon_weeks` | 3 | Number of weeks where firm orders are considered |

### File Locations

**Backend (new files):**
- `apps/api/src/modules/mrp/engine/mps.service.ts`
- `apps/api/src/modules/mrp/engine/mps.service.spec.ts`
- `apps/api/src/modules/mrp/engine/interfaces/mps.interface.ts`

**Modified:**
- `apps/api/src/modules/mrp/mrp.module.ts` (register MpsService)

### Testing Requirements

Test cases:
1. Both forecast and firm orders exist: demand = MAX(forecast, firm) within firm horizon
2. Firm order > forecast: demand = firm order
3. Forecast > firm order: demand = forecast
4. Beyond firm horizon: demand = forecast only (firm orders ignored)
5. No forecast for product: demand = firm orders with warning
6. No firm orders for product: demand = forecast only
7. No data at all for product: demand = 0 for all periods
8. Firm order horizon boundary: exact week boundary behaves correctly
9. Multiple products: each processed independently
10. Planning horizon: 13 weekly buckets generated

### Technical Constraints
- RULE: demand(t) = MAX(forecast_P50(t), firm_orders(t))
- RULE: Firm order horizon: 2-4 weeks (configurable)
- Only process finished products (tipoProduto = ACABADO)
- Weekly buckets aligned to Monday-Sunday
- Forecast comes from latest completed execution (StatusExecucao = CONCLUIDO)

---

## Tasks / Subtasks

- [x] **Task 1: Define MPS interfaces** (AC: 7)
  - [x] Create `mps.interface.ts` with MpsInput, MpsDemandBucket, MpsProductResult, MpsOutput

- [x] **Task 2: Implement forecast data loader** (AC: 5, 8)
  - [x] Query latest completed ForecastResultado (targetType = VOLUME)
  - [x] Group by produtoId and periodo
  - [x] Handle missing forecast gracefully (return empty map + log warning)

- [x] **Task 3: Implement firm order data loader** (AC: 6, 9)
  - [x] Query OrdemPlanejada WHERE status = FIRME AND tipo = PRODUCAO
  - [x] Group by produtoId and weekly bucket
  - [x] Handle missing firm orders (return empty map)

- [x] **Task 4: Implement MPS demand calculation** (AC: 1-4)
  - [x] Load planning horizon and firm order horizon from ConfigSistema
  - [x] For each finished product and period: apply MAX rule within firm horizon, forecast-only beyond
  - [x] Generate weekly buckets aligned to Monday-Sunday

- [x] **Task 5: Implement MPS orchestrator method** (AC: 1, 7, 10)
  - [x] `generateMps(input: MpsInput): MpsOutput`
  - [x] Load all required data
  - [x] Process all finished products
  - [x] Log summary statistics

- [x] **Task 6: Write comprehensive unit tests** (AC: 11)
  - [x] 53 test cases covering all ACs (100% coverage)
  - [x] Mock PrismaService for ForecastResultado, OrdemPlanejada, ConfigSistema

- [x] **Task 7: Register service in MRP module** (AC: all)
  - [x] Register MpsService in MRP module

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/mrp/engine/interfaces/mps.interface.ts` | Created | MPS interfaces (MpsInput, MpsDemandBucket, MpsProductResult, MpsOutput) |
| `apps/api/src/modules/mrp/engine/mps.service.ts` | Created | MPS generation engine — PrismaService injection, forecast/firm-order loading, MAX demand rule (480 lines) |
| `apps/api/src/modules/mrp/engine/mps.service.spec.ts` | Created | 53 unit tests (100% coverage) |
| `apps/api/src/modules/mrp/mrp.module.ts` | Modified | Added MpsService provider/export |

---

## Dependencies

- Story 2.6: Forecast Execution Pipeline (ForecastResultado with P50 values must exist)
- Story 1.3: Product CRUD (Produto with tipoProduto = ACABADO filter)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created for Epic 3 — MRP Planning Engine | River (SM) |
| 2026-02-27 | 0.2 | Implementation complete — 3 files created, 1 modified, 53 tests (100% coverage) | Dex (Dev) |
| 2026-02-27 | 0.3 | QA Review PASS WITH CONCERNS — 11/11 AC, 2 HIGH (config parsing defensive, firm horizon range validation missing), 0 CRITICAL | Quinn (QA) |
