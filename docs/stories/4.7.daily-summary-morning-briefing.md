# Story 4.7: Daily Summary & Morning Briefing Emails

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production manager,
**I want** to receive automated daily summary and morning briefing emails after the daily pipeline completes,
**so that** I have a comprehensive overview of supply chain status before starting my workday.

## References

- FR-053: Daily Summary Email
- FR-063: Morning Briefing Email
- [Source: architecture/9-integration-patterns.md]

## Acceptance Criteria

### Daily Summary Email (FR-053)
- [x] AC-1: Email sent automatically after daily pipeline completes
- [x] AC-2: Section "Yesterday's Closing": real vs forecast revenue, volume sold, average ticket
- [x] AC-3: Section "Stock Alerts": SKUs below Safety Stock (count + list), SKUs approaching ROP
- [x] AC-4: Section "Urgent Purchases": total value and order count in next 7 days
- [x] AC-5: Section "Capacity": utilization per work center with overload alerts
- [x] AC-6: Section "Forecast Accuracy": MAPE per class (A, B, C) for last 4 weeks

### Morning Briefing Email (FR-063)
- [x] AC-7: Comprehensive briefing email sent before workday begins (after pipeline + summary)
- [x] AC-8: Includes all sections from daily summary PLUS: top 5 actions required today, pipeline execution status, model health summary
- [x] AC-9: Formatted as responsive HTML email readable on mobile

### Email Configuration
- [x] AC-10: Recipient list configurable per email type (summary vs briefing)
- [x] AC-11: Email sending via Nodemailer (SMTP configuration in `config_sistema`)
- [x] AC-12: CC/BCC support for distribution to multiple managers

### Email Templates
- [x] AC-13: HTML email templates with responsive design (works on desktop + mobile)
- [x] AC-14: Template uses company branding (configurable logo, colors)
- [x] AC-15: Each section has conditional rendering (skip section if no data/alerts)

### API
- [x] AC-16: `POST /automation/emails/send-summary` — manually trigger summary email
- [x] AC-17: `POST /automation/emails/send-briefing` — manually trigger briefing email
- [x] AC-18: `GET /automation/emails/history` — list sent emails with delivery status

### Testing
- [x] AC-19: Backend unit tests for email content generation and template rendering (80%+ coverage)
- [x] AC-20: Frontend render tests for email configuration components

## Dev Notes

### Email Template Structure

```html
<!-- Daily Summary Email Template -->
<h1>Resumo Diário — {date}</h1>
<section id="closing">Yesterday's Closing...</section>
<section id="stock-alerts">Stock Alerts...</section>
<section id="urgent-purchases">Urgent Purchases...</section>
<section id="capacity">Capacity Status...</section>
<section id="accuracy">Forecast Accuracy...</section>
```

### File Locations

**Backend:**
- `apps/api/src/modules/automation/emails/` — service, templates, DTOs
- `apps/api/src/modules/automation/emails/templates/` — HTML email templates

**Frontend:**
- `apps/web/src/app/automacao/components/email-config.tsx` (extended)

---

## Tasks / Subtasks

- [x] **Task 1: Create email content aggregation service** (AC: 2-6, 8)
- [x] **Task 2: Build responsive HTML email templates** (AC: 13, 14, 15)
- [x] **Task 3: Implement daily summary email sending** (AC: 1, 10, 11, 12)
- [x] **Task 4: Implement morning briefing email** (AC: 7, 8, 9)
- [x] **Task 5: Create API endpoints for manual trigger and history** (AC: 16, 17, 18)
- [x] **Task 6: Add email configuration UI** (AC: 10)
- [x] **Task 7: Write backend unit tests** (AC: 19)
- [x] **Task 8: Write frontend render tests** (AC: 20)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/automation/emails/daily-summary.types.ts` | Created | Types, constants, config interfaces |
| `apps/api/src/modules/automation/emails/email-sender.service.ts` | Created | Nodemailer wrapper with SMTP config from DB |
| `apps/api/src/modules/automation/emails/email-aggregator.service.ts` | Created | Data aggregation from Notificacao, OrdemPlanejada, EventoCapacidade, ForecastMetrica |
| `apps/api/src/modules/automation/emails/email-templates.ts` | Created | HTML + plain text template builders |
| `apps/api/src/modules/automation/emails/daily-summary.service.ts` | Created | Orchestrator: aggregate -> render -> send -> log |
| `apps/api/src/modules/automation/emails/daily-summary.controller.ts` | Created | REST endpoints for email management |
| `apps/api/src/modules/automation/emails/dto/email-config.dto.ts` | Created | UpdateEmailConfigDto with class-validator |
| `apps/api/src/modules/automation/emails/dto/filter-email.dto.ts` | Created | FilterEmailDto extending PaginationDto |
| `apps/api/src/modules/automation/automation.module.ts` | Modified | Registered email services and controller |
| `apps/api/src/modules/automation/pipeline/pipeline.service.ts` | Modified | Wired DailySummaryService for email step |
| `apps/api/src/modules/automation/pipeline/pipeline.service.spec.ts` | Modified | Added DailySummaryService mock |
| `apps/api/package.json` | Modified | Added nodemailer + @types/nodemailer |
| `apps/api/src/modules/automation/emails/__tests__/daily-summary.service.spec.ts` | Created | 11 tests: config, send, history |
| `apps/api/src/modules/automation/emails/__tests__/email-sender.service.spec.ts` | Created | 7 tests: config, send, no-op, reuse |
| `apps/api/src/modules/automation/emails/__tests__/email-aggregator.service.spec.ts` | Created | 7 tests: aggregation, graceful degradation |
| `apps/api/src/modules/automation/emails/__tests__/email-templates.spec.ts` | Created | 7 tests: HTML, text, conditional sections |
| `apps/api/src/modules/automation/emails/__tests__/daily-summary.controller.spec.ts` | Created | 5 tests: controller endpoints |
| `apps/web/src/types/email.ts` | Created | Frontend types for email management |
| `apps/web/src/hooks/use-emails.ts` | Created | React Query hooks for email API |
| `apps/web/src/app/automacao/emails/page.tsx` | Created | Email management page (config + send + history) |
| `apps/web/src/app/automacao/emails/__tests__/emails-page.test.tsx` | Created | 7 tests: render, config, history |

---

## Dependencies

- Story 4.6: Daily Automated Pipeline (triggers email sending)
- Story 4.4: Alert System (provides alert data for email sections)
- Story 3.11: Purchasing Panel (Nodemailer infrastructure already in place)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Full implementation: types, services, templates, controller, DTOs, frontend, tests (20/20 ACs) | Dex (Dev) |
| 2026-02-27 | 0.3 | Code review fixes: @IsEmail validation, query limits, password sentinel, HTML escaping, dead params removed | Dex (Dev) |
