# Story 2.1: FastAPI Infrastructure & Database Repositories

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["pytest", "ruff", "mypy"]

## Story

**As a** ML engineer,
**I want** the FastAPI forecast-engine to have proper database connectivity, SQLAlchemy models, repositories, and API route structure,
**so that** subsequent stories can implement ML models and pipelines on a solid foundation.

## Acceptance Criteria

1. SQLAlchemy async engine + session factory configured in `db/database.py` using `asyncpg`
2. SQLAlchemy ORM models mirror Prisma schema for: `SerieTemporal`, `SkuClassification`, `ForecastResultado`, `ForecastMetrica`, `ForecastModelo`, `ExecucaoPlanejamento`, `ExecucaoStepLog`
3. Repository layer with `TimeSeriesRepository` (read serie_temporal with date range, product filter, weekly aggregation)
4. Repository layer with `ClassificationRepository` (read sku_classification with model suggestion)
5. Repository layer with `ForecastRepository` (write forecast_resultado, forecast_metrica, forecast_modelo)
6. Repository layer with `ExecutionRepository` (CRUD execucao_planejamento, write step logs)
7. `POST /train` route stub returns 202 Accepted with execution ID
8. `POST /predict` route stub returns 202 Accepted with execution ID
9. `POST /backtest` route stub returns 202 Accepted with execution ID
10. `GET /models` route stub returns empty list
11. All repositories covered by unit tests with mocked async sessions >= 80%
12. `ruff check` and `mypy --strict` pass with zero errors

## Tasks / Subtasks

- [x] **Task 1: Configure SQLAlchemy async engine & session**
  - [x] Create `db/database.py` with async engine, sessionmaker, get_session dependency
  - [x] Add lifespan handler to `main.py` for engine startup/shutdown
- [x] **Task 2: Create SQLAlchemy ORM models**
  - [x] Create `db/models.py` mirroring 7 Prisma models with correct column mappings
  - [x] Define Python enums matching Prisma enums (TipoExecucao, StatusExecucao, etc.)
- [x] **Task 3: Create Repository layer**
  - [x] `db/repositories/time_series_repo.py` — read serie_temporal with filters
  - [x] `db/repositories/classification_repo.py` — read sku_classification
  - [x] `db/repositories/forecast_repo.py` — write forecast results, metrics, models
  - [x] `db/repositories/execution_repo.py` — CRUD execucao_planejamento + step logs
- [x] **Task 4: Create API route stubs**
  - [x] `api/routes/train.py` — POST /train (stub)
  - [x] `api/routes/predict.py` — POST /predict (stub)
  - [x] `api/routes/backtest.py` — POST /backtest (stub)
  - [x] `api/routes/models_meta.py` — GET /models (stub)
  - [x] `api/router.py` — aggregate all routers
  - [x] Update `main.py` to include all route modules
- [x] **Task 5: Write unit tests**
  - [x] Test repository methods with mocked AsyncSession
  - [x] Test route stubs return correct status codes
  - [x] Verify ruff + mypy pass

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- ruff auto-fix: `str, enum.Enum` → `enum.StrEnum`, `timezone.utc` → `UTC`, import sorting
- mypy strict: bare `dict` → `dict[str, Any]` in 6 files (14 occurrences)

### Completion Notes List
- 27 tests passing across 6 test files (98% coverage)
- ruff check: All checks passed (0 errors)
- mypy --strict: Success, no issues found in 24 source files
- SQLAlchemy async engine with pool_size=10, max_overflow=20, pool_pre_ping=True
- 7 ORM models mirroring Prisma schema with correct column mappings and relationships
- 10 Python StrEnums matching Prisma enums
- 4 repository classes with typed methods
- 4 API route stubs (train, predict, backtest, models) + health + root
- All routes return proper Pydantic response models
- Lifespan handler for engine disposal on shutdown

### File List

**Created:**
- `apps/forecast-engine/src/db/database.py`
- `apps/forecast-engine/src/db/models.py`
- `apps/forecast-engine/src/db/repositories/__init__.py`
- `apps/forecast-engine/src/db/repositories/time_series_repo.py`
- `apps/forecast-engine/src/db/repositories/classification_repo.py`
- `apps/forecast-engine/src/db/repositories/forecast_repo.py`
- `apps/forecast-engine/src/db/repositories/execution_repo.py`
- `apps/forecast-engine/src/api/router.py`
- `apps/forecast-engine/src/api/routes/__init__.py`
- `apps/forecast-engine/src/api/routes/train.py`
- `apps/forecast-engine/src/api/routes/predict.py`
- `apps/forecast-engine/src/api/routes/backtest.py`
- `apps/forecast-engine/src/api/routes/models_meta.py`
- `apps/forecast-engine/tests/conftest.py`
- `apps/forecast-engine/tests/test_time_series_repo.py`
- `apps/forecast-engine/tests/test_classification_repo.py`
- `apps/forecast-engine/tests/test_forecast_repo.py`
- `apps/forecast-engine/tests/test_execution_repo.py`
- `apps/forecast-engine/tests/test_routes.py`

**Modified:**
- `apps/forecast-engine/src/main.py` (lifespan handler, api_router, typed return)
- `apps/forecast-engine/src/api/health.py` (typed return)
