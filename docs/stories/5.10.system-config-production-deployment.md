# Story 5.10: System Configuration UI & Production Deployment

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** system administrator,
**I want** an admin UI backend for managing system configuration entries and production-ready Kubernetes deployment manifests,
**so that** I can tune forecast horizons, service levels, lot sizing defaults, and automation settings, and deploy the system to AWS EKS.

## References

- FR-074: Production Deployment (AWS EKS) — deploy with GPU Spot Instances, auto-scaling
- FR-076: System Configuration UI — admin UI for managing config_sistema entries
- [ConfigSistema model — already in Prisma schema at schema.prisma:758]

## Acceptance Criteria

### System Configuration API (FR-076)
- [x] AC-1: ConfigService.getAll() — list all configuration entries
- [x] AC-2: ConfigService.get(chave) — get a single config entry by key
- [x] AC-3: ConfigService.upsert(chave, valor, descricao) — create or update a config entry
- [x] AC-4: ConfigService.delete(chave) — remove a config entry
- [x] AC-5: ConfigService.getTyped<T>(chave) — typed accessor for known config keys
- [x] AC-6: ConfigController with CRUD endpoints (admin role required for write operations)
- [x] AC-7: Seed default config entries for known keys (forecast_horizon, service_level, etc.)

### Production Deployment (FR-074)
- [x] AC-8: Kubernetes deployment manifests — API, Web, Forecast Engine, PostgreSQL, Redis
- [x] AC-9: HPA (Horizontal Pod Autoscaler) for API and Forecast Engine
- [x] AC-10: GPU Spot Instance node selector for Forecast Engine pods
- [x] AC-11: ConfigMap and Secret templates for environment variables
- [x] AC-12: Ingress configuration with TLS

### Testing
- [x] AC-13: Unit tests for ConfigService (getAll, get, upsert, delete, getTyped)
- [x] AC-14: Tests for ConfigController endpoints

---

## Tasks / Subtasks

- [x] **Task 1: ConfigService** (AC: 1-5)
- [x] **Task 2: ConfigController** (AC: 6)
- [x] **Task 3: Default config seed** (AC: 7)
- [x] **Task 4: K8s manifests** (AC: 8-12)
- [x] **Task 5: Tests** (AC: 13-14)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/config/config-sistema.service.ts` | Created | ConfigSistemaService with getAll, get, getTyped, upsert, delete, seedDefaults |
| `apps/api/src/modules/config/config-sistema.controller.ts` | Created | ConfigController: GET /, GET /:chave, PATCH /:chave, DELETE /:chave, POST /seed |
| `apps/api/src/modules/config/config-sistema.module.ts` | Created | ConfigSistemaModule registered in AppModule |
| `apps/api/src/modules/config/config-sistema.service.spec.ts` | Created | Unit tests for ConfigSistemaService (14 tests) |
| `apps/api/src/modules/config/config-sistema.controller.spec.ts` | Created | Unit tests for ConfigSistemaController (5 tests) |
| `apps/api/src/app.module.ts` | Modified | Added ConfigSistemaModule to imports |
| `k8s/namespace.yaml` | Created | Kubernetes namespace definition |
| `k8s/configmap.yaml` | Created | ConfigMap for environment variables |
| `k8s/secrets.yaml` | Created | Secret template (placeholder values) |
| `k8s/postgres.yaml` | Created | PostgreSQL StatefulSet + Service with PVC |
| `k8s/redis.yaml` | Created | Redis Deployment + Service |
| `k8s/api.yaml` | Created | API Deployment + Service (2 replicas, topology spread) |
| `k8s/web.yaml` | Created | Web Deployment + Service (2 replicas) |
| `k8s/forecast-engine.yaml` | Created | Forecast Engine Deployment + Service (GPU Spot Instance) |
| `k8s/hpa.yaml` | Created | HPA for API (2-10 pods) and Forecast Engine (1-4 pods) |
| `k8s/ingress.yaml` | Created | ALB Ingress with TLS for api and web subdomains |
| `apps/api/src/modules/config/dto/upsert-config.dto.ts` | Created | DTO with validation for config upsert endpoint |

---

## Dependencies

- Story 0.3: Database Schema (ConfigSistema model)
- All Epic 1-5 stories (deployment of all modules)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — System Config & Production Deployment | River (SM) |
| 2026-02-28 | 0.2 | All ACs implemented — ConfigSistemaService/Controller, 10 K8s manifests, 19 unit tests — Story Done | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: UpsertConfigDto validation, lot_sizing_method enum aligned to Prisma, seedDefaults atomic createMany, Redis StatefulSet with PVC, pinned TimescaleDB version, removed duplicate REDIS_URL, removed deprecated ingress annotation (8 fixes) | Dex (Dev) |
