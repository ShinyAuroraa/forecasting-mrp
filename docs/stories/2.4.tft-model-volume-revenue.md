# Story 2.4: TFT Model (Volume & Revenue)

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["pytest", "ruff", "mypy"]

## Story

**As a** demand planner,
**I want** the system to use Temporal Fusion Transformer (TFT) models for volume and revenue forecasting on Class A/B SKUs,
**so that** high-value products get the most accurate deep learning forecasts with quantile intervals.

## References

- FR-023: TFT Model (Volume) — pytorch_forecasting TemporalFusionTransformer
- FR-024: TFT Model (Revenue) — TFT with price as observed variable
- CON-002: Minimum 40 weeks data for TFT

## Acceptance Criteria

1. [x] TFT config dataclass with hyperparameters (hidden_size, attention, epochs, quantiles)
2. [x] Separate TFTVolumeConfig and TFTRevenueConfig with appropriate targets
3. [x] TFT dataset preparation with lag features (1w, 2w, 4w, 8w, 13w, 26w, 52w)
4. [x] Rolling statistics features (mean/std at 4w and 13w windows)
5. [x] Temporal features (week_of_year, month, quarter)
6. [x] TFTModel implements AbstractForecastModel interface
7. [x] TFT Volume model name is "TFT", Revenue model name is "TFT_REVENUE"
8. [x] Quantile output with P10, P25, P50, P75, P90
9. [x] Quantile spread increases with forecast horizon
10. [x] Backtesting with MAPE/MAE/RMSE/Bias metrics
11. [x] Unit tests >= 80% coverage

## Tasks / Subtasks

- [x] **Task 1: Create TFT config**
  - [x] `models/tft/tft_config.py` — TFTConfig, TFTVolumeConfig, TFTRevenueConfig
- [x] **Task 2: Create TFT dataset preparation**
  - [x] `models/tft/tft_dataset.py` — lag, rolling, temporal feature engineering
- [x] **Task 3: Create TFT model**
  - [x] `models/tft/tft_model.py` — AbstractForecastModel implementation
  - [x] Statistical fallback when torch not installed
- [x] **Task 4: Write unit tests**
  - [x] Config tests (frozen, defaults, volume/revenue)
  - [x] Dataset tests (lags, rolling, temporal, prepare)
  - [x] Model tests (train, predict, backtest, quantile ordering)

## File List

| File | Action |
|------|--------|
| `apps/forecast-engine/src/models/tft/__init__.py` | Created |
| `apps/forecast-engine/src/models/tft/tft_config.py` | Created |
| `apps/forecast-engine/src/models/tft/tft_dataset.py` | Created |
| `apps/forecast-engine/src/models/tft/tft_model.py` | Created |
| `apps/forecast-engine/tests/test_tft_model.py` | Created |

## Quality Gate Results

| Gate | Result |
|------|--------|
| ruff check | PASS — 0 errors |
| mypy --strict | PASS — 0 issues (4 files) |
| pytest | PASS — 30/30 tests |
| Coverage (tft_config.py) | 100% |
| Coverage (tft_dataset.py) | 100% |
| Coverage (tft_model.py) | 94% |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |
| 2026-02-26 | 1.0 | Implementation complete, all quality gates pass | Dex (Dev) |
