# Story 1.8: Scheduled Stops & Capacity Events

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@architect"
quality_gate_tools: ["typecheck", "lint", "test"]

## Story

**As a** production manager,
**I want** to register scheduled stops and capacity events per work center,
**so that** the capacity planning engine accounts for real downtime and adjustments.

## Acceptance Criteria

1. `POST /api/v1/paradas-programadas` creates a scheduled stop linked to a work center
2. `GET /api/v1/paradas-programadas?centroTrabalhoId=X` lists stops for a work center
3. `PATCH /api/v1/paradas-programadas/:id` updates stop fields
4. `DELETE /api/v1/paradas-programadas/:id` removes a stop (hard delete)
5. Scheduled stops have tipo, dataInicio, dataFim, motivo, recorrente, cronExpression
6. `POST /api/v1/eventos-capacidade` records a capacity event
7. `GET /api/v1/eventos-capacidade?centroTrabalhoId=X` lists events as timeline
8. `PATCH /api/v1/eventos-capacidade/:id` updates event fields
9. Capacity events track field changes (campoAlterado, valorAnterior, valorNovo)
10. Module requires operator role for write, viewer for read
11. All services covered by unit tests >= 80%

## Tasks / Subtasks

- [x] **Task 1: Create ParadaProgramada DTOs, Repository, Service, Controller**
- [x] **Task 2: Create EventoCapacidade DTOs, Repository, Service, Controller**
- [x] **Task 3: Register in CentrosTrabalhoModule**
- [x] **Task 4: Write Unit Tests**

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-26 | 0.1 | Story created | River (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6) — via AIOS greenfield-fullstack engine

### Debug Log References
- No errors encountered — clean implementation

### Completion Notes List
- 20 new tests (5 parada service, 6 parada controller, 4 evento service, 5 evento controller)
- 227/227 total tests passing across 34 suites
- Build clean, no TypeScript errors
- ParadaProgramada: CRUD with hard delete, recurrence support via cronExpression
- EventoCapacidade: Create/Read/Update (no delete — events are audit records)

### File List

**Created:**
- `apps/api/src/modules/centros-trabalho/paradas-programadas/dto/create-parada-programada.dto.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/dto/update-parada-programada.dto.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/dto/filter-parada-programada.dto.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/paradas-programadas.repository.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/paradas-programadas.service.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/paradas-programadas.service.spec.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/paradas-programadas.controller.ts`
- `apps/api/src/modules/centros-trabalho/paradas-programadas/paradas-programadas.controller.spec.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/dto/create-evento-capacidade.dto.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/dto/update-evento-capacidade.dto.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/dto/filter-evento-capacidade.dto.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/eventos-capacidade.repository.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/eventos-capacidade.service.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/eventos-capacidade.service.spec.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/eventos-capacidade.controller.ts`
- `apps/api/src/modules/centros-trabalho/eventos-capacidade/eventos-capacidade.controller.spec.ts`

**Modified:**
- `apps/api/src/modules/centros-trabalho/centros-trabalho.module.ts` (added paradas + eventos providers)

## QA Results
(To be populated by QA agent)
