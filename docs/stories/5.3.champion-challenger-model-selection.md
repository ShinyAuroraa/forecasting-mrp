# Story 5.3: Champion-Challenger Model Selection

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc", "pytest"]

## Story

**As a** data scientist / production planner,
**I want** automatic champion-challenger model selection during monthly retraining,
**so that** the system only promotes a new forecast model to production if it demonstrably outperforms the current champion, ensuring forecast accuracy never degrades.

## References

- R-A03: Monthly re-training with champion-challenger (only promotes if better)
- [Source: PRD §7.4 — Ciclos de Re-treino]
- [Story 2.5: Forecast Pipeline — existing training infrastructure]
- [ForecastModelo.isChampion flag — already exists in schema]

## Acceptance Criteria

### Champion-Challenger Comparison Logic (Python)
- [x] AC-1: ChampionChallengerService loads current champion per model type from ForecastModelo (isChampion=true)
- [x] AC-2: After backtest, compares new model metrics against current champion (not just baseline)
- [x] AC-3: Promotion rule: new model promoted only if MAPE < champion MAPE (per-product average)
- [x] AC-4: If no current champion exists, the new model is automatically promoted
- [x] AC-5: On promotion: old champion's isChampion set to false, new model's isChampion set to true
- [x] AC-6: Promotion decision logged with before/after MAPE comparison

### Integration with Backtesting Pipeline (Python)
- [x] AC-7: Backtester.collect_metadata() uses champion comparison instead of baseline-only
- [x] AC-8: Monthly cycle trigger (TipoExecucao.CICLO_MENSAL) runs full champion-challenger evaluation
- [x] AC-9: Stores promotion_log as JSON in ForecastModelo.metricasTreino for audit trail

### API Endpoint (NestJS)
- [x] AC-10: `GET /forecast/champion?tipoModelo=TFT` — returns current champion model metadata
- [x] AC-11: `GET /forecast/champion/history?tipoModelo=TFT` — returns promotion history (last 10 champion changes)

### Frontend
- [x] AC-12: Champion badge on forecast models list (when isChampion = true)
- [x] AC-13: Promotion history timeline showing model changes with MAPE deltas

### Testing
- [x] AC-14: Python unit tests for champion-challenger comparison (seeded data, deterministic)
- [x] AC-15: Python unit tests for promotion/no-promotion scenarios
- [x] AC-16: NestJS unit tests for champion API endpoints
- [x] AC-17: Frontend render tests for champion badge

---

## Tasks / Subtasks

- [x] **Task 1: Implement ChampionChallengerService in Python** (AC: 1-6)
- [x] **Task 2: Integrate with backtesting pipeline** (AC: 7-9)
- [x] **Task 3: Create NestJS API endpoints** (AC: 10, 11)
- [x] **Task 4: Create frontend components** (AC: 12, 13)
- [x] **Task 5: Write Python unit tests** (AC: 14, 15)
- [x] **Task 6: Write NestJS + frontend tests** (AC: 16, 17)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/forecast-engine/src/backtesting/champion_challenger.py` | Created | ChampionChallengerService with evaluate(), apply_promotion(), collect_metadata_with_champion(), PromotionDecision/PromotionLog dataclasses |
| `apps/forecast-engine/src/backtesting/backtester.py` | Modified | collect_metadata() now accepts optional champion_mapes dict for champion comparison, backward-compatible with baseline-only |
| `apps/forecast-engine/src/db/repositories/forecast_repo.py` | Modified | Added find_current_champion(), demote_champion(), promote_champion(), find_champion_history() methods |
| `apps/forecast-engine/src/db/models.py` | Modified | Added CICLO_DIARIO, CICLO_SEMANAL, CICLO_MENSAL, PIPELINE_DIARIO to TipoExecucao enum |
| `apps/forecast-engine/tests/test_champion_challenger.py` | Created | 16 tests: 6 evaluate tests, 4 apply_promotion tests, 5 backtester integration tests, 1 promotion_log audit test |
| `apps/api/src/modules/forecast/forecast.controller.ts` | Modified | Added GET /forecast/champion and GET /forecast/champion/history endpoints |
| `apps/api/src/modules/forecast/forecast.service.ts` | Modified | Added findCurrentChampion() and findChampionHistory() methods |
| `apps/api/src/modules/forecast/forecast.repository.ts` | Modified | Added findCurrentChampion() and findChampionHistory() Prisma queries |
| `apps/api/src/modules/forecast/forecast.interfaces.ts` | Modified | Added ChampionInfo and PromotionHistoryEntry interfaces |
| `apps/api/src/modules/forecast/dto/champion-query.dto.ts` | Created | ChampionQueryDto with optional tipoModelo filter |
| `apps/api/src/modules/forecast/forecast.service.spec.ts` | Modified | Added 7 tests for findCurrentChampion and findChampionHistory |
| `apps/api/src/modules/forecast/forecast.controller.spec.ts` | Modified | Added 5 tests for champion and champion/history endpoints |
| `apps/web/src/hooks/use-forecast.ts` | Modified | Added useCurrentChampion() and useChampionHistory() hooks, ChampionInfo interface |
| `apps/web/src/components/forecast/champion-history.tsx` | Created | ChampionHistory component with timeline visualization, promotion badges, MAPE delta display |
| `apps/web/src/components/forecast/__tests__/champion.test.tsx` | Created | 10 tests: 4 ModelList champion badge tests, 6 ChampionHistory timeline tests |
| `apps/web/src/app/forecast/page.tsx` | Modified | Added ChampionHistory component to forecast page |

---

## Dependencies

- Story 2.5: Forecast Pipeline (existing training infrastructure)
- Story 1.11: SKU Classification (modeloForecastSugerido)
- ForecastModelo.isChampion flag (already in schema)
- Backtester.collect_metadata() (existing logic to extend)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-28 | 0.1 | Story created for Epic 5 — Champion-Challenger Model Selection | River (SM) |
| 2026-02-28 | 0.2 | Full implementation: ChampionChallengerService (Python) with evaluate/apply_promotion/collect_metadata_with_champion. Backtester.collect_metadata extended with optional champion_mapes for champion comparison (backward-compatible). ForecastRepository extended with find/demote/promote queries. TipoExecucao synced with Prisma enum. NestJS GET /forecast/champion and /champion/history endpoints. ChampionHistory timeline component with promotion badges and MAPE deltas. 16 Python + 12 NestJS + 10 frontend tests (17/17 ACs) | Dex (Dev) |
| 2026-02-28 | 0.3 | Code review fixes: Fixed ChampionInfo/PromotionHistoryEntry interfaces to use Prisma field names (tipoModelo, versao, metricasTreino, treinadoEm). Fixed Badge variants to use valid 'info'/'warning' instead of non-existent 'outline'/'secondary'. Fixed `champion_mape or 0.0` to explicit `is not None` guard in logger | Quinn (QA) |
