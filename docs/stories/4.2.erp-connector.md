# Story 4.2: ERP Connector (REST/DB/SFTP)

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** system administrator,
**I want** to configure ERP data connectors (REST API, direct database, or SFTP/folder monitoring),
**so that** the system can automatically fetch daily movement data from the company's ERP.

## References

- FR-051: ERP Connector
- [Source: architecture/9-integration-patterns.md#9.2 — ERP Connector Pattern]

## Acceptance Criteria

### Connector Interface (FR-051)
- [x] AC-1: System supports three connector types: REST API, Direct DB (read-only), and SFTP/folder monitoring
- [x] AC-2: All connectors implement a common `ErpConnector` interface: `fetchDailyData(date)`, `testConnection()`
- [x] AC-3: Active connector is selected via `config_sistema` (`automacao.erp.tipo`)
- [x] AC-4: Primary + fallback connector configuration supported

### REST API Connector
- [x] AC-5: Configurable endpoint URL, authentication (API key, Bearer token, Basic), and response format (JSON/XML)
- [x] AC-6: `GET /api/movimentacoes?data={yesterday}` pattern with configurable query parameters

### Direct DB Connector
- [x] AC-7: Read-only connection string configuration (NFR-020 compliance)
- [x] AC-8: Incremental query: `WHERE data_movimento = CURRENT_DATE - 1`
- [x] AC-9: Connection pooling with max 5 connections (non-destructive read)

### SFTP/Folder Connector
- [x] AC-10: SFTP host/port/credentials configuration
- [x] AC-11: Folder polling with configurable interval
- [x] AC-12: File pattern matching (e.g., `fechamento_*.csv`)

### ETL Pipeline Integration
- [x] AC-13: Regardless of connector type, data flows through: Raw → Staging → Validation → Cleaning → Clean data
- [x] AC-14: Connector applies saved mapping template (from Story 4.1) automatically
- [x] AC-15: Failed records are logged with error details; successful records proceed

### Configuration UI
- [x] AC-16: `/automacao` page section for ERP connector configuration
- [x] AC-17: "Test Connection" button that validates the configured connector

### Testing
- [x] AC-18: Backend unit tests for all three connector implementations (80%+ coverage)
- [x] AC-19: Frontend render tests for connector configuration UI

## Dev Notes

### Architecture Pattern

```typescript
interface ErpConnector {
  fetchDailyData(date: Date): Promise<RawMovementData[]>;
  testConnection(): Promise<boolean>;
}

class RestApiConnector implements ErpConnector { ... }
class DirectDbConnector implements ErpConnector { ... }  // Read-only
class SftpConnector implements ErpConnector { ... }
```

### File Locations

**Backend:**
- `apps/api/src/modules/automation/connectors/` — ErpConnector interface + 3 implementations
- `apps/api/src/modules/automation/automation.module.ts`
- `apps/api/src/modules/automation/automation.controller.ts`
- `apps/api/src/modules/automation/automation.service.ts`

**Frontend:**
- `apps/web/src/app/automacao/page.tsx`
- `apps/web/src/app/automacao/components/connector-config.tsx`

---

## Tasks / Subtasks

- [x] **Task 1: Create ErpConnector interface and factory** (AC: 1, 2, 3, 4)
- [x] **Task 2: Implement RestApiConnector** (AC: 5, 6)
- [x] **Task 3: Implement DirectDbConnector** (AC: 7, 8, 9)
- [x] **Task 4: Implement SftpConnector** (AC: 10, 11, 12)
- [x] **Task 5: Integrate connectors with ETL pipeline** (AC: 13, 14, 15)
- [x] **Task 6: Create Automation module (NestJS)** (AC: 16, 17)
- [x] **Task 7: Implement connector configuration frontend** (AC: 16, 17)
- [x] **Task 8: Write backend unit tests** (AC: 18)
- [x] **Task 9: Write frontend render tests** (AC: 19)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/src/modules/automation/connectors/erp-connector.interface.ts` | Created | ErpConnector interface, RawMovementData, config types (REST/DB/SFTP/ErpConfig) |
| `apps/api/src/modules/automation/connectors/rest-api.connector.ts` | Created | REST API connector: bearer/apiKey/basic auth, JSON/XML parsing, configurable query params |
| `apps/api/src/modules/automation/connectors/direct-db.connector.ts` | Created | Direct DB connector: pg Pool max 5, incremental query with $1 date param |
| `apps/api/src/modules/automation/connectors/sftp.connector.ts` | Created | SFTP connector: ssh2-sftp-client, file pattern matching, CSV parsing |
| `apps/api/src/modules/automation/connectors/connector.factory.ts` | Created | Factory pattern creating correct connector from ErpConfig + type |
| `apps/api/src/modules/automation/dto/erp-config.dto.ts` | Created | DTOs: UpdateErpConfigDto, TestConnectionDto, FetchDailyDataDto with nested validation |
| `apps/api/src/modules/automation/automation.service.ts` | Created | Service: config CRUD via config_sistema, primary+fallback fetch, ETL pipeline integration |
| `apps/api/src/modules/automation/automation.controller.ts` | Created | Controller: GET/PUT config, POST test-connection, POST fetch |
| `apps/api/src/modules/automation/automation.module.ts` | Created | NestJS module importing IngestaoModule for ETL pipeline access |
| `apps/api/src/modules/ingestao/ingestao.module.ts` | Modified | Added exports: IngestaoUploadService, MappingTemplateRepository |
| `apps/api/src/app.module.ts` | Modified | Added AutomationModule to imports |
| `apps/web/src/types/automation.ts` | Created | TypeScript interfaces for connector configs and results |
| `apps/web/src/hooks/use-automation.ts` | Created | React Query hooks: useErpConfig, useUpdateErpConfig, useTestConnection, useFetchDailyData |
| `apps/web/src/app/automacao/page.tsx` | Created | Automation page with config form, test connection, manual fetch |
| `apps/web/src/app/automacao/components/connector-config.tsx` | Created | Connector config form: REST/DB/SFTP fields, auth type switching, fallback selector |
| `apps/api/src/modules/automation/automation.service.spec.ts` | Created | Service unit tests (8 test cases) |
| `apps/api/src/modules/automation/automation.controller.spec.ts` | Created | Controller unit tests (6 test cases) |
| `apps/api/src/modules/automation/connectors/rest-api.connector.spec.ts` | Created | REST connector tests (8 test cases): auth types, JSON/XML, data path |
| `apps/api/src/modules/automation/connectors/direct-db.connector.spec.ts` | Created | DB connector tests (5 test cases): query params, pooling, dispose |
| `apps/api/src/modules/automation/connectors/sftp.connector.spec.ts` | Created | SFTP connector tests (5 test cases): file matching, CSV parse, cleanup |
| `apps/web/src/app/automacao/__tests__/automacao-page.test.tsx` | Created | Frontend render tests (10 test cases): page, config, buttons |

---

## Dependencies

- Story 4.1: Ingestion Mapping Templates (connector applies saved templates)
- Story 1.10: Data Ingestion Pipeline (ETL infrastructure)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Implementation: ErpConnector interface, 3 connectors (REST/DB/SFTP), factory, automation module, ETL integration, frontend config page, tests | Dex (Dev) |
| 2026-02-27 | 0.3 | QA fixes: credential masking on GET, @IsUrl for REST URL, SELECT-only SQL validation, @IsDateString for fetch date, fallback!=tipo validator, granularidade field, handleSave race fix | Dex (Dev) |
