# Story 4.4: Centralized Alert System

## Status

Done

## Executor Assignment

executor: "@dev"
quality_gate: "@qa"
quality_gate_tools: ["jest", "eslint", "tsc"]

## Story

**As a** production planner,
**I want** a centralized alert system that detects and notifies about stockouts, urgent purchases, capacity overloads, and forecast deviations,
**so that** I can respond quickly to critical supply chain events.

## References

- FR-062: Alert System
- [Source: architecture/9-integration-patterns.md#9.4 — Webhook Patterns for Notifications]

## Acceptance Criteria

### Alert Engine (FR-062)
- [x] AC-1: Centralized `NotificacaoService` that creates, persists, and dispatches alerts
- [x] AC-2: Alert types: STOCKOUT, URGENT_PURCHASE, CAPACITY_OVERLOAD, FORECAST_DEVIATION, STORAGE_FULL, PIPELINE_FAILURE
- [x] AC-3: Alert severities: CRITICAL, HIGH, MEDIUM, LOW, INFO
- [x] AC-4: Each alert has: type, severity, title, message, entityId (optional), entityType, metadata (JSON), createdAt, acknowledgedAt, acknowledgedBy

### Alert Detection
- [x] AC-5: STOCKOUT: triggered when projected stock < 0 for any SKU within 2 weeks
- [x] AC-6: URGENT_PURCHASE: triggered when planned orders have release date within 7 days
- [x] AC-7: CAPACITY_OVERLOAD: triggered when work center utilization > 110%
- [x] AC-8: FORECAST_DEVIATION: triggered when actual vs forecast MAPE > threshold (configurable, default 30%)
- [x] AC-9: STORAGE_FULL: triggered when warehouse occupancy > 90%
- [x] AC-10: PIPELINE_FAILURE: triggered when any pipeline step fails

### Real-time Delivery
- [x] AC-11: Alerts published via in-memory pub/sub + SSE stream for real-time delivery
- [x] AC-12: SSE endpoint pushes new alerts to connected frontend clients (SSE instead of WebSocket for simplicity)
- [x] AC-13: Frontend shows toast notification on new alert + badge count update

### Alert Management
- [x] AC-14: `GET /alerts` — list alerts with filters (type, severity, acknowledged, date range)
- [x] AC-15: `PATCH /alerts/:id/acknowledge` — mark alert as acknowledged by current user
- [x] AC-16: `GET /alerts/summary` — count by type and severity for dashboard badges

### Frontend
- [x] AC-17: Alert bell icon in topbar with unacknowledged count badge
- [x] AC-18: Alert dropdown/panel showing recent unacknowledged alerts
- [x] AC-19: Full alert history page with filters and pagination

### Testing
- [x] AC-20: Backend unit tests for alert detection rules and NotificacaoService (80%+ coverage)
- [x] AC-21: Frontend render tests for alert components

## Dev Notes

### Notification Flow

```
Event Source (any module)
  → NotificacaoService.create({ type, severity, message, entityId })
    → PostgreSQL (persist alert)
    → Redis pub/sub (real-time channel)
      → WebSocket Gateway (push to connected clients)
        → Frontend (toast + badge update)
```

### Database Schema

```sql
CREATE TABLE notificacao (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tipo VARCHAR(30) NOT NULL,
  severidade VARCHAR(10) NOT NULL,
  titulo VARCHAR(200) NOT NULL,
  mensagem TEXT NOT NULL,
  entity_id UUID,
  entity_type VARCHAR(50),
  metadata JSONB DEFAULT '{}',
  acknowledged_at TIMESTAMPTZ,
  acknowledged_by UUID REFERENCES usuario(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### File Locations

**Backend:**
- `apps/api/src/modules/notifications/` — module, service, controller, gateway
- `apps/api/src/modules/notifications/detectors/` — alert detection rules
- `apps/api/prisma/` — migration for notificacao table

**Frontend:**
- `apps/web/src/components/notifications/` — bell icon, dropdown, toast
- `apps/web/src/app/alertas/page.tsx` — full alert history

---

## Tasks / Subtasks

- [x] **Task 1: Create notificacao Prisma model and migration** (AC: 4)
- [x] **Task 2: Implement NotificacaoService with CRUD** (AC: 1, 14, 15, 16)
- [x] **Task 3: Implement alert detection rules** (AC: 5-10)
- [x] **Task 4: Add SSE real-time delivery** (AC: 11) — used SSE instead of Redis pub/sub
- [x] **Task 5: Create SSE endpoint for real-time alerts** (AC: 12) — SSE instead of WebSocket
- [x] **Task 6: Implement frontend alert bell and dropdown** (AC: 13, 17, 18)
- [x] **Task 7: Implement full alert history page** (AC: 19)
- [x] **Task 8: Write backend unit tests** (AC: 20)
- [x] **Task 9: Write frontend render tests** (AC: 21)

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `apps/api/prisma/schema.prisma` | Modified | Added TipoAlerta, SeveridadeAlerta enums + Notificacao model + Usuario relation |
| `apps/api/prisma/migrations/20260227020000_add_notificacao_table/migration.sql` | Created | Migration SQL for notificacao table, enums, indexes, FK |
| `apps/api/package.json` | Modified | Added @nestjs/schedule dependency |
| `apps/api/src/app.module.ts` | Modified | Registered NotificationsModule + ScheduleModule.forRoot() |
| `apps/api/src/modules/notifications/notification.types.ts` | Created | AlertType, AlertSeverity, CreateAlertDto, AlertSummary interfaces |
| `apps/api/src/modules/notifications/dto/alert-query.dto.ts` | Created | AlertQueryDto with class-validator decorators |
| `apps/api/src/modules/notifications/notificacao.service.ts` | Created | CRUD service with in-memory pub/sub |
| `apps/api/src/modules/notifications/notificacao.controller.ts` | Created | REST endpoints + SSE stream |
| `apps/api/src/modules/notifications/detectors/alert-detector.service.ts` | Created | 6 detection rules with cron + deduplication |
| `apps/api/src/modules/notifications/notifications.module.ts` | Created | Module definition |
| `apps/api/src/modules/notifications/notificacao.service.spec.ts` | Created | Service unit tests (14 tests) |
| `apps/api/src/modules/notifications/notificacao.controller.spec.ts` | Created | Controller unit tests (5 tests) |
| `apps/api/src/modules/notifications/detectors/alert-detector.service.spec.ts` | Created | Detector unit tests (12 tests) |
| `apps/web/src/types/notifications.ts` | Created | Frontend alert types + labels + severity colors |
| `apps/web/src/hooks/use-notifications.ts` | Created | React Query hooks (useAlerts, useAlertSummary, useAcknowledgeAlert, useAlertStream) |
| `apps/web/src/components/notifications/alert-bell.tsx` | Created | Bell icon with badge + toast |
| `apps/web/src/components/notifications/alert-dropdown.tsx` | Created | Dropdown panel with recent alerts |
| `apps/web/src/app/alertas/page.tsx` | Created | Full alert history page with filters + pagination |
| `apps/web/src/components/notifications/__tests__/alert-bell.test.tsx` | Created | AlertBell render tests (7 tests) |
| `apps/web/src/app/alertas/__tests__/alertas-page.test.tsx` | Created | AlertasPage render tests (9 tests) |

---

## Dependencies

- Story 2.8: BullMQ & WebSocket Gateway (Redis pub/sub infrastructure)
- Story 3.9: CRP & Storage Capacity Validation (overload/storage alerts use existing data)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-27 | 0.1 | Story created for Epic 4 — Automation & BI | River (SM) |
| 2026-02-27 | 0.2 | Schema, types, DTOs, service created | Dex (Dev) |
| 2026-02-27 | 0.3 | Controller, detectors, SSE, module, frontend, tests — all 21 ACs implemented | Dex (Dev) |
| 2026-02-27 | 0.4 | Code review fixes: JWT userId, Subject complete, threshold validation, stockout query, Set subscribers | Dex (Dev) |
| 2026-02-27 | 0.5 | QA gate fixes: migration SQL, NotFoundException, UuidValidationPipe, error states, ScheduleModule at root | Dex (Dev) |
